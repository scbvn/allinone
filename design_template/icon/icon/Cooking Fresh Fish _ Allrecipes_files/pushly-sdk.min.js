/*! For license information please see pushly-sdk.min.js.LICENSE */
!function(e){var t={};function __webpack_require__(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,__webpack_require__),n.l=!0,n.exports}__webpack_require__.m=e,__webpack_require__.c=t,__webpack_require__.d=function(e,t,r){__webpack_require__.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},__webpack_require__.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},__webpack_require__.t=function(e,t){if(1&t&&(e=__webpack_require__(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(__webpack_require__.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)__webpack_require__.d(r,n,function(t){return e[t]}.bind(null,n));return r},__webpack_require__.n=function(e){var t=e&&e.__esModule?function getDefault(){return e.default}:function getModuleExports(){return e};return __webpack_require__.d(t,"a",t),t},__webpack_require__.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s="./src/web.ts")}({"./node_modules/@firebase/app/dist/index.cjs.js":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./node_modules/@firebase/util/dist/index.cjs.js"),i=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o="[DEFAULT]",s=[],a=function(){function FirebaseAppImpl(e,t,r){this.firebase_=r,this.isDeleted_=!1,this.services_={},this.name_=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled||!1,this.options_=n.deepCopy(e),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(e){s.push(e),setTimeout(function(){return e(null)},0)},removeAuthTokenListener:function(e){s=s.filter(function(t){return t!==e})}}}return Object.defineProperty(FirebaseAppImpl.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this._automaticDataCollectionEnabled},set:function(e){this.checkDestroyed_(),this._automaticDataCollectionEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseAppImpl.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(FirebaseAppImpl.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),FirebaseAppImpl.prototype.delete=function(){var e=this;return new Promise(function(t){e.checkDestroyed_(),t()}).then(function(){e.firebase_.INTERNAL.removeApp(e.name_);var t=[];return Object.keys(e.services_).forEach(function(r){Object.keys(e.services_[r]).forEach(function(n){t.push(e.services_[r][n])})}),Promise.all(t.map(function(e){return e.INTERNAL.delete()}))}).then(function(){e.isDeleted_=!0,e.services_={}})},FirebaseAppImpl.prototype._getService=function(e,t){if(void 0===t&&(t=o),this.checkDestroyed_(),this.services_[e]||(this.services_[e]={}),!this.services_[e][t]){var r=t!==o?t:void 0,n=this.firebase_.INTERNAL.factories[e](this,this.extendApp.bind(this),r);this.services_[e][t]=n}return this.services_[e][t]},FirebaseAppImpl.prototype.extendApp=function(e){var t=this;n.deepExtend(this,e),e.INTERNAL&&e.INTERNAL.addAuthTokenListener&&(s.forEach(function(e){t.INTERNAL.addAuthTokenListener(e)}),s=[])},FirebaseAppImpl.prototype.checkDestroyed_=function(){this.isDeleted_&&error("app-deleted",{name:this.name_})},FirebaseAppImpl}();function error(e,t){throw c.create(e,t)}a.prototype.name&&a.prototype.options||a.prototype.delete||console.log("dc");var c=new n.ErrorFactory("app","Firebase",{"no-app":"No Firebase App '{$name}' has been created - call Firebase App.initializeApp()","bad-app-name":"Illegal App name: '{$name}","duplicate-app":"Firebase App named '{$name}' already exists","app-deleted":"Firebase App named '{$name}' already deleted","duplicate-service":"Firebase service named '{$name}' already registered","sa-not-supported":"Initializing the Firebase SDK with a service account is only allowed in a Node.js environment. On client devices, you should instead initialize the SDK with an api key and auth domain","invalid-app-argument":"firebase.{$name}() takes either no argument or a Firebase App instance."}),u=function createFirebaseNamespace(){var e={},t={},r={},s={__esModule:!0,initializeApp:function initializeApp(t,r){if(void 0===r&&(r={}),"object"!=typeof r||null===r){var n=r;r={name:n}}var c=r;void 0===c.name&&(c.name=o);var u=c.name;"string"==typeof u&&u||error("bad-app-name",{name:u+""}),i(e,u)&&error("duplicate-app",{name:u});var l=new a(t,c,s);return e[u]=l,callAppHooks(l,"create"),l},app:app,apps:null,Promise:Promise,SDK_VERSION:"5.0.4",INTERNAL:{registerService:function registerService(e,i,o,c,u){t[e]&&error("duplicate-service",{name:e}),t[e]=i,c&&(r[e]=c,getApps().forEach(function(e){c("create",e)}));var l=function(t){return void 0===t&&(t=app()),"function"!=typeof t[e]&&error("invalid-app-argument",{name:e}),t[e]()};return void 0!==o&&n.deepExtend(l,o),s[e]=l,a.prototype[e]=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return this._getService.bind(this,e).apply(this,u?t:[])},l},createFirebaseNamespace:createFirebaseNamespace,extendNamespace:function extendNamespace(e){n.deepExtend(s,e)},createSubscribe:n.createSubscribe,ErrorFactory:n.ErrorFactory,removeApp:function removeApp(t){callAppHooks(e[t],"delete"),delete e[t]},factories:t,useAsService:useAsService,Promise:Promise,deepExtend:n.deepExtend}};function app(t){return i(e,t=t||o)||error("no-app",{name:t}),e[t]}function getApps(){return Object.keys(e).map(function(t){return e[t]})}function callAppHooks(e,n){Object.keys(t).forEach(function(t){var i=useAsService(e,t);null!==i&&r[i]&&r[i](n,e)})}function useAsService(e,t){if("serverAuth"===t)return null;var r=t;return e.options,r}return n.patchProperty(s,"default",s),Object.defineProperty(s,"apps",{get:getApps}),n.patchProperty(app,"App",a),s}();t.firebase=u,t.default=u},"./node_modules/@firebase/messaging/dist/index.esm.js":function(e,t,r){"use strict";r.r(t),r.d(t,"registerMessaging",function(){return registerMessaging}),r.d(t,"isSupported",function(){return isSupported});var n,i,o,s=r("./node_modules/@firebase/util/dist/index.cjs.js"),a=r("./node_modules/tslib/tslib.es6.js"),c=r("./node_modules/@firebase/app/dist/index.cjs.js"),u=r.n(c),l={AVAILABLE_IN_WINDOW:"only-available-in-window",AVAILABLE_IN_SW:"only-available-in-sw",SHOULD_BE_INHERITED:"should-be-overriden",BAD_SENDER_ID:"bad-sender-id",INCORRECT_GCM_SENDER_ID:"incorrect-gcm-sender-id",PERMISSION_DEFAULT:"permission-default",PERMISSION_BLOCKED:"permission-blocked",UNSUPPORTED_BROWSER:"unsupported-browser",NOTIFICATIONS_BLOCKED:"notifications-blocked",FAILED_DEFAULT_REGISTRATION:"failed-serviceworker-registration",SW_REGISTRATION_EXPECTED:"sw-registration-expected",GET_SUBSCRIPTION_FAILED:"get-subscription-failed",INVALID_SAVED_TOKEN:"invalid-saved-token",SW_REG_REDUNDANT:"sw-reg-redundant",TOKEN_SUBSCRIBE_FAILED:"token-subscribe-failed",TOKEN_SUBSCRIBE_NO_TOKEN:"token-subscribe-no-token",TOKEN_SUBSCRIBE_NO_PUSH_SET:"token-subscribe-no-push-set",TOKEN_UNSUBSCRIBE_FAILED:"token-unsubscribe-failed",TOKEN_UPDATE_FAILED:"token-update-failed",TOKEN_UPDATE_NO_TOKEN:"token-update-no-token",USE_SW_BEFORE_GET_TOKEN:"use-sw-before-get-token",INVALID_DELETE_TOKEN:"invalid-delete-token",DELETE_TOKEN_NOT_FOUND:"delete-token-not-found",DELETE_SCOPE_NOT_FOUND:"delete-scope-not-found",BG_HANDLER_FUNCTION_EXPECTED:"bg-handler-function-expected",NO_WINDOW_CLIENT_TO_MSG:"no-window-client-to-msg",UNABLE_TO_RESUBSCRIBE:"unable-to-resubscribe",NO_FCM_TOKEN_FOR_RESUBSCRIBE:"no-fcm-token-for-resubscribe",FAILED_TO_DELETE_TOKEN:"failed-to-delete-token",NO_SW_IN_REG:"no-sw-in-reg",BAD_SCOPE:"bad-scope",BAD_VAPID_KEY:"bad-vapid-key",BAD_SUBSCRIPTION:"bad-subscription",BAD_TOKEN:"bad-token",BAD_PUSH_SET:"bad-push-set",FAILED_DELETE_VAPID_KEY:"failed-delete-vapid-key",INVALID_PUBLIC_VAPID_KEY:"invalid-public-vapid-key",USE_PUBLIC_KEY_BEFORE_GET_TOKEN:"use-public-key-before-get-token",PUBLIC_KEY_DECRYPTION_FAILED:"public-vapid-key-decryption-failed"},p=((n={})[l.AVAILABLE_IN_WINDOW]="This method is available in a Window context.",n[l.AVAILABLE_IN_SW]="This method is available in a service worker context.",n[l.SHOULD_BE_INHERITED]="This method should be overriden by extended classes.",n[l.BAD_SENDER_ID]="Please ensure that 'messagingSenderId' is set correctly in the options passed into firebase.initializeApp().",n[l.PERMISSION_DEFAULT]="The required permissions were not granted and dismissed instead.",n[l.PERMISSION_BLOCKED]="The required permissions were not granted and blocked instead.",n[l.UNSUPPORTED_BROWSER]="This browser doesn't support the API's required to use the firebase SDK.",n[l.NOTIFICATIONS_BLOCKED]="Notifications have been blocked.",n[l.FAILED_DEFAULT_REGISTRATION]="We are unable to register the default service worker. {$browserErrorMessage}",n[l.SW_REGISTRATION_EXPECTED]="A service worker registration was the expected input.",n[l.GET_SUBSCRIPTION_FAILED]="There was an error when trying to get any existing Push Subscriptions.",n[l.INVALID_SAVED_TOKEN]="Unable to access details of the saved token.",n[l.SW_REG_REDUNDANT]="The service worker being used for push was made redundant.",n[l.TOKEN_SUBSCRIBE_FAILED]="A problem occured while subscribing the user to FCM: {$message}",n[l.TOKEN_SUBSCRIBE_NO_TOKEN]="FCM returned no token when subscribing the user to push.",n[l.TOKEN_SUBSCRIBE_NO_PUSH_SET]="FCM returned an invalid response when getting an FCM token.",n[l.TOKEN_UNSUBSCRIBE_FAILED]="A problem occured while unsubscribing the user from FCM: {$message}",n[l.TOKEN_UPDATE_FAILED]="A problem occured while updating the user from FCM: {$message}",n[l.TOKEN_UPDATE_NO_TOKEN]="FCM returned no token when updating the user to push.",n[l.USE_SW_BEFORE_GET_TOKEN]="The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used.",n[l.INVALID_DELETE_TOKEN]="You must pass a valid token into deleteToken(), i.e. the token from getToken().",n[l.DELETE_TOKEN_NOT_FOUND]="The deletion attempt for token could not be performed as the token was not found.",n[l.DELETE_SCOPE_NOT_FOUND]="The deletion attempt for service worker scope could not be performed as the scope was not found.",n[l.BG_HANDLER_FUNCTION_EXPECTED]="The input to setBackgroundMessageHandler() must be a function.",n[l.NO_WINDOW_CLIENT_TO_MSG]="An attempt was made to message a non-existant window client.",n[l.UNABLE_TO_RESUBSCRIBE]="There was an error while re-subscribing the FCM token for push messaging. Will have to resubscribe the user on next visit. {$message}",n[l.NO_FCM_TOKEN_FOR_RESUBSCRIBE]="Could not find an FCM token and as a result, unable to resubscribe. Will have to resubscribe the user on next visit.",n[l.FAILED_TO_DELETE_TOKEN]="Unable to delete the currently saved token.",n[l.NO_SW_IN_REG]="Even though the service worker registration was successful, there was a problem accessing the service worker itself.",n[l.INCORRECT_GCM_SENDER_ID]="Please change your web app manifest's 'gcm_sender_id' value to '103953800507' to use Firebase messaging.",n[l.BAD_SCOPE]="The service worker scope must be a string with at least one character.",n[l.BAD_VAPID_KEY]="The public VAPID key is not a Uint8Array with 65 bytes.",n[l.BAD_SUBSCRIPTION]="The subscription must be a valid PushSubscription.",n[l.BAD_TOKEN]="The FCM Token used for storage / lookup was not a valid token string.",n[l.BAD_PUSH_SET]="The FCM push set used for storage / lookup was not not a valid push set string.",n[l.FAILED_DELETE_VAPID_KEY]="The VAPID key could not be deleted.",n[l.INVALID_PUBLIC_VAPID_KEY]="The public VAPID key must be a string.",n[l.PUBLIC_KEY_DECRYPTION_FAILED]="The public VAPID key did not equal 65 bytes when decrypted.",n),d=new s.ErrorFactory("messaging","Messaging",p),f=new Uint8Array([4,51,148,247,223,161,235,177,220,3,162,94,21,113,219,72,211,46,237,237,178,52,219,183,71,58,12,143,196,204,225,111,60,140,132,223,171,182,102,62,242,12,212,139,254,227,249,118,47,20,28,99,8,106,111,45,177,26,149,176,206,55,192,156,110]),h="https://fcm.googleapis.com";function isArrayBufferEqual(e,t){if(null==e||null==t)return!1;if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var r=new DataView(e),n=new DataView(t),i=0;i<e.byteLength;i++)if(r.getUint8(i)!==n.getUint8(i))return!1;return!0}function arrayBufferToBase64(e){return function toBase64(e){var t=new Uint8Array(e);return btoa(String.fromCharCode.apply(null,t))}(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}!function(e){e.TYPE_OF_MSG="firebase-messaging-msg-type",e.DATA="firebase-messaging-msg-data"}(i||(i={})),function(e){e.PUSH_MSG_RECEIVED="push-msg-received",e.NOTIFICATION_CLICKED="notification-clicked"}(o||(o={}));var v=function(){function IidModel(){}return IidModel.prototype.getToken=function(e,t,r){return Object(a.__awaiter)(this,void 0,void 0,function(){var n,i,o,s,c,u,p,v;return Object(a.__generator)(this,function(a){switch(a.label){case 0:n=arrayBufferToBase64(t.getKey("p256dh")),i=arrayBufferToBase64(t.getKey("auth")),o="authorized_entity="+e+"&endpoint="+t.endpoint+"&encryption_key="+n+"&encryption_auth="+i,isArrayBufferEqual(r.buffer,f.buffer)||(s=arrayBufferToBase64(r),o+="&application_pub_key="+s),(c=new Headers).append("Content-Type","application/x-www-form-urlencoded"),u={method:"POST",headers:c,body:o},a.label=1;case 1:return a.trys.push([1,4,,5]),[4,fetch(h+"/fcm/connect/subscribe",u)];case 2:return[4,a.sent().json()];case 3:return p=a.sent(),[3,5];case 4:throw a.sent(),d.create(l.TOKEN_SUBSCRIBE_FAILED);case 5:if(p.error)throw v=p.error.message,d.create(l.TOKEN_SUBSCRIBE_FAILED,{message:v});if(!p.token)throw d.create(l.TOKEN_SUBSCRIBE_NO_TOKEN);if(!p.pushSet)throw d.create(l.TOKEN_SUBSCRIBE_NO_PUSH_SET);return[2,{token:p.token,pushSet:p.pushSet}]}})})},IidModel.prototype.updateToken=function(e,t,r,n,i){return Object(a.__awaiter)(this,void 0,void 0,function(){var o,s,c,u,p,v,_,g;return Object(a.__generator)(this,function(a){switch(a.label){case 0:o=arrayBufferToBase64(n.getKey("p256dh")),s=arrayBufferToBase64(n.getKey("auth")),c="push_set="+r+"&token="+t+"&authorized_entity="+e+"&endpoint="+n.endpoint+"&encryption_key="+o+"&encryption_auth="+s,isArrayBufferEqual(i.buffer,f.buffer)||(u=arrayBufferToBase64(i),c+="&application_pub_key="+u),(p=new Headers).append("Content-Type","application/x-www-form-urlencoded"),v={method:"POST",headers:p,body:c},a.label=1;case 1:return a.trys.push([1,4,,5]),[4,fetch(h+"/fcm/connect/subscribe",v)];case 2:return[4,a.sent().json()];case 3:return _=a.sent(),[3,5];case 4:throw a.sent(),d.create(l.TOKEN_UPDATE_FAILED);case 5:if(_.error)throw g=_.error.message,d.create(l.TOKEN_UPDATE_FAILED,{message:g});if(!_.token)throw d.create(l.TOKEN_UPDATE_NO_TOKEN);return[2,_.token]}})})},IidModel.prototype.deleteToken=function(e,t,r){return Object(a.__awaiter)(this,void 0,void 0,function(){var n,i,o,s,c;return Object(a.__generator)(this,function(a){switch(a.label){case 0:n="authorized_entity="+e+"&token="+t+"&pushSet="+r,(i=new Headers).append("Content-Type","application/x-www-form-urlencoded"),o={method:"POST",headers:i,body:n},a.label=1;case 1:return a.trys.push([1,4,,5]),[4,fetch(h+"/fcm/connect/unsubscribe",o)];case 2:return[4,a.sent().json()];case 3:if((s=a.sent()).error)throw c=s.error.message,d.create(l.TOKEN_UNSUBSCRIBE_FAILED,{message:c});return[3,5];case 4:throw a.sent(),d.create(l.TOKEN_UNSUBSCRIBE_FAILED);case 5:return[2]}})})},IidModel}();function base64ToArrayBuffer(e){for(var t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),r=atob(t),n=new Uint8Array(r.length),i=0;i<r.length;++i)n[i]=r.charCodeAt(i);return n}var _="undefined",g="fcm_token_object_Store";function cleanV1(){var e=indexedDB.open(_);e.onerror=function(e){},e.onsuccess=function(t){!function handleDb(e){if(e.objectStoreNames.contains(g)){var t=e.transaction(g).objectStore(g),r=new v,n=t.openCursor();n.onerror=function(e){console.warn("Unable to cleanup old IDB.",e)},n.onsuccess=function(){var t=n.result;if(t){var i=t.value;r.deleteToken(i.fcmSenderId,i.fcmToken,i.fcmPushSet),t.continue()}else e.close(),indexedDB.deleteDatabase(_)}}}(e.result)}}var m=function(){function DbInterface(){this.dbPromise=null}return DbInterface.prototype.get=function(e){return this.createTransaction(function(t){return t.get(e)})},DbInterface.prototype.getIndex=function(e,t){return this.createTransaction(function runRequest(r){return r.index(e).get(t)})},DbInterface.prototype.put=function(e){return this.createTransaction(function(t){return t.put(e)},"readwrite")},DbInterface.prototype.delete=function(e){return this.createTransaction(function(t){return t.delete(e)},"readwrite")},DbInterface.prototype.closeDatabase=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(e){switch(e.label){case 0:return this.dbPromise?[4,this.dbPromise]:[3,2];case 1:e.sent().close(),this.dbPromise=null,e.label=2;case 2:return[2]}})})},DbInterface.prototype.createTransaction=function(e,t){return void 0===t&&(t="readonly"),Object(a.__awaiter)(this,void 0,void 0,function(){var r,n,i,o;return Object(a.__generator)(this,function(s){switch(s.label){case 0:return[4,this.getDb()];case 1:return r=s.sent(),n=r.transaction(this.objectStoreName,t),i=n.objectStore(this.objectStoreName),[4,function promisify(e){return new Promise(function(t,r){e.onsuccess=function(){t(e.result)},e.onerror=function(){r(e.error)}})}(e(i))];case 2:return o=s.sent(),[2,new Promise(function(e,t){n.oncomplete=function(){e(o)},n.onerror=function(){t(n.error)}})]}})})},DbInterface.prototype.getDb=function(){var e=this;return this.dbPromise||(this.dbPromise=new Promise(function(t,r){var n=indexedDB.open(e.dbName,e.dbVersion);n.onsuccess=function(){t(n.result)},n.onerror=function(){e.dbPromise=null,r(n.error)},n.onupgradeneeded=function(t){return e.onDbUpgrade(n,t)}})),this.dbPromise},DbInterface}();var b=function(e){function TokenDetailsModel(){var t=null!==e&&e.apply(this,arguments)||this;return t.dbName="fcm_token_details_db",t.dbVersion=3,t.objectStoreName="fcm_token_object_Store",t}return Object(a.__extends)(TokenDetailsModel,e),TokenDetailsModel.prototype.onDbUpgrade=function(e,t){var r=e.result;switch(t.oldVersion){case 0:(n=r.createObjectStore(this.objectStoreName,{keyPath:"swScope"})).createIndex("fcmSenderId","fcmSenderId",{unique:!1}),n.createIndex("fcmToken","fcmToken",{unique:!0});case 1:cleanV1();case 2:var n,i=(n=e.transaction.objectStore(this.objectStoreName)).openCursor();i.onsuccess=function(){var e=i.result;if(e){var t=e.value,r=Object(a.__assign)({},t);t.createTime||(r.createTime=Date.now()),"string"==typeof t.vapidKey&&(r.vapidKey=base64ToArrayBuffer(t.vapidKey)),"string"==typeof t.auth&&(r.auth=base64ToArrayBuffer(t.auth).buffer),"string"==typeof t.auth&&(r.p256dh=base64ToArrayBuffer(t.p256dh).buffer),e.update(r),e.continue()}}}},TokenDetailsModel.prototype.getTokenDetailsFromToken=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(t){if(!e)throw d.create(l.BAD_TOKEN);return validateInputs({fcmToken:e}),[2,this.getIndex("fcmToken",e)]})})},TokenDetailsModel.prototype.getTokenDetailsFromSWScope=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(t){if(!e)throw d.create(l.BAD_SCOPE);return validateInputs({swScope:e}),[2,this.get(e)]})})},TokenDetailsModel.prototype.saveTokenDetails=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(t){if(!e.swScope)throw d.create(l.BAD_SCOPE);if(!e.vapidKey)throw d.create(l.BAD_VAPID_KEY);if(!e.endpoint||!e.auth||!e.p256dh)throw d.create(l.BAD_SUBSCRIPTION);if(!e.fcmSenderId)throw d.create(l.BAD_SENDER_ID);if(!e.fcmToken)throw d.create(l.BAD_TOKEN);if(!e.fcmPushSet)throw d.create(l.BAD_PUSH_SET);return validateInputs(e),[2,this.put(e)]})})},TokenDetailsModel.prototype.deleteToken=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t;return Object(a.__generator)(this,function(r){switch(r.label){case 0:return"string"!=typeof e||0===e.length?[2,Promise.reject(d.create(l.INVALID_DELETE_TOKEN))]:[4,this.getTokenDetailsFromToken(e)];case 1:if(!(t=r.sent()))throw d.create(l.DELETE_TOKEN_NOT_FOUND);return[4,this.delete(t.swScope)];case 2:return r.sent(),[2,t]}})})},TokenDetailsModel}(m);function validateInputs(e){if(e.fcmToken&&("string"!=typeof e.fcmToken||0===e.fcmToken.length))throw d.create(l.BAD_TOKEN);if(e.swScope&&("string"!=typeof e.swScope||0===e.swScope.length))throw d.create(l.BAD_SCOPE);if(e.vapidKey&&(!(e.vapidKey instanceof Uint8Array)||65!==e.vapidKey.length))throw d.create(l.BAD_VAPID_KEY);if(e.endpoint&&("string"!=typeof e.endpoint||0===e.endpoint.length))throw d.create(l.BAD_SUBSCRIPTION);if(e.auth&&!(e.auth instanceof ArrayBuffer))throw d.create(l.BAD_SUBSCRIPTION);if(e.p256dh&&!(e.p256dh instanceof ArrayBuffer))throw d.create(l.BAD_SUBSCRIPTION);if(e.fcmSenderId&&("string"!=typeof e.fcmSenderId||0===e.fcmSenderId.length))throw d.create(l.BAD_SENDER_ID);if(e.fcmPushSet&&("string"!=typeof e.fcmPushSet||0===e.fcmPushSet.length))throw d.create(l.BAD_PUSH_SET)}var y=function(e){function VapidDetailsModel(){var t=null!==e&&e.apply(this,arguments)||this;return t.dbName="fcm_vapid_details_db",t.dbVersion=1,t.objectStoreName="fcm_vapid_object_Store",t}return Object(a.__extends)(VapidDetailsModel,e),VapidDetailsModel.prototype.onDbUpgrade=function(e){e.result.createObjectStore(this.objectStoreName,{keyPath:"swScope"})},VapidDetailsModel.prototype.getVapidFromSWScope=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t;return Object(a.__generator)(this,function(r){switch(r.label){case 0:if("string"!=typeof e||0===e.length)throw d.create(l.BAD_SCOPE);return[4,this.get(e)];case 1:return[2,(t=r.sent())?t.vapidKey:void 0]}})})},VapidDetailsModel.prototype.saveVapidDetails=function(e,t){return Object(a.__awaiter)(this,void 0,void 0,function(){var r;return Object(a.__generator)(this,function(n){if("string"!=typeof e||0===e.length)throw d.create(l.BAD_SCOPE);if(null===t||65!==t.length)throw d.create(l.BAD_VAPID_KEY);return r={swScope:e,vapidKey:t},[2,this.put(r)]})})},VapidDetailsModel.prototype.deleteVapidDetails=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t;return Object(a.__generator)(this,function(r){switch(r.label){case 0:return[4,this.getVapidFromSWScope(e)];case 1:if(!(t=r.sent()))throw d.create(l.DELETE_SCOPE_NOT_FOUND);return[4,this.delete(e)];case 2:return r.sent(),[2,t]}})})},VapidDetailsModel}(m),S="messagingSenderId",w=function(){function BaseController(e){var t=this;if(!e.options[S]||"string"!=typeof e.options[S])throw d.create(l.BAD_SENDER_ID);this.messagingSenderId=e.options[S],this.tokenDetailsModel=new b,this.vapidDetailsModel=new y,this.iidModel=new v,this.app=e,this.INTERNAL={delete:function(){return t.delete()}}}return BaseController.prototype.getToken=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){var e,t,r,n,i;return Object(a.__generator)(this,function(o){switch(o.label){case 0:if("denied"===(e=this.getNotificationPermission_()))throw d.create(l.NOTIFICATIONS_BLOCKED);return"granted"!==e?[2,null]:[4,this.getSWRegistration_()];case 1:return t=o.sent(),[4,this.getPublicVapidKey_()];case 2:return r=o.sent(),[4,this.getPushSubscription(t,r)];case 3:return n=o.sent(),[4,this.tokenDetailsModel.getTokenDetailsFromSWScope(t.scope)];case 4:return(i=o.sent())?[2,this.manageExistingToken(t,n,r,i)]:[2,this.getNewToken(t,n,r)]}})})},BaseController.prototype.manageExistingToken=function(e,t,r,n){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(i){switch(i.label){case 0:return function isTokenStillValid(e,t,r){if(!r.vapidKey||!isArrayBufferEqual(t.buffer,r.vapidKey.buffer))return!1;var n=e.endpoint===r.endpoint,i=isArrayBufferEqual(e.getKey("auth"),r.auth),o=isArrayBufferEqual(e.getKey("p256dh"),r.p256dh);return n&&i&&o}(t,r,n)?Date.now()<n.createTime+6048e5?[2,n.fcmToken]:[2,this.updateToken(e,t,r,n)]:[4,this.deleteTokenFromDB(n.fcmToken)];case 1:return i.sent(),[2,this.getNewToken(e,t,r)]}})})},BaseController.prototype.updateToken=function(e,t,r,n){return Object(a.__awaiter)(this,void 0,void 0,function(){var i,o,s;return Object(a.__generator)(this,function(a){switch(a.label){case 0:return a.trys.push([0,4,,6]),[4,this.iidModel.updateToken(this.messagingSenderId,n.fcmToken,n.fcmPushSet,t,r)];case 1:return i=a.sent(),o={swScope:e.scope,vapidKey:r,fcmSenderId:this.messagingSenderId,fcmToken:i,fcmPushSet:n.fcmPushSet,createTime:Date.now(),endpoint:t.endpoint,auth:t.getKey("auth"),p256dh:t.getKey("p256dh")},[4,this.tokenDetailsModel.saveTokenDetails(o)];case 2:return a.sent(),[4,this.vapidDetailsModel.saveVapidDetails(e.scope,r)];case 3:return a.sent(),[2,i];case 4:return s=a.sent(),[4,this.deleteToken(n.fcmToken)];case 5:throw a.sent(),s;case 6:return[2]}})})},BaseController.prototype.getNewToken=function(e,t,r){return Object(a.__awaiter)(this,void 0,void 0,function(){var n,i;return Object(a.__generator)(this,function(o){switch(o.label){case 0:return[4,this.iidModel.getToken(this.messagingSenderId,t,r)];case 1:return n=o.sent(),i={swScope:e.scope,vapidKey:r,fcmSenderId:this.messagingSenderId,fcmToken:n.token,fcmPushSet:n.pushSet,createTime:Date.now(),endpoint:t.endpoint,auth:t.getKey("auth"),p256dh:t.getKey("p256dh")},[4,this.tokenDetailsModel.saveTokenDetails(i)];case 2:return o.sent(),[4,this.vapidDetailsModel.saveVapidDetails(e.scope,r)];case 3:return o.sent(),[2,n.token]}})})},BaseController.prototype.deleteToken=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t,r;return Object(a.__generator)(this,function(n){switch(n.label){case 0:return[4,this.deleteTokenFromDB(e)];case 1:return n.sent(),[4,this.getSWRegistration_()];case 2:return(t=n.sent())?[4,t.pushManager.getSubscription()]:[3,4];case 3:if(r=n.sent())return[2,r.unsubscribe()];n.label=4;case 4:return[2,!0]}})})},BaseController.prototype.deleteTokenFromDB=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t;return Object(a.__generator)(this,function(r){switch(r.label){case 0:return[4,this.tokenDetailsModel.deleteToken(e)];case 1:return t=r.sent(),[4,this.iidModel.deleteToken(t.fcmSenderId,t.fcmToken,t.fcmPushSet)];case 2:return r.sent(),[2]}})})},BaseController.prototype.getPushSubscription=function(e,t){return e.pushManager.getSubscription().then(function(r){return r||e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t})})},BaseController.prototype.requestPermission=function(){throw d.create(l.AVAILABLE_IN_WINDOW)},BaseController.prototype.useServiceWorker=function(e){throw d.create(l.AVAILABLE_IN_WINDOW)},BaseController.prototype.usePublicVapidKey=function(e){throw d.create(l.AVAILABLE_IN_WINDOW)},BaseController.prototype.onMessage=function(e,t,r){throw d.create(l.AVAILABLE_IN_WINDOW)},BaseController.prototype.onTokenRefresh=function(e,t,r){throw d.create(l.AVAILABLE_IN_WINDOW)},BaseController.prototype.setBackgroundMessageHandler=function(e){throw d.create(l.AVAILABLE_IN_SW)},BaseController.prototype.delete=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(e){switch(e.label){case 0:return[4,Promise.all([this.tokenDetailsModel.closeDatabase(),this.vapidDetailsModel.closeDatabase()])];case 1:return e.sent(),[2]}})})},BaseController.prototype.getNotificationPermission_=function(){return Notification.permission},BaseController.prototype.getTokenDetailsModel=function(){return this.tokenDetailsModel},BaseController.prototype.getVapidDetailsModel=function(){return this.vapidDetailsModel},BaseController.prototype.getIidModel=function(){return this.iidModel},BaseController}();var E=function(e){function SwController(t){var r=e.call(this,t)||this;return r.bgMessageHandler=null,self.addEventListener("push",function(e){r.onPush(e)}),self.addEventListener("pushsubscriptionchange",function(e){r.onSubChange(e)}),self.addEventListener("notificationclick",function(e){r.onNotificationClick(e)}),r}return Object(a.__extends)(SwController,e),SwController.prototype.onPush=function(e){e.waitUntil(this.onPush_(e))},SwController.prototype.onSubChange=function(e){e.waitUntil(this.onSubChange_(e))},SwController.prototype.onNotificationClick=function(e){e.waitUntil(this.onNotificationClick_(e))},SwController.prototype.onPush_=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t,r,n,i,o,s;return Object(a.__generator)(this,function(a){switch(a.label){case 0:if(!e.data)return[2];try{t=e.data.json()}catch(e){return[2]}return[4,this.hasVisibleClients_()];case 1:return a.sent()?[2,this.sendMessageToWindowClients_(t)]:(r=this.getNotificationData_(t))?(n=r.title||"",[4,this.getSWRegistration_()]):[3,3];case 2:return i=a.sent(),o=r.actions,s=Notification.maxActions,o&&s&&o.length>s&&console.warn("This browser only supports "+s+" actions.The remaining actions will not be displayed."),[2,i.showNotification(n,r)];case 3:return this.bgMessageHandler?[4,this.bgMessageHandler(t)]:[3,5];case 4:return a.sent(),[2];case 5:return[2]}})})},SwController.prototype.onSubChange_=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var e,t,r,n;return Object(a.__generator)(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.getSWRegistration_()];case 1:return e=i.sent(),[3,3];case 2:throw t=i.sent(),d.create(l.UNABLE_TO_RESUBSCRIBE,{message:t});case 3:return i.trys.push([3,5,,8]),[4,e.pushManager.getSubscription()];case 4:return i.sent(),[3,8];case 5:return r=i.sent(),[4,this.getTokenDetailsModel().getTokenDetailsFromSWScope(e.scope)];case 6:if(!(n=i.sent()))throw r;return[4,this.deleteToken(n.fcmToken)];case 7:throw i.sent(),r;case 8:return[2]}})})},SwController.prototype.onNotificationClick_=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t,r,n,i;return Object(a.__generator)(this,function(s){switch(s.label){case 0:return e.notification&&e.notification.data&&e.notification.data.FCM_MSG?e.action?[2]:(e.stopImmediatePropagation(),e.notification.close(),(t=e.notification.data.FCM_MSG).notification&&(r=t.fcmOptions&&t.fcmOptions.link||t.notification.click_action)?[4,this.getWindowClient_(r)]:[2]):[2];case 1:return(n=s.sent())?[3,3]:[4,self.clients.openWindow(r)];case 2:return n=s.sent(),[3,5];case 3:return[4,n.focus()];case 4:n=s.sent(),s.label=5;case 5:return n?(delete t.notification,delete t.fcmOptions,i=createNewMsg(o.NOTIFICATION_CLICKED,t),[2,this.attemptToMessageClient_(n,i)]):[2]}})})},SwController.prototype.getNotificationData_=function(e){if(e&&"object"==typeof e.notification){var t,r=Object(a.__assign)({},e.notification);return r.data=Object(a.__assign)({},e.notification.data,((t={}).FCM_MSG=e,t)),r}},SwController.prototype.setBackgroundMessageHandler=function(e){if(!e||"function"!=typeof e)throw d.create(l.BG_HANDLER_FUNCTION_EXPECTED);this.bgMessageHandler=e},SwController.prototype.getWindowClient_=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t,r,n,i;return Object(a.__generator)(this,function(o){switch(o.label){case 0:return t=new URL(e,self.location.href).href,[4,getClientList()];case 1:for(r=o.sent(),n=null,i=0;i<r.length;i++)if(new URL(r[i].url,self.location.href).href===t){n=r[i];break}return[2,n]}})})},SwController.prototype.attemptToMessageClient_=function(e,t){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(r){if(!e)throw d.create(l.NO_WINDOW_CLIENT_TO_MSG);return e.postMessage(t),[2]})})},SwController.prototype.hasVisibleClients_=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(e){switch(e.label){case 0:return[4,getClientList()];case 1:return[2,e.sent().some(function(e){return"visible"===e.visibilityState})]}})})},SwController.prototype.sendMessageToWindowClients_=function(e){return Object(a.__awaiter)(this,void 0,void 0,function(){var t,r,n=this;return Object(a.__generator)(this,function(i){switch(i.label){case 0:return[4,getClientList()];case 1:return t=i.sent(),r=createNewMsg(o.PUSH_MSG_RECEIVED,e),[4,Promise.all(t.map(function(e){return n.attemptToMessageClient_(e,r)}))];case 2:return i.sent(),[2]}})})},SwController.prototype.getSWRegistration_=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(e){return[2,self.registration]})})},SwController.prototype.getPublicVapidKey_=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){var e,t;return Object(a.__generator)(this,function(r){switch(r.label){case 0:return[4,this.getSWRegistration_()];case 1:if(!(e=r.sent()))throw d.create(l.SW_REGISTRATION_EXPECTED);return[4,this.getVapidDetailsModel().getVapidFromSWScope(e.scope)];case 2:return null==(t=r.sent())?[2,f]:[2,t]}})})},SwController}(w);function getClientList(){return self.clients.matchAll({type:"window",includeUncontrolled:!0})}function createNewMsg(e,t){return(r={})[i.TYPE_OF_MSG]=e,r[i.DATA]=t,r;var r}var k=function(e){function WindowController(t){var r=e.call(this,t)||this;return r.registrationToUse=null,r.publicVapidKeyToUse=null,r.manifestCheckPromise=null,r.messageObserver=null,r.tokenRefreshObserver=null,r.onMessageInternal=Object(s.createSubscribe)(function(e){r.messageObserver=e}),r.onTokenRefreshInternal=Object(s.createSubscribe)(function(e){r.tokenRefreshObserver=e}),r.setupSWMessageListener_(),r}return Object(a.__extends)(WindowController,e),WindowController.prototype.getToken=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(t){switch(t.label){case 0:return this.manifestCheckPromise||(this.manifestCheckPromise=function manifestCheck(){return Object(a.__awaiter)(this,void 0,void 0,function(){var e,t;return Object(a.__generator)(this,function(r){switch(r.label){case 0:if(!(e=document.querySelector('link[rel="manifest"]')))return[2];r.label=1;case 1:return r.trys.push([1,4,,5]),[4,fetch(e.href)];case 2:return[4,r.sent().json()];case 3:return t=r.sent(),[3,5];case 4:return r.sent(),[2];case 5:if(!t||!t.gcm_sender_id)return[2];if("103953800507"!==t.gcm_sender_id)throw d.create(l.INCORRECT_GCM_SENDER_ID);return[2]}})})}()),[4,this.manifestCheckPromise];case 1:return t.sent(),[2,e.prototype.getToken.call(this)]}})})},WindowController.prototype.requestPermission=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){var e;return Object(a.__generator)(this,function(t){switch(t.label){case 0:return"granted"===this.getNotificationPermission_()?[2]:[4,Notification.requestPermission()];case 1:if("granted"===(e=t.sent()))return[2];throw"denied"===e?d.create(l.PERMISSION_BLOCKED):d.create(l.PERMISSION_DEFAULT)}})})},WindowController.prototype.useServiceWorker=function(e){if(!(e instanceof ServiceWorkerRegistration))throw d.create(l.SW_REGISTRATION_EXPECTED);if(null!=this.registrationToUse)throw d.create(l.USE_SW_BEFORE_GET_TOKEN);this.registrationToUse=e},WindowController.prototype.usePublicVapidKey=function(e){if("string"!=typeof e)throw d.create(l.INVALID_PUBLIC_VAPID_KEY);if(null!=this.publicVapidKeyToUse)throw d.create(l.USE_PUBLIC_KEY_BEFORE_GET_TOKEN);var t=base64ToArrayBuffer(e);if(65!==t.length)throw d.create(l.PUBLIC_KEY_DECRYPTION_FAILED);this.publicVapidKeyToUse=t},WindowController.prototype.onMessage=function(e,t,r){return"function"==typeof e?this.onMessageInternal(e,t,r):this.onMessageInternal(e)},WindowController.prototype.onTokenRefresh=function(e,t,r){return"function"==typeof e?this.onTokenRefreshInternal(e,t,r):this.onTokenRefreshInternal(e)},WindowController.prototype.waitForRegistrationToActivate_=function(e){var t=e.installing||e.waiting||e.active;return new Promise(function(r,n){if(t)if("activated"!==t.state)if("redundant"!==t.state){var i=function(){if("activated"===t.state)r(e);else{if("redundant"!==t.state)return;n(d.create(l.SW_REG_REDUNDANT))}t.removeEventListener("statechange",i)};t.addEventListener("statechange",i)}else n(d.create(l.SW_REG_REDUNDANT));else r(e);else n(d.create(l.NO_SW_IN_REG))})},WindowController.prototype.getSWRegistration_=function(){var e=this;return this.registrationToUse?this.waitForRegistrationToActivate_(this.registrationToUse):(this.registrationToUse=null,navigator.serviceWorker.register("/firebase-messaging-sw.js",{scope:"/firebase-cloud-messaging-push-scope"}).catch(function(e){throw d.create(l.FAILED_DEFAULT_REGISTRATION,{browserErrorMessage:e.message})}).then(function(t){return e.waitForRegistrationToActivate_(t).then(function(){return e.registrationToUse=t,t.update(),t})}))},WindowController.prototype.getPublicVapidKey_=function(){return Object(a.__awaiter)(this,void 0,void 0,function(){return Object(a.__generator)(this,function(e){return this.publicVapidKeyToUse?[2,this.publicVapidKeyToUse]:[2,f]})})},WindowController.prototype.setupSWMessageListener_=function(){var e=this;navigator.serviceWorker.addEventListener("message",function(t){if(t.data&&t.data[i.TYPE_OF_MSG]){var r=t.data;switch(r[i.TYPE_OF_MSG]){case o.PUSH_MSG_RECEIVED:case o.NOTIFICATION_CLICKED:var n=r[i.DATA];e.messageObserver&&e.messageObserver.next(n)}}},!1)},WindowController}(w);function registerMessaging(e){var t={isSupported:isSupported};e.INTERNAL.registerService("messaging",function(e){if(!isSupported())throw d.create(l.UNSUPPORTED_BROWSER);return self&&"ServiceWorkerGlobalScope"in self?new E(e):new k(e)},t)}function isSupported(){return self&&"ServiceWorkerGlobalScope"in self?function isSWControllerSupported(){return"PushManager"in self&&"Notification"in self&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey")}():function isWindowControllerSupported(){return navigator.cookieEnabled&&"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&"fetch"in window&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey")}()}registerMessaging(u.a)},"./node_modules/@firebase/util/dist/index.cjs.js":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./node_modules/tslib/tslib.es6.js"),i={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},o=function(e,t){if(!e)throw s(t)},s=function(e){return new Error("Firebase Database ("+i.SDK_VERSION+") INTERNAL ASSERT FAILED: "+e)},a=function(e){for(var t=[],r=0,n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t[r++]=i:i<2048?(t[r++]=i>>6|192,t[r++]=63&i|128):55296==(64512&i)&&n+1<e.length&&56320==(64512&e.charCodeAt(n+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++n)),t[r++]=i>>18|240,t[r++]=i>>12&63|128,t[r++]=i>>6&63|128,t[r++]=63&i|128):(t[r++]=i>>12|224,t[r++]=i>>6&63|128,t[r++]=63&i|128)}return t},c={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var r=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,n=[],i=0;i<e.length;i+=3){var o=e[i],s=i+1<e.length,a=s?e[i+1]:0,c=i+2<e.length,u=c?e[i+2]:0,l=o>>2,p=(3&o)<<4|a>>4,d=(15&a)<<2|u>>6,f=63&u;c||(f=64,s||(d=64)),n.push(r[l],r[p],r[d],r[f])}return n.join("")},encodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(a(e),t)},decodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){for(var t=[],r=0,n=0;r<e.length;){var i=e[r++];if(i<128)t[n++]=String.fromCharCode(i);else if(i>191&&i<224){var o=e[r++];t[n++]=String.fromCharCode((31&i)<<6|63&o)}else if(i>239&&i<365){var s=((7&i)<<18|(63&(o=e[r++]))<<12|(63&(a=e[r++]))<<6|63&e[r++])-65536;t[n++]=String.fromCharCode(55296+(s>>10)),t[n++]=String.fromCharCode(56320+(1023&s))}else{o=e[r++];var a=e[r++];t[n++]=String.fromCharCode((15&i)<<12|(63&o)<<6|63&a)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray:function(e,t){this.init_();for(var r=t?this.charToByteMapWebSafe_:this.charToByteMap_,n=[],i=0;i<e.length;){var o=r[e.charAt(i++)],s=i<e.length?r[e.charAt(i)]:0,a=++i<e.length?r[e.charAt(i)]:64,c=++i<e.length?r[e.charAt(i)]:64;if(++i,null==o||null==s||null==a||null==c)throw Error();var u=o<<2|s>>4;if(n.push(u),64!=a){var l=s<<4&240|a>>2;if(n.push(l),64!=c){var p=a<<6&192|c;n.push(p)}}}return n},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},u=function(e){try{return c.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function deepExtend(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:return new Date(t.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return t}for(var r in t)t.hasOwnProperty(r)&&(e[r]=deepExtend(e[r],t[r]));return e}var l=function(){function Deferred(){var e=this;this.promise=new Promise(function(t,r){e.resolve=t,e.reject=r})}return Deferred.prototype.wrapCallback=function(e){var t=this;return function(r,n){r?t.reject(r):t.resolve(n),"function"==typeof e&&(t.promise.catch(function(){}),1===e.length?e(r):e(r,n))}},Deferred}(),p=function(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""},d="FirebaseError",f=Error.captureStackTrace;var h=function(){return function FirebaseError(e,t){if(this.code=e,this.message=t,f)f(this,v.prototype.create);else try{throw Error.apply(this,arguments)}catch(e){this.name=d,Object.defineProperty(this,"stack",{get:function(){return e.stack}})}}}();h.prototype=Object.create(Error.prototype),h.prototype.constructor=h,h.prototype.name=d;var v=function(){function ErrorFactory(e,t,r){this.service=e,this.serviceName=t,this.errors=r,this.pattern=/\{\$([^}]+)}/g}return ErrorFactory.prototype.create=function(e,t){void 0===t&&(t={});var r,n=this.errors[e],i=this.service+"/"+e;r=void 0===n?"Error":n.replace(this.pattern,function(e,r){var n=t[r];return void 0!==n?n.toString():"<"+r+"?>"}),r=this.serviceName+": "+r+" ("+i+").";var o=new h(i,r);for(var s in t)t.hasOwnProperty(s)&&"_"!==s.slice(-1)&&(o[s]=t[s]);return o},ErrorFactory}();function jsonEval(e){return JSON.parse(e)}var _=function(e){var t={},r={},n={},i="";try{var o=e.split(".");t=jsonEval(u(o[0])||""),r=jsonEval(u(o[1])||""),i=o[2],n=r.d||{},delete r.d}catch(e){}return{header:t,claims:r,data:n,signature:i}},g=function(e,t){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(r,e[r])},m=function(e,t){return g(t,function(t,r){e[t]=r}),e},b=function(e,t,r){for(var n in e)if(t.call(r,e[n],n,e))return n},y=function(e){function Sha1(){var t=e.call(this)||this;t.chain_=[],t.buf_=[],t.W_=[],t.pad_=[],t.inbuf_=0,t.total_=0,t.blockSize=64,t.pad_[0]=128;for(var r=1;r<t.blockSize;++r)t.pad_[r]=0;return t.reset(),t}return n.__extends(Sha1,e),Sha1.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},Sha1.prototype.compress_=function(e,t){t||(t=0);var r=this.W_;if("string"==typeof e)for(var n=0;n<16;n++)r[n]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(n=0;n<16;n++)r[n]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(n=16;n<80;n++){var i=r[n-3]^r[n-8]^r[n-14]^r[n-16];r[n]=4294967295&(i<<1|i>>>31)}var o,s,a=this.chain_[0],c=this.chain_[1],u=this.chain_[2],l=this.chain_[3],p=this.chain_[4];for(n=0;n<80;n++){n<40?n<20?(o=l^c&(u^l),s=1518500249):(o=c^u^l,s=1859775393):n<60?(o=c&u|l&(c|u),s=2400959708):(o=c^u^l,s=3395469782);i=(a<<5|a>>>27)+o+p+s+r[n]&4294967295;p=l,l=u,u=4294967295&(c<<30|c>>>2),c=a,a=i}this.chain_[0]=this.chain_[0]+a&4294967295,this.chain_[1]=this.chain_[1]+c&4294967295,this.chain_[2]=this.chain_[2]+u&4294967295,this.chain_[3]=this.chain_[3]+l&4294967295,this.chain_[4]=this.chain_[4]+p&4294967295},Sha1.prototype.update=function(e,t){if(null!=e){void 0===t&&(t=e.length);for(var r=t-this.blockSize,n=0,i=this.buf_,o=this.inbuf_;n<t;){if(0==o)for(;n<=r;)this.compress_(e,n),n+=this.blockSize;if("string"==typeof e){for(;n<t;)if(i[o]=e.charCodeAt(n),++n,++o==this.blockSize){this.compress_(i),o=0;break}}else for(;n<t;)if(i[o]=e[n],++n,++o==this.blockSize){this.compress_(i),o=0;break}}this.inbuf_=o,this.total_+=t}},Sha1.prototype.digest=function(){var e=[],t=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var r=this.blockSize-1;r>=56;r--)this.buf_[r]=255&t,t/=256;this.compress_(this.buf_);var n=0;for(r=0;r<5;r++)for(var i=24;i>=0;i-=8)e[n]=this.chain_[r]>>i&255,++n;return e},Sha1}(function(){return function Hash(){this.blockSize=-1}}());var S=function(){function ObserverProxy(e,t){var r=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then(function(){e(r)}).catch(function(e){r.error(e)})}return ObserverProxy.prototype.next=function(e){this.forEachObserver(function(t){t.next(e)})},ObserverProxy.prototype.error=function(e){this.forEachObserver(function(t){t.error(e)}),this.close(e)},ObserverProxy.prototype.complete=function(){this.forEachObserver(function(e){e.complete()}),this.close()},ObserverProxy.prototype.subscribe=function(e,t,r){var n,i=this;if(void 0===e&&void 0===t&&void 0===r)throw new Error("Missing Observer.");void 0===(n=function implementsAnyMethods(e,t){if("object"!=typeof e||null===e)return!1;for(var r=0,n=t;r<n.length;r++){var i=n[r];if(i in e&&"function"==typeof e[i])return!0}return!1}(e,["next","error","complete"])?e:{next:e,error:t,complete:r}).next&&(n.next=noop),void 0===n.error&&(n.error=noop),void 0===n.complete&&(n.complete=noop);var o=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(function(){try{i.finalError?n.error(i.finalError):n.complete()}catch(e){}}),this.observers.push(n),o},ObserverProxy.prototype.unsubscribeOne=function(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},ObserverProxy.prototype.forEachObserver=function(e){if(!this.finalized)for(var t=0;t<this.observers.length;t++)this.sendOne(t,e)},ObserverProxy.prototype.sendOne=function(e,t){var r=this;this.task.then(function(){if(void 0!==r.observers&&void 0!==r.observers[e])try{t(r.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}})},ObserverProxy.prototype.close=function(e){var t=this;this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then(function(){t.observers=void 0,t.onNoObservers=void 0}))},ObserverProxy}();function noop(){}function errorPrefix(e,t,r){var n="";switch(t){case 1:n=r?"first":"First";break;case 2:n=r?"second":"Second";break;case 3:n=r?"third":"Third";break;case 4:n=r?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}var i=e+" failed: ";return i+=n+" argument "}t.assert=o,t.assertionError=s,t.base64=c,t.base64Decode=u,t.base64Encode=function(e){var t=a(e);return c.encodeByteArray(t,!0)},t.CONSTANTS=i,t.deepCopy=function deepCopy(e){return deepExtend(void 0,e)},t.deepExtend=deepExtend,t.patchProperty=function patchProperty(e,t,r){e[t]=r},t.Deferred=l,t.getUA=p,t.isMobileCordova=function(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(p())},t.isNodeSdk=function(){return!0===i.NODE_CLIENT||!0===i.NODE_ADMIN},t.isReactNative=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},t.ErrorFactory=v,t.FirebaseError=h,t.patchCapture=function patchCapture(e){var t=f;return f=e,t},t.jsonEval=jsonEval,t.stringify=function stringify(e){return JSON.stringify(e)},t.decode=_,t.isAdmin=function(e){var t=_(e).claims;return"object"==typeof t&&!0===t.admin},t.issuedAtTime=function(e){var t=_(e).claims;return"object"==typeof t&&t.hasOwnProperty("iat")?t.iat:null},t.isValidFormat=function(e){var t=_(e),r=t.claims;return!!t.signature&&!!r&&"object"==typeof r&&r.hasOwnProperty("iat")},t.isValidTimestamp=function(e){var t,r,n=_(e).claims,i=Math.floor((new Date).getTime()/1e3);return"object"==typeof n&&(n.hasOwnProperty("nbf")?t=n.nbf:n.hasOwnProperty("iat")&&(t=n.iat),r=n.hasOwnProperty("exp")?n.exp:t+86400),i&&t&&r&&i>=t&&i<=r},t.clone=function(e){return m({},e)},t.contains=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.every=function(e,t){for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)&&!t(r,e[r]))return!1;return!0},t.extend=m,t.findKey=b,t.findValue=function(e,t,r){var n=b(e,t,r);return n&&e[n]},t.forEach=g,t.getAnyKey=function(e){for(var t in e)return t},t.getCount=function(e){var t=0;for(var r in e)t++;return t},t.getValues=function(e){var t=[],r=0;for(var n in e)t[r++]=e[n];return t},t.isEmpty=function(e){for(var t in e)return!1;return!0},t.isNonNullObject=function(e){return"object"==typeof e&&null!==e},t.map=function(e,t,r){var n={};for(var i in e)n[i]=t.call(r,e[i],i,e);return n},t.safeGet=function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]},t.querystring=function(e){var t=[];return g(e,function(e,r){Array.isArray(r)?r.forEach(function(r){t.push(encodeURIComponent(e)+"="+encodeURIComponent(r))}):t.push(encodeURIComponent(e)+"="+encodeURIComponent(r))}),t.length?"&"+t.join("&"):""},t.querystringDecode=function(e){var t={};return e.replace(/^\?/,"").split("&").forEach(function(e){if(e){var r=e.split("=");t[r[0]]=r[1]}}),t},t.Sha1=y,t.async=function async(e,t){return function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];Promise.resolve(!0).then(function(){e.apply(void 0,r)}).catch(function(e){t&&t(e)})}},t.createSubscribe=function createSubscribe(e,t){var r=new S(e,t);return r.subscribe.bind(r)},t.errorPrefix=errorPrefix,t.validateArgCount=function(e,t,r,n){var i;if(n<t?i="at least "+t:n>r&&(i=0===r?"none":"no more than "+r),i)throw new Error(e+" failed: Was called with "+n+(1===n?" argument.":" arguments.")+" Expects "+i+".")},t.validateCallback=function validateCallback(e,t,r,n){if((!n||r)&&"function"!=typeof r)throw new Error(errorPrefix(e,t,n)+"must be a valid function.")},t.validateContextObject=function validateContextObject(e,t,r,n){if((!n||r)&&("object"!=typeof r||null===r))throw new Error(errorPrefix(e,t,n)+"must be a valid context object.")},t.validateNamespace=function validateNamespace(e,t,r,n){if((!n||r)&&"string"!=typeof r)throw new Error(errorPrefix(e,t,n)+"must be a valid firebase namespace.")},t.stringLength=function(e){for(var t=0,r=0;r<e.length;r++){var n=e.charCodeAt(r);n<128?t++:n<2048?t+=2:n>=55296&&n<=56319?(t+=4,r++):t+=3}return t},t.stringToByteArray=function(e){for(var t=[],r=0,n=0;n<e.length;n++){var i=e.charCodeAt(n);if(i>=55296&&i<=56319){var s=i-55296;o(++n<e.length,"Surrogate pair missing trail surrogate."),i=65536+(s<<10)+(e.charCodeAt(n)-56320)}i<128?t[r++]=i:i<2048?(t[r++]=i>>6|192,t[r++]=63&i|128):i<65536?(t[r++]=i>>12|224,t[r++]=i>>6&63|128,t[r++]=63&i|128):(t[r++]=i>>18|240,t[r++]=i>>12&63|128,t[r++]=i>>6&63|128,t[r++]=63&i|128)}return t}},"./node_modules/error-stack-parser/error-stack-parser.js":function(e,t,r){var n,i,o;!function(s,a){"use strict";i=[r("./node_modules/stackframe/stackframe.js")],void 0===(o="function"==typeof(n=function ErrorStackParser(e){var t=/(^|@)\S+\:\d+/,r=/^\s*at .*(\S+\:\d+|\(native\))/m,n=/^(eval@)?(\[native code\])?$/;return{parse:function ErrorStackParser$$parse(e){if(void 0!==e.stacktrace||void 0!==e["opera#sourceloc"])return this.parseOpera(e);if(e.stack&&e.stack.match(r))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw new Error("Cannot parse given Error object")},extractLocation:function ErrorStackParser$$extractLocation(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?:\:(\d+))?(?:\:(\d+))?$/.exec(e.replace(/[\(\)]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function ErrorStackParser$$parseV8OrIE(t){var n=t.stack.split("\n").filter(function(e){return!!e.match(r)},this);return n.map(function(t){t.indexOf("(eval ")>-1&&(t=t.replace(/eval code/g,"eval").replace(/(\(eval at [^\()]*)|(\)\,.*$)/g,""));var r=t.replace(/^\s+/,"").replace(/\(eval code/g,"(").split(/\s+/).slice(1),n=this.extractLocation(r.pop()),i=r.join(" ")||void 0,o=["eval","<anonymous>"].indexOf(n[0])>-1?void 0:n[0];return new e({functionName:i,fileName:o,lineNumber:n[1],columnNumber:n[2],source:t})},this)},parseFFOrSafari:function ErrorStackParser$$parseFFOrSafari(t){var r=t.stack.split("\n").filter(function(e){return!e.match(n)},this);return r.map(function(t){if(t.indexOf(" > eval")>-1&&(t=t.replace(/ line (\d+)(?: > eval line \d+)* > eval\:\d+\:\d+/g,":$1")),-1===t.indexOf("@")&&-1===t.indexOf(":"))return new e({functionName:t});var r=/((.*".+"[^@]*)?[^@]*)(?:@)/,n=t.match(r),i=n&&n[1]?n[1]:void 0,o=this.extractLocation(t.replace(r,""));return new e({functionName:i,fileName:o[0],lineNumber:o[1],columnNumber:o[2],source:t})},this)},parseOpera:function ErrorStackParser$$parseOpera(e){return!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function ErrorStackParser$$parseOpera9(t){for(var r=/Line (\d+).*script (?:in )?(\S+)/i,n=t.message.split("\n"),i=[],o=2,s=n.length;o<s;o+=2){var a=r.exec(n[o]);a&&i.push(new e({fileName:a[2],lineNumber:a[1],source:n[o]}))}return i},parseOpera10:function ErrorStackParser$$parseOpera10(t){for(var r=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,n=t.stacktrace.split("\n"),i=[],o=0,s=n.length;o<s;o+=2){var a=r.exec(n[o]);a&&i.push(new e({functionName:a[3]||void 0,fileName:a[2],lineNumber:a[1],source:n[o]}))}return i},parseOpera11:function ErrorStackParser$$parseOpera11(r){var n=r.stack.split("\n").filter(function(e){return!!e.match(t)&&!e.match(/^Error created at/)},this);return n.map(function(t){var r,n=t.split("@"),i=this.extractLocation(n.pop()),o=n.shift()||"",s=o.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^\)]*\)/g,"")||void 0;o.match(/\(([^\)]*)\)/)&&(r=o.replace(/^[^\(]+\(([^\)]*)\)$/,"$1"));var a=void 0===r||"[arguments not available]"===r?void 0:r.split(",");return new e({functionName:s,args:a,fileName:i[0],lineNumber:i[1],columnNumber:i[2],source:t})},this)}}})?n.apply(t,i):n)||(e.exports=o)}()},"./node_modules/process/browser.js":function(e,t){var r,n,i=e.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(r===setTimeout)return setTimeout(e,0);if((r===defaultSetTimout||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){r=defaultSetTimout}try{n="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){n=defaultClearTimeout}}();var o,s=[],a=!1,c=-1;function cleanUpNextTick(){a&&o&&(a=!1,o.length?s=o.concat(s):c=-1,s.length&&drainQueue())}function drainQueue(){if(!a){var e=runTimeout(cleanUpNextTick);a=!0;for(var t=s.length;t;){for(o=s,s=[];++c<t;)o&&o[c].run();c=-1,t=s.length}o=null,a=!1,function runClearTimeout(e){if(n===clearTimeout)return clearTimeout(e);if((n===defaultClearTimeout||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{return n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];s.push(new Item(e,t)),1!==s.length||a||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=noop,i.addListener=noop,i.once=noop,i.off=noop,i.removeListener=noop,i.removeAllListeners=noop,i.emit=noop,i.prependListener=noop,i.prependOnceListener=noop,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},"./node_modules/reflect-metadata/Reflect.js":function(e,t,r){(function(e,t){var r;!function(r){!function(n){var i="object"==typeof t?t:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),o=makeExporter(r);function makeExporter(e,t){return function(r,n){"function"!=typeof e[r]&&Object.defineProperty(e,r,{configurable:!0,writable:!0,value:n}),t&&t(r,n)}}void 0===i.Reflect?i.Reflect=r:o=makeExporter(i.Reflect,o),function(t){var r=Object.prototype.hasOwnProperty,n="function"==typeof Symbol,i=n&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",o=n&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",s="function"==typeof Object.create,a={__proto__:[]}instanceof Array,c=!s&&!a,u={create:s?function(){return MakeDictionary(Object.create(null))}:a?function(){return MakeDictionary({__proto__:null})}:function(){return MakeDictionary({})},has:c?function(e,t){return r.call(e,t)}:function(e,t){return t in e},get:c?function(e,t){return r.call(e,t)?e[t]:void 0}:function(e,t){return e[t]}},l=Object.getPrototypeOf(Function),p="object"==typeof e&&e.env&&"true"===e.env.REFLECT_METADATA_USE_MAP_POLYFILL,d=p||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?function CreateMapPolyfill(){var e={},t=[],r=function(){function MapIterator(e,t,r){this._index=0,this._keys=e,this._values=t,this._selector=r}return MapIterator.prototype["@@iterator"]=function(){return this},MapIterator.prototype[o]=function(){return this},MapIterator.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var r=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:r,done:!1}}return{value:void 0,done:!0}},MapIterator.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},MapIterator.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},MapIterator}();return function(){function Map(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(Map.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Map.prototype.has=function(e){return this._find(e,!1)>=0},Map.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},Map.prototype.set=function(e,t){var r=this._find(e,!0);return this._values[r]=t,this},Map.prototype.delete=function(t){var r=this._find(t,!1);if(r>=0){for(var n=this._keys.length,i=r+1;i<n;i++)this._keys[i-1]=this._keys[i],this._values[i-1]=this._values[i];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},Map.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},Map.prototype.keys=function(){return new r(this._keys,this._values,getKey)},Map.prototype.values=function(){return new r(this._keys,this._values,getValue)},Map.prototype.entries=function(){return new r(this._keys,this._values,getEntry)},Map.prototype["@@iterator"]=function(){return this.entries()},Map.prototype[o]=function(){return this.entries()},Map.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},Map}();function getKey(e,t){return e}function getValue(e,t){return t}function getEntry(e,t){return[e,t]}}():Map,f=p||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?function CreateSetPolyfill(){return function(){function Set(){this._map=new d}return Object.defineProperty(Set.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),Set.prototype.has=function(e){return this._map.has(e)},Set.prototype.add=function(e){return this._map.set(e,e),this},Set.prototype.delete=function(e){return this._map.delete(e)},Set.prototype.clear=function(){this._map.clear()},Set.prototype.keys=function(){return this._map.keys()},Set.prototype.values=function(){return this._map.values()},Set.prototype.entries=function(){return this._map.entries()},Set.prototype["@@iterator"]=function(){return this.keys()},Set.prototype[o]=function(){return this.keys()},Set}()}():Set,h=new(p||"function"!=typeof WeakMap?function CreateWeakMapPolyfill(){var e=16,t=u.create(),n=CreateUniqueKey();return function(){function WeakMap(){this._key=CreateUniqueKey()}return WeakMap.prototype.has=function(e){var t=GetOrCreateWeakMapTable(e,!1);return void 0!==t&&u.has(t,this._key)},WeakMap.prototype.get=function(e){var t=GetOrCreateWeakMapTable(e,!1);return void 0!==t?u.get(t,this._key):void 0},WeakMap.prototype.set=function(e,t){var r=GetOrCreateWeakMapTable(e,!0);return r[this._key]=t,this},WeakMap.prototype.delete=function(e){var t=GetOrCreateWeakMapTable(e,!1);return void 0!==t&&delete t[this._key]},WeakMap.prototype.clear=function(){this._key=CreateUniqueKey()},WeakMap}();function CreateUniqueKey(){var e;do{e="@@WeakMap@@"+CreateUUID()}while(u.has(t,e));return t[e]=!0,e}function GetOrCreateWeakMapTable(e,t){if(!r.call(e,n)){if(!t)return;Object.defineProperty(e,n,{value:u.create()})}return e[n]}function FillRandomBytes(e,t){for(var r=0;r<t;++r)e[r]=255*Math.random()|0;return e}function CreateUUID(){var t=function GenRandomBytes(e){if("function"==typeof Uint8Array)return"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):FillRandomBytes(new Uint8Array(e),e);return FillRandomBytes(new Array(e),e)}(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var r="",n=0;n<e;++n){var i=t[n];4!==n&&6!==n&&8!==n||(r+="-"),i<16&&(r+="0"),r+=i.toString(16).toLowerCase()}return r}}():WeakMap);function GetOrCreateMetadataMap(e,t,r){var n=h.get(e);if(IsUndefined(n)){if(!r)return;n=new d,h.set(e,n)}var i=n.get(t);if(IsUndefined(i)){if(!r)return;i=new d,n.set(t,i)}return i}function OrdinaryHasOwnMetadata(e,t,r){var n=GetOrCreateMetadataMap(t,r,!1);return!IsUndefined(n)&&function ToBoolean(e){return!!e}(n.has(e))}function OrdinaryGetOwnMetadata(e,t,r){var n=GetOrCreateMetadataMap(t,r,!1);if(!IsUndefined(n))return n.get(e)}function OrdinaryDefineOwnMetadata(e,t,r,n){var i=GetOrCreateMetadataMap(r,n,!0);i.set(e,t)}function OrdinaryOwnMetadataKeys(e,t){var r=[],n=GetOrCreateMetadataMap(e,t,!1);if(IsUndefined(n))return r;for(var i=n.keys(),s=function GetIterator(e){var t=GetMethod(e,o);if(!IsCallable(t))throw new TypeError;var r=t.call(e);if(!IsObject(r))throw new TypeError;return r}(i),a=0;;){var c=IteratorStep(s);if(!c)return r.length=a,r;var u=IteratorValue(c);try{r[a]=u}catch(e){try{IteratorClose(s)}finally{throw e}}a++}}function Type(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function IsUndefined(e){return void 0===e}function IsNull(e){return null===e}function IsObject(e){return"object"==typeof e?null!==e:"function"==typeof e}function ToPrimitive(e,t){switch(Type(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var r=3===t?"string":5===t?"number":"default",n=GetMethod(e,i);if(void 0!==n){var o=n.call(e,r);if(IsObject(o))throw new TypeError;return o}return function OrdinaryToPrimitive(e,t){if("string"===t){var r=e.toString;if(IsCallable(r)){var n=r.call(e);if(!IsObject(n))return n}var i=e.valueOf;if(IsCallable(i)){var n=i.call(e);if(!IsObject(n))return n}}else{var i=e.valueOf;if(IsCallable(i)){var n=i.call(e);if(!IsObject(n))return n}var o=e.toString;if(IsCallable(o)){var n=o.call(e);if(!IsObject(n))return n}}throw new TypeError}(e,"default"===r?"number":r)}function ToPropertyKey(e){var t=ToPrimitive(e,3);return function IsSymbol(e){return"symbol"==typeof e}(t)?t:function ToString(e){return""+e}(t)}function IsArray(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function IsCallable(e){return"function"==typeof e}function IsConstructor(e){return"function"==typeof e}function GetMethod(e,t){var r=e[t];if(void 0!==r&&null!==r){if(!IsCallable(r))throw new TypeError;return r}}function IteratorValue(e){return e.value}function IteratorStep(e){var t=e.next();return!t.done&&t}function IteratorClose(e){var t=e.return;t&&t.call(e)}function OrdinaryGetPrototypeOf(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===l)return t;if(t!==l)return t;var r=e.prototype,n=r&&Object.getPrototypeOf(r);if(null==n||n===Object.prototype)return t;var i=n.constructor;return"function"!=typeof i?t:i===e?t:i}function MakeDictionary(e){return e.__=void 0,delete e.__,e}t("decorate",function decorate(e,t,r,n){if(IsUndefined(r)){if(!IsArray(e))throw new TypeError;if(!IsConstructor(t))throw new TypeError;return function DecorateConstructor(e,t){for(var r=e.length-1;r>=0;--r){var n=e[r],i=n(t);if(!IsUndefined(i)&&!IsNull(i)){if(!IsConstructor(i))throw new TypeError;t=i}}return t}(e,t)}if(!IsArray(e))throw new TypeError;if(!IsObject(t))throw new TypeError;if(!IsObject(n)&&!IsUndefined(n)&&!IsNull(n))throw new TypeError;return IsNull(n)&&(n=void 0),r=ToPropertyKey(r),function DecorateProperty(e,t,r,n){for(var i=e.length-1;i>=0;--i){var o=e[i],s=o(t,r,n);if(!IsUndefined(s)&&!IsNull(s)){if(!IsObject(s))throw new TypeError;n=s}}return n}(e,t,r,n)}),t("metadata",function metadata(e,t){return function decorator(r,n){if(!IsObject(r))throw new TypeError;if(!IsUndefined(n)&&!function IsPropertyKey(e){switch(Type(e)){case 3:case 4:return!0;default:return!1}}(n))throw new TypeError;OrdinaryDefineOwnMetadata(e,t,r,n)}}),t("defineMetadata",function defineMetadata(e,t,r,n){if(!IsObject(r))throw new TypeError;IsUndefined(n)||(n=ToPropertyKey(n));return OrdinaryDefineOwnMetadata(e,t,r,n)}),t("hasMetadata",function hasMetadata(e,t,r){if(!IsObject(t))throw new TypeError;IsUndefined(r)||(r=ToPropertyKey(r));return function OrdinaryHasMetadata(e,t,r){var n=OrdinaryHasOwnMetadata(e,t,r);if(n)return!0;var i=OrdinaryGetPrototypeOf(t);if(!IsNull(i))return OrdinaryHasMetadata(e,i,r);return!1}(e,t,r)}),t("hasOwnMetadata",function hasOwnMetadata(e,t,r){if(!IsObject(t))throw new TypeError;IsUndefined(r)||(r=ToPropertyKey(r));return OrdinaryHasOwnMetadata(e,t,r)}),t("getMetadata",function getMetadata(e,t,r){if(!IsObject(t))throw new TypeError;IsUndefined(r)||(r=ToPropertyKey(r));return function OrdinaryGetMetadata(e,t,r){var n=OrdinaryHasOwnMetadata(e,t,r);if(n)return OrdinaryGetOwnMetadata(e,t,r);var i=OrdinaryGetPrototypeOf(t);if(!IsNull(i))return OrdinaryGetMetadata(e,i,r);return}(e,t,r)}),t("getOwnMetadata",function getOwnMetadata(e,t,r){if(!IsObject(t))throw new TypeError;IsUndefined(r)||(r=ToPropertyKey(r));return OrdinaryGetOwnMetadata(e,t,r)}),t("getMetadataKeys",function getMetadataKeys(e,t){if(!IsObject(e))throw new TypeError;IsUndefined(t)||(t=ToPropertyKey(t));return function OrdinaryMetadataKeys(e,t){var r=OrdinaryOwnMetadataKeys(e,t);var n=OrdinaryGetPrototypeOf(e);if(null===n)return r;var i=OrdinaryMetadataKeys(n,t);if(i.length<=0)return r;if(r.length<=0)return i;var o=new f;var s=[];for(var a=0,c=r;a<c.length;a++){var u=c[a],l=o.has(u);l||(o.add(u),s.push(u))}for(var p=0,d=i;p<d.length;p++){var u=d[p],l=o.has(u);l||(o.add(u),s.push(u))}return s}(e,t)}),t("getOwnMetadataKeys",function getOwnMetadataKeys(e,t){if(!IsObject(e))throw new TypeError;IsUndefined(t)||(t=ToPropertyKey(t));return OrdinaryOwnMetadataKeys(e,t)}),t("deleteMetadata",function deleteMetadata(e,t,r){if(!IsObject(t))throw new TypeError;IsUndefined(r)||(r=ToPropertyKey(r));var n=GetOrCreateMetadataMap(t,r,!1);if(IsUndefined(n))return!1;if(!n.delete(e))return!1;if(n.size>0)return!0;var i=h.get(t);return i.delete(r),i.size>0||(h.delete(t),!0)})}(o)}()}(r||(r={}))}).call(this,r("./node_modules/process/browser.js"),r("./node_modules/webpack/buildin/global.js"))},"./node_modules/stackframe/stackframe.js":function(e,t,r){var n,i,o;!function(r,s){"use strict";i=[],void 0===(o="function"==typeof(n=function(){function _isNumber(e){return!isNaN(parseFloat(e))&&isFinite(e)}function _capitalize(e){return e.charAt(0).toUpperCase()+e.substring(1)}function _getter(e){return function(){return this[e]}}var e=["isConstructor","isEval","isNative","isToplevel"],t=["columnNumber","lineNumber"],r=["fileName","functionName","source"],n=e.concat(t,r,["args"]);function StackFrame(e){if(e instanceof Object)for(var t=0;t<n.length;t++)e.hasOwnProperty(n[t])&&void 0!==e[n[t]]&&this["set"+_capitalize(n[t])](e[n[t]])}StackFrame.prototype={getArgs:function(){return this.args},setArgs:function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw new TypeError("Args must be an Array");this.args=e},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(e){if(e instanceof StackFrame)this.evalOrigin=e;else{if(!(e instanceof Object))throw new TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new StackFrame(e)}},toString:function(){var e=this.getFunctionName()||"{anonymous}",t="("+(this.getArgs()||[]).join(",")+")",r=this.getFileName()?"@"+this.getFileName():"",n=_isNumber(this.getLineNumber())?":"+this.getLineNumber():"",i=_isNumber(this.getColumnNumber())?":"+this.getColumnNumber():"";return e+t+r+n+i}};for(var i=0;i<e.length;i++)StackFrame.prototype["get"+_capitalize(e[i])]=_getter(e[i]),StackFrame.prototype["set"+_capitalize(e[i])]=function(e){return function(t){this[e]=Boolean(t)}}(e[i]);for(var o=0;o<t.length;o++)StackFrame.prototype["get"+_capitalize(t[o])]=_getter(t[o]),StackFrame.prototype["set"+_capitalize(t[o])]=function(e){return function(t){if(!_isNumber(t))throw new TypeError(e+" must be a Number");this[e]=Number(t)}}(t[o]);for(var s=0;s<r.length;s++)StackFrame.prototype["get"+_capitalize(r[s])]=_getter(r[s]),StackFrame.prototype["set"+_capitalize(r[s])]=function(e){return function(t){this[e]=String(t)}}(r[s]);return StackFrame})?n.apply(t,i):n)||(e.exports=o)}()},"./node_modules/tslib/tslib.es6.js":function(e,t,r){"use strict";r.r(t),r.d(t,"__extends",function(){return __extends}),r.d(t,"__assign",function(){return i}),r.d(t,"__rest",function(){return __rest}),r.d(t,"__decorate",function(){return __decorate}),r.d(t,"__param",function(){return __param}),r.d(t,"__metadata",function(){return __metadata}),r.d(t,"__awaiter",function(){return __awaiter}),r.d(t,"__generator",function(){return __generator}),r.d(t,"__exportStar",function(){return __exportStar}),r.d(t,"__values",function(){return __values}),r.d(t,"__read",function(){return __read}),r.d(t,"__spread",function(){return __spread}),r.d(t,"__await",function(){return __await}),r.d(t,"__asyncGenerator",function(){return __asyncGenerator}),r.d(t,"__asyncDelegator",function(){return __asyncDelegator}),r.d(t,"__asyncValues",function(){return __asyncValues}),r.d(t,"__makeTemplateObject",function(){return __makeTemplateObject}),r.d(t,"__importStar",function(){return __importStar}),r.d(t,"__importDefault",function(){return __importDefault});var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};function __extends(e,t){function __(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}var i=Object.assign||function __assign(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};function __rest(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&(r[n[i]]=e[n[i]])}return r}function __decorate(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}function __param(e,t){return function(r,n){t(r,n,e)}}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __awaiter(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})}function __generator(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=n[2&o[0]?"return":o[0]?"throw":"next"])&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[0,i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function __exportStar(e,t){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}function __values(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function __read(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s}function __spread(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(__read(arguments[t]));return e}function __await(e){return this instanceof __await?(this.v=e,this):new __await(e)}function __asyncGenerator(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,i=r.apply(e,t||[]),o=[];return n={},verb("next"),verb("throw"),verb("return"),n[Symbol.asyncIterator]=function(){return this},n;function verb(e){i[e]&&(n[e]=function(t){return new Promise(function(r,n){o.push([e,t,r,n])>1||resume(e,t)})})}function resume(e,t){try{!function step(e){e.value instanceof __await?Promise.resolve(e.value.v).then(fulfill,reject):settle(o[0][2],e)}(i[e](t))}catch(e){settle(o[0][3],e)}}function fulfill(e){resume("next",e)}function reject(e){resume("throw",e)}function settle(e,t){e(t),o.shift(),o.length&&resume(o[0][0],o[0][1])}}function __asyncDelegator(e){var t,r;return t={},verb("next"),verb("throw",function(e){throw e}),verb("return"),t[Symbol.iterator]=function(){return this},t;function verb(n,i){e[n]&&(t[n]=function(t){return(r=!r)?{value:__await(e[n](t)),done:"return"===n}:i?i(t):t})}}function __asyncValues(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator];return t?t.call(e):__values(e)}function __makeTemplateObject(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function __importStar(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function __importDefault(e){return e&&e.__esModule?e:{default:e}}},"./node_modules/webpack/buildin/global.js":function(e,t){var r;r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(r=window)}e.exports=r},"./src/container.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r("./node_modules/reflect-metadata/Reflect.js");var n=function(){function Container(){this.store=[]}return Container.prototype.transient=function(e){this.remove(e),this.store.push([e])},Container.prototype.singleton=function(e,t){this.remove(e),this.store.push([e,t])},Container.prototype.get=function(e){for(var t,r=this,n=0,i=this.store;n<i.length;n++){var o=i[n];if(o[0]===e||o[0].name===e){t=o;break}}if(!t)throw console.error(e),new Error("Doesn't exist in the container");if(1===t.length){var s=[null],a=Reflect.getMetadata("design:paramtypes",t[0]);return a&&a.forEach(function(e){s.push(r.get(e.name||e))}),new(t[0].bind.apply(t[0],s))}if(2===t.length)return t[1]},Container.prototype.remove=function(e){for(var t=0;t<this.store.length;t++)if(this.store[t][0]===e)return void this.store.splice(t,1)},Container}();t.Container=n},"./src/sdk/components/base-prompt.component.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var s=r("./src/sdk/event-manager.ts"),a=r("./src/sdk/utils/delay.ts"),c=r("./src/sdk/constants.ts"),u=r("./src/sdk/utils/try-parse.ts"),l=0,p=function(e){function BasePromptComponent(t,r,n,i,o,s,a,c){var u=e.call(this)||this;return u.appContext=t,u.loggingService=r,u.environmentService=n,u.cookieService=i,u.eventsService=o,u.dbService=s,u.registrationService=a,u.sessionService=c,u}return n(BasePromptComponent,e),BasePromptComponent.prototype.init=function(e,t){return void 0===t&&(t=document.body),i(this,void 0,void 0,function(){var r,n;return o(this,function(i){switch(i.label){case 0:this.parent=t||document.body,i.label=1;case 1:return i.trys.push([1,10,,11]),this.parent?[3,5]:l<5?(this.loggingService.info("Prompt parent element, "+String(this.parent)+", could not be resolved"),l++,[4,a.delay(100*l*2)]):[3,3];case 2:return i.sent(),[2,this.init(e,this.parent)];case 3:this.loggingService.warn("Prompt parent element, "+String(this.parent)+", unavailable"),i.label=4;case 4:return[3,9];case 5:return this.initialized=!0,this.promptSettings=e,this.buildOptions=e.config,this.runConditions=e.conditions_json,"subscribed"in this.buildOptions?(this.subscribed=!!this.buildOptions.subscribed,[3,8]):[3,6];case 6:return r=this,[4,this.environmentService.isUserSubscribed()];case 7:r.subscribed=i.sent(),i.label=8;case 8:this.subscribed&&this.loggingService.once().info("User is subscribed"),i.label=9;case 9:return[3,11];case 10:return n=i.sent(),this.loggingService.error(n),[3,11];case 11:return[2]}})})},BasePromptComponent.prototype.checkRunConditions=function(){return i(this,void 0,void 0,function(){var e,t=this;return o(this,function(r){return e=1e3,[2,new Promise(function(r,n){return i(t,void 0,void 0,function(){var t,i,s,c,u=this;return o(this,function(o){switch(o.label){case 0:return t=(this.buildOptions||{}).behavior||{},(i=(this.runConditions||{}).visitor||{}).session_page_views||i.session_time_on_site_seconds?[3,2]:(s=t.delay_seconds||0,void 0!==i.time_on_page_seconds&&(s=i.time_on_page_seconds||0),c=s?1e3*s:0,this.loggingService.info("PromptRequirements::timeOnPageSeconds [at least "+s+" seconds]"),[4,a.delay(c)]);case 1:return o.sent(),r(),[3,3];case 2:void 0!==i.session_page_views?(this.loggingService.info("PromptRequirements::sessionPageViews [at least "+i.session_page_views+" pages]"),this.checkSessionPageViews()?r():setInterval(function(){u.checkSessionPageViews()&&(void 0,r())},e)):void 0!==i.session_time_on_site_seconds?(this.loggingService.info("PromptRequirements::sessionTimeOnSite [at least "+i.session_time_on_site_seconds+" seconds]"),this.checkSessionTimeOnSite()?r():setInterval(function(){u.checkSessionTimeOnSite()&&(void 0,r())},e)):n("No conditions were satisfied"),o.label=3;case 3:return[2]}})})})]})})},BasePromptComponent.prototype.isNativePrompt=function(){return"NATIVE"===this.promptSettings.style.toUpperCase()},BasePromptComponent.prototype.isSlidePrompt=function(){return"SLIDE"===this.promptSettings.style.toUpperCase()},BasePromptComponent.prototype.isBellPrompt=function(){return"BELL"===this.promptSettings.style.toUpperCase()},BasePromptComponent.prototype.isPublisherCustomPrompt=function(){return"PUBLISHER_CUSTOM"===this.promptSettings.style.toUpperCase()},BasePromptComponent.prototype.isUserPromptEligible=function(){return i(this,void 0,void 0,function(){var e,t;return o(this,function(r){switch(r.label){case 0:return[4,this.environmentService.isUserPromptEligible()];case 1:return e=r.sent(),t=!0,this.isNativePrompt()||this.isSlidePrompt()?[4,this.isFCapEligible()]:[3,3];case 2:t=r.sent(),r.label=3;case 3:return[2,e&&t]}})})},BasePromptComponent.prototype.incrementUserPromptCount=function(){try{var e=this.appContext.settings.domain,t=this.isNativePrompt()||this.isSlidePrompt(),r=!!e&&!!e.frequency_caps&&!!e.frequency_caps.prompt;if(t&&r){var n=e.frequency_caps.prompt.fcap_seconds;if(n>0){var i=this.cookieService.getCookie(c.PUSHLY_USER_PROMPT_COUNT_COOKIE),o=0,s=new Date;if(s.setTime(s.getTime()+1e3*n),i){var a=i.split("|");2===a.length&&(o=parseInt(a[0],10),s=a[1])}s instanceof Date&&(s=s.toUTCString()),this.cookieService.setCookieWithRawExpires(c.PUSHLY_USER_PROMPT_FREQ_COOKIE,n,s),this.cookieService.setCookieWithRawExpires(c.PUSHLY_USER_PROMPT_COUNT_COOKIE,o+1+"|"+s,s)}}}catch(e){this.loggingService.warn("Encountered an error while updating prompt frequency cap"),this.loggingService.error(e)}},BasePromptComponent.prototype.isFCapEligible=function(){return i(this,void 0,void 0,function(){var e,t,r,n,i,s,a,l,p,d;return o(this,function(o){e=!0,t=0;try{if(r=this.appContext.settings.domain,n=this.isNativePrompt()||this.isSlidePrompt(),i=!!r&&!!r.frequency_caps&&!!r.frequency_caps.prompt,n)if(i){if(s=r.frequency_caps.prompt,a=this.cookieService.getCookie(c.PUSHLY_USER_PROMPT_COUNT_COOKIE),l=this.cookieService.getCookie(c.PUSHLY_USER_PROMPT_FREQ_COOKIE),String(l)!==String(s.fcap_seconds))this.loggingService.info("Detected a change in prompt fcap time frequency"),this.clearFcapCookies();else if(a&&2===(p=a.split("|")).length&&(d=p[1],u.tryParseInt(p[0],0)>=s.occurrences)){e=!1;try{t=Math.floor((Date.parse(d)-(new Date).getTime())/1e3)}catch(e){}}}else this.clearFcapCookies()}catch(e){this.loggingService.warn("Encountered an error while checking prompt frequency cap"),this.loggingService.error(e)}return e||this.loggingService.info("Prompt frequency cap has been met"+(t>0?" - "+t+" seconds remain":"")),[2,e]})})},BasePromptComponent.prototype.clearFcapCookies=function(){this.cookieService.clearCookie(c.PUSHLY_USER_PROMPT_COUNT_COOKIE),this.cookieService.clearCookie(c.PUSHLY_USER_PROMPT_FREQ_COOKIE)},BasePromptComponent.prototype.checkSessionPageViews=function(){var e=!1,t=this.runConditions.visitor.session_page_views;return this.sessionService.getCurrentTotalPageViews()>=t&&(e=!0),e},BasePromptComponent.prototype.checkSessionTimeOnSite=function(){var e=!1;return(Date.now()-this.sessionService.current.sessionStart)/1e3>=this.runConditions.visitor.session_time_on_site_seconds&&(e=!0),e},BasePromptComponent}(s.EventManager);t.BasePromptComponent=p},"./src/sdk/components/bell.component.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/web-event-bus.ts"),u=r("./src/sdk/services/index.ts"),l=r("./src/sdk/decorators/index.ts"),p=r("./src/sdk/constants.ts"),d=r("./src/sdk/enums/index.ts"),f=r("./src/sdk/components/dom-prompt-component.ts"),h=r("./src/sdk/models/index.ts"),v={"top-left":"d-top-left","top-right":"d-top-right","bottom-right":"d-bottom-right","bottom-left":"d-bottom-left",disabled:"d-disabled"},_={"top-left":"m-top-left","top-right":"m-top-right","bottom-right":"m-bottom-right","bottom-left":"m-bottom-left",disabled:"m-disabled"},g=function(e){function BellComponent(t,r,n,i,o,s,a,c){return e.call(this,t,r,n,i,o,s,a,c)||this}return n(BellComponent,e),BellComponent.prototype.wireEvents=function(){var e=this;this.element.addEventListener("click",function(t){return s(e,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return[4,this.environmentService.isUserSubscribed()];case 1:return e.sent()||this.allow(t),[2]}})})}),this.svg.addEventListener("mouseover",function(){e.element.classList.add("hover")}),this.svg.addEventListener("mouseout",function(){e.element.classList.remove("hover")});var t=null;window.addEventListener("resize",function(){t&&clearTimeout(t),t=setTimeout(function(){t=null,e.updateSize()},50)}),c.WebEventBus.on("proxy_response_subscribed,subscribed,migrated",function(){e.element.classList.add("subscribed"),e.subscribed=!0,e.buildOptions.behavior.display_behavior===d.BellDisplayBehavior.PreSubscription?e.hide():e.attemptToShow()}),c.WebEventBus.on("unsubscribed",function(){alert("x"),e.subscribed=!1,e.buildOptions.behavior.display_behavior===d.BellDisplayBehavior.PostSubscription?e.hide():e.attemptToShow()}),c.WebEventBus.on("permission_denied,prompt_dismiss",function(){e.hide()}),c.WebEventBus.on("trigger_show_prompt",function(){return s(e,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return(e=!this.element.classList.contains("pushly-prompt-visible"))?[4,this.environmentService.isUserPromptEligible()]:[3,2];case 1:e=t.sent(),t.label=2;case 2:return e&&(this.loggingService.info("Prompt manually triggered"),this.attemptToShow(!0)),[2]}})})})},BellComponent.prototype.init=function(t,r){return void 0===r&&(r=document.body),s(this,void 0,void 0,function(){var n,i;return a(this,function(o){switch(o.label){case 0:return[4,e.prototype.init.call(this,t,r)];case 1:return o.sent(),this.initialized&&(n='\n            <svg viewBox="0 0 512 512">\n                <circle fill="'+this.buildOptions.theme.primary_color+'" cx="256" cy="256" r="255.059"/>\n                <path fill="'+this.buildOptions.theme.accent_color+'" d="M256,46.349C140.398,46.349,46.349,140.398,46.349,256c0,115.603,94.049,209.651,209.651,209.651\n                    c115.603,0,209.651-94.049,209.651-209.651C465.651,140.398,371.603,46.349,256,46.349z M256,450.411\n                    c-107.198,0-194.41-87.213-194.41-194.411c0-107.198,87.212-194.41,194.41-194.41c107.198,0,194.411,87.212,194.411,194.41\n                    C450.411,363.198,363.198,450.411,256,450.411z"/>\n                <g>\n                    <path fill="'+this.buildOptions.theme.accent_color+'" d="M341.024,293.378v-58.851c0-41.452-28.823-76.096-67.492-85.197c-0.235-10.897-9.101-19.647-20.033-19.647\n                        c-10.941,0-19.847,8.789-20.076,19.647c-38.669,9.101-67.495,43.745-67.495,85.197v58.851c-14.569,0-26.369,11.797-26.369,26.365\n                        v18.603h227.829v-18.603C367.389,305.175,355.596,293.378,341.024,293.378z"/>\n                    <path fill="'+this.buildOptions.theme.accent_color+'" d="M253.5,381.699c17.454,0,32.062-11.757,36.661-27.781h-73.376C221.393,369.942,236,381.699,253.5,381.699z"\n                        />\n                </g>\n            </svg>\n            <div class="pushly_bell-tooltip-container">\n                <div class="pushly_bell-tooltip pushly_bell-tooltip-subscribed" '+(this.buildOptions.theme.tooltip.subscribed?"":'style="display: none;"')+'>\n                    <div class="pushly_bell-tooltip-arrow" style="background-color: '+this.buildOptions.theme.primary_color+';"></div>\n                    <div class="pushly_bell-tooltip-text" style="background-color: '+this.buildOptions.theme.primary_color+"; color: "+this.buildOptions.theme.accent_color+';">'+this.buildOptions.theme.tooltip.subscribed+'</div>\n                </div>\n                <div class="pushly_bell-tooltip pushly_bell-tooltip-notsubscribed" '+(this.buildOptions.theme.tooltip.unsubscribed?"":'style="display: none;"')+'>\n                    <div class="pushly_bell-tooltip-arrow" style="background-color: '+this.buildOptions.theme.primary_color+';"></div>\n                    <div class="pushly_bell-tooltip-text" style="background-color: '+this.buildOptions.theme.primary_color+"; color: "+this.buildOptions.theme.accent_color+';">'+this.buildOptions.theme.tooltip.unsubscribed+"</div>\n                </div>\n            </div>\n        ",(i=this.element=document.createElement("div")).classList.add("pushly_bell",this.subscribed?"subscribed":"not-subscribed",this.buildOptions.managed?"managed":"not-managed"),i.classList.add(v[this.buildOptions.theme.position.desktop],_[this.buildOptions.theme.position.mobile]),i.innerHTML=n,this.svg=i.getElementsByTagName("svg")[0],this.parent.appendChild(this.element),this.updateSize(),this.wireEvents()),[2]}})})},BellComponent.prototype.updateSize=function(){var e=this.buildOptions.theme.size;window.innerWidth<p.MOBILE_MAX_SIZE&&this.buildOptions.theme.mobile_size&&(e=this.buildOptions.theme.mobile_size),this.svg.setAttribute("width",e+"px"),this.svg.setAttribute("height",e+"px")},BellComponent.prototype.run=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return this.subscribed&&this.buildOptions.behavior.display_behavior===d.BellDisplayBehavior.PreSubscription||!this.subscribed&&this.buildOptions.behavior.display_behavior===d.BellDisplayBehavior.PostSubscription?[2]:(this.attemptToShow(),[2])})})},BellComponent.prototype.attemptToShow=function(e){return void 0===e&&(e=!1),s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),this.promptSettings.is_auto_show||e?[4,this.checkRunConditions()]:[3,2];case 1:r.sent(),this.show(),r.label=2;case 2:return[3,4];case 3:return t=r.sent(),this.loggingService.error(t),[3,4];case 4:return[2]}})})},BellComponent=i([l.inject(),o("design:paramtypes",[h.AppContext,u.LoggingService,u.EnvironmentService,u.CookieService,u.EventsService,u.DbService,u.RegistrationService,u.SessionService])],BellComponent)}(f.DomPromptComponent);t.BellComponent=g},"./src/sdk/components/custom-prompt.component.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/web-event-bus.ts"),u=r("./src/sdk/services/index.ts"),l=r("./src/sdk/components/dom-prompt-component.ts"),p=r("./src/sdk/models/index.ts"),d=r("./src/sdk/decorators/index.ts"),f=r("./src/sdk/constants.ts"),h=function(e){function CustomPromptComponent(t,r,n,i,o,s,a,c){return e.call(this,t,r,n,i,o,s,a,c)||this}return n(CustomPromptComponent,e),CustomPromptComponent.prototype.locateAndAssignElement=function(){var e=this,t=setInterval(function(){var r=e.parent.getElementsByClassName(f.DEFAULT_CLASSNAME_PROMPT_CUSTOM);r&&r.length>0&&(clearInterval(t),e.element=r[0],e.resolveKeywords(),e.assignButtonElements())},500)},CustomPromptComponent.prototype.assignButtonElements=function(){var e=this.element.getElementsByClassName(f.DEFAULT_CLASSNAME_PROMPT_BTN_ALLOW),t=this.element.getElementsByClassName(f.DEFAULT_CLASSNAME_PROMPT_BTN_DISMISS);e&&e.length>0?(this.allowButton=e[0],this.allowButton.addEventListener("click",this.allow.bind(this))):this.loggingService.warn("Prompt allow button cannot be located"),t&&t.length>0?(this.dismissButton=t[0],this.dismissButton.addEventListener("click",this.dismiss.bind(this))):this.loggingService.warn("Prompt dismiss button cannot be located"),this.wireEvents()},CustomPromptComponent.prototype.wireEvents=function(){var e=this;c.WebEventBus.on("prompt_allow",function(){}),c.WebEventBus.on("permission_allowed,subscribed,migrated,followed,proxy_response_subscribed,proxy_response_permission_allowed",function(){e.setPromptCompositeSubscribedClassnames(),e.hide()}),c.WebEventBus.on("prompt_dismiss,permission_denied,permission_dismissed,proxy_response_permission_dismissed,proxy_response_permission_denied",function(){e.setSubscriptionDeniedClassnames(),e.hide()}),c.WebEventBus.on("trigger_show_prompt",function(){return s(e,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return(e=!this.element.classList.contains(f.DEFAULT_CLASSNAME_PROMPT_VISIBLE))?[4,this.environmentService.isUserPromptEligible()]:[3,2];case 1:e=t.sent(),t.label=2;case 2:return e&&(this.loggingService.info("Prompt manually triggered"),this.attemptToShow(!0)),[2]}})})}),this._run()},CustomPromptComponent.prototype.init=function(t,r){return void 0===r&&(r=document.body),s(this,void 0,void 0,function(){return a(this,function(n){switch(n.label){case 0:return[4,e.prototype.init.call(this,t,r)];case 1:return n.sent(),this.loggingService.info("Using custom prompt provided by publisher"),[2]}})})},CustomPromptComponent.prototype.run=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return this.locateAndAssignElement(),[2]})})},CustomPromptComponent.prototype._run=function(){return s(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return this.loggingService.info("Custom prompt ready"),[4,this.isCustomPromptEligible()];case 1:return e.sent()?(this.setPromptEligibleClassname(),c.WebEventBus.dispatch("prompt_eligible",this.buildEventPack()),this.attemptToShow()):(this.setPromptIneligibleClassname(),c.WebEventBus.dispatch("prompt_ineligible",this.buildEventPack())),[2]}})})},CustomPromptComponent.prototype.attemptToShow=function(e){return void 0===e&&(e=!1),s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),this.promptSettings.is_auto_show||e?[4,this.checkRunConditions()]:[3,2];case 1:r.sent(),this.show(),r.label=2;case 2:return[3,4];case 3:return t=r.sent(),this.loggingService.error(t),[3,4];case 4:return[2]}})})},CustomPromptComponent=i([d.inject(),o("design:paramtypes",[p.AppContext,u.LoggingService,u.EnvironmentService,u.CookieService,u.EventsService,u.DbService,u.RegistrationService,u.SessionService])],CustomPromptComponent)}(l.DomPromptComponent);t.CustomPromptComponent=h},"./src/sdk/components/dom-prompt-component.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var s=r("./src/sdk/web-event-bus.ts"),a=r("./src/sdk/components/base-prompt.component.ts"),c=r("./src/sdk/enums/index.ts"),u=r("./src/sdk/utils/index.ts"),l=r("./src/sdk/constants.ts"),p=r("./src/sdk/services/crypto.service.ts"),d=function(e){function DomPromptComponent(t,r,n,i,o,s,a,c){return e.call(this,t,r,n,i,o,s,a,c)||this}return n(DomPromptComponent,e),DomPromptComponent.prototype.show=function(){return i(this,void 0,void 0,function(){var e,t=this;return o(this,function(r){this.loggingService.once().info("Showing prompt"),this.incrementUserPromptCount();try{e={prompt_id:this.promptSettings.id,subscribed:this.subscribed},this.hasKeywords()&&(e.keywords=this.keywords),this.element?(this.subscribed||this.eventsService.putEvent({action:c.EventAction.PromptShown,meta:e}),setTimeout(function(){t.element.classList.add(l.DEFAULT_CLASSNAME_PROMPT_VISIBLE),s.WebEventBus.dispatch("prompt_show"),s.WebEventBus.dispatch("prompt_shown",t.buildEventPack())},100)):this.loggingService.error("The prompt component should be initialized before show is called. DomPromptComponent::init(promptSettings: PromptSettings)")}catch(e){this.loggingService.error(e)}return[2]})})},DomPromptComponent.prototype.hide=function(){return i(this,void 0,void 0,function(){return o(this,function(e){return this.loggingService.once().info("Hiding prompt"),this.element.classList.remove(l.DEFAULT_CLASSNAME_PROMPT_VISIBLE),s.WebEventBus.dispatch("prompt_hide",this.promptSettings),[2]})})},DomPromptComponent.prototype.isCustomPromptEligible=function(){return i(this,void 0,void 0,function(){var e,t,r;return o(this,function(n){switch(n.label){case 0:return[4,this.environmentService.isUserCustomPromptEligible()];case 1:return e=n.sent(),[4,this.checkForSubscriberKeywords(this.keywords)];case 2:return t=n.sent(),r=this.subscribed&&t,[2,e&&!r]}})})},DomPromptComponent.prototype.buildEventPack=function(){return{prompt:{id:this.promptSettings.id,style:this.promptSettings.style},keywords:this.keywords||[],subscribed:this.subscribed}},DomPromptComponent.prototype.allow=function(e){return i(this,void 0,void 0,function(){var e,t,r,n,i,a,p,d,f=this;return o(this,function(o){switch(o.label){case 0:if(this.subscribed?s.WebEventBus.dispatch("followed",this.buildEventPack()):(s.WebEventBus.dispatch("prompt_allow"),s.WebEventBus.dispatch("prompt_allowed",this.buildEventPack())),e={prompt_id:this.promptSettings.id,subscribed:this.subscribed},this.hasKeywords()&&(e.keywords=this.keywords,this.registrationService.registerAllowedKeywords(this.keywords)),this.subscribed)return this.hasKeywords()&&this.eventsService.putEvent({action:c.EventAction.Follow,meta:e}),[2];if(this.eventsService.putEvent({action:c.EventAction.PromptAllow,meta:e}),!this.appContext.settings.domain.custom_allow_domain)return[3,1];for(a in t="https://"+this.appContext.settings.domain.custom_allow_domain+"/"+this.appContext.domainKey,(r=document.createElement("a")).href=t,(n=u.parseQueryString(r.search))[l.PUSHLY_SUBSCRIBED_URL_QS]=encodeURIComponent(window.location.toString()),n[l.PUSHLY_UNIQUE_USER_ID_QS]=this.appContext.uniqueUserId,n[l.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_QS]=this.appContext.uniqueUserFirstAppearance,n[l.PUSHLY_DOMAIN_KEY_QS]=this.appContext.domainKey,n[l.PUSHLY_PROMPT_ID_QS]=this.promptSettings.id,i=[],n)i.push(a+"="+n[a]);return t=r.protocol+"//"+r.host+r.pathname+"?"+i.join("&"),(p=window.open(t,"Push Notification Registration","directories=0,toolbar=0,status=0,menubar=0,width=680,height=550"))?(this.loggingService.info("Allow notification window successfully opened"),this.eventsService.putEvent({action:c.EventAction.ProxyWindowOpened,meta:{prompt_id:this.promptSettings.id}}),d=window.setInterval(function(){p.closed&&(clearInterval(d),f.eventsService.putEvent({action:c.EventAction.ProxyWindowClosed,meta:{prompt_id:f.promptSettings.id}}))},1e3)):(this.loggingService.warn("Allow notification window blocked"),this.eventsService.putEvent({action:c.EventAction.ProxyWindowBlocked,meta:{prompt_id:this.promptSettings.id}})),[3,3];case 1:return[4,this.registrationService.tryRegistration(this.promptSettings,this.keywords)];case 2:o.sent(),o.label=3;case 3:return[2]}})})},DomPromptComponent.prototype.dismiss=function(e){return i(this,void 0,void 0,function(){var e,t,r;return o(this,function(n){return s.WebEventBus.dispatch(c.EventAction.PromptDismiss,this.promptSettings),s.WebEventBus.dispatch("prompt_dismissed",this.buildEventPack()),e=l.PUSHLY_PROMPT_DISMISSED_COOKIE_TIMEOUT,t="d","cookie_length_seconds"in(this.promptSettings.config.behavior||{})&&void 0!==(r=this.promptSettings.config.behavior.cookie_length_seconds)&&null!==r&&(e=r,t="s"),this.environmentService.setDismissed(!0,e,t),this.cookieService.setCookie(l.PUSHLY_PROMPT_DISMISSED_COOKIE,!0,e,t),this.eventsService.putEvent({action:c.EventAction.PromptDismiss,meta:{prompt_id:this.promptSettings.id}}),this.hide(),[2]})})},DomPromptComponent.prototype.setPromptEligibleClassname=function(){var e=this.appContext.classNames.promptEligible||l.DEFAULT_CLASSNAME_PROMPT_ELIGIBLE;this.element.classList.add(e)},DomPromptComponent.prototype.setPromptIneligibleClassname=function(){var e=this.appContext.classNames.promptIneligible||l.DEFAULT_CLASSNAME_PROMPT_INELIGIBLE;this.element.classList.add(e)},DomPromptComponent.prototype.setPromptCompositeSubscribedClassnames=function(){var e=this.appContext.classNames.promptEligible||l.DEFAULT_CLASSNAME_PROMPT_ELIGIBLE,t=this.appContext.classNames.subscriptionNone||l.DEFAULT_CLASSNAME_SUBSCRIPTION_NONE,r=this.appContext.classNames.promptIneligible||l.DEFAULT_CLASSNAME_PROMPT_INELIGIBLE,n=this.appContext.classNames.subscriptionSubscribed||l.DEFAULT_CLASSNAME_SUBSCRIPTION_TRUE;this.element.classList.replace(t,n),this.element.classList.replace(e,r)},DomPromptComponent.prototype.setSubscriptionDeniedClassnames=function(){var e=this.appContext.classNames.promptEligible||l.DEFAULT_CLASSNAME_PROMPT_ELIGIBLE,t=this.appContext.classNames.subscriptionNone||l.DEFAULT_CLASSNAME_SUBSCRIPTION_NONE,r=this.appContext.classNames.subscriptionDenied||l.DEFAULT_CLASSNAME_SUBSCRIPTION_DENIED;this.element.classList.replace(t,r),this.element.classList.remove(e)},DomPromptComponent.prototype.hasKeywords=function(){return this.keywords&&Array.isArray(this.keywords)&&this.keywords.length>0},DomPromptComponent.prototype.resolveKeywords=function(){try{if(this.element){var e=(this.element.dataset||{}).keywords||"";if(""!==e.trim()){var t=e.toString().split(",");if(Array.isArray(t)&&t.length>0){var r=t.map(function(e){return e.toString().trim()});this.keywords=Array.from(new Set(r)).slice()}}}}catch(e){this.loggingService.warn("Could not resolve prompt keywords - "+e.message)}},DomPromptComponent.prototype.checkForSubscriberKeywords=function(e){return void 0===e&&(e=[]),i(this,void 0,void 0,function(){var t,r,n;return o(this,function(i){switch(i.label){case 0:t=!0,i.label=1;case 1:return i.trys.push([1,5,6,7]),e&&e.length>0?[4,this.dbService.getConnection()]:[3,4];case 2:return[4,(r=i.sent()).get(l.PUSHLY_DB_LOCAL_PROFILE_DOCUMENT_KEY)];case 3:(n=i.sent())&&Array.isArray(n.tags)&&0!==n.tags.length?e.some(function(e){var r=p.MD5(e);if(-1===n.tags.indexOf(r))return t=!1,!0}):t=!1,i.label=4;case 4:return[3,7];case 5:return i.sent(),this.loggingService.warn("Unable to determine if subscriber already has specified keywords"),t=!1,[3,7];case 6:return r&&r.close(),[7];case 7:return[2,t]}})})},DomPromptComponent}(a.BasePromptComponent);t.DomPromptComponent=d},"./src/sdk/components/index.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/components/base-prompt.component.ts");t.BasePromptComponent=n.BasePromptComponent;var i=r("./src/sdk/components/slide-prompt.component.ts");t.SlidePromptComponent=i.SlidePromptComponent;var o=r("./src/sdk/components/bell.component.ts");t.BellComponent=o.BellComponent;var s=r("./src/sdk/components/native-prompt.component.ts");t.NativePromptComponent=s.NativePromptComponent;var a=r("./src/sdk/components/custom-prompt.component.ts");t.CustomPromptComponent=a.CustomPromptComponent},"./src/sdk/components/native-prompt.component.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/components/base-prompt.component.ts"),u=r("./src/sdk/services/index.ts"),l=r("./src/sdk/services/registration-service.ts"),p=r("./src/sdk/models/index.ts"),d=r("./src/sdk/enums/index.ts"),f=r("./src/sdk/decorators/index.ts"),h=r("./src/sdk/web-event-bus.ts"),v=function(e){function NativePromptComponent(t,r,n,i,o,s,a,c){return e.call(this,t,r,n,i,o,s,a,c)||this}return n(NativePromptComponent,e),NativePromptComponent.prototype.wireEvents=function(){var e=this;h.WebEventBus.on("trigger_show_prompt",function(){return s(e,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return[4,this.isUserPromptEligible()];case 1:return e.sent()&&(this.loggingService.info("Prompt manually triggered"),this.attemptToShow(!0)),[2]}})})})},NativePromptComponent.prototype.init=function(t,r){return void 0===r&&(r=null),s(this,void 0,void 0,function(){return a(this,function(n){switch(n.label){case 0:return[4,e.prototype.init.call(this,t,r)];case 1:return n.sent(),[2]}})})},NativePromptComponent.prototype.allow=function(e){this.loggingService.warn("The NativePromptComponent cannot programatically allow")},NativePromptComponent.prototype.dismiss=function(e){this.loggingService.warn("The NativePromptComponent cannot programatically dismiss")},NativePromptComponent.prototype.hide=function(){this.loggingService.warn("The NativePromptComponent cannot programatically hide")},NativePromptComponent.prototype.show=function(){this.registrationService.tryRegistration(this.promptSettings)},NativePromptComponent.prototype.run=function(){return s(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return this.environmentService.getRuntimeEnvironmentType()===d.RuntimeEnvironmentType.Direct&&this.environmentService.isUsingProxyIntegration()?(this.loggingService.error("Pushly was configured to use both a proxy integration and native prompt."),[3,3]):[3,1];case 1:return[4,this.isUserPromptEligible()];case 2:e.sent()&&this.attemptToShow(),e.label=3;case 3:return[2]}})})},NativePromptComponent.prototype.attemptToShow=function(e){return void 0===e&&(e=!1),s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),this.promptSettings.is_auto_show||e?[4,this.checkRunConditions()]:[3,2];case 1:r.sent(),this.incrementUserPromptCount(),this.show(),r.label=2;case 2:return[3,4];case 3:return t=r.sent(),this.loggingService.error(t),[3,4];case 4:return[2]}})})},NativePromptComponent=i([f.inject(),o("design:paramtypes",[p.AppContext,u.LoggingService,u.EnvironmentService,u.CookieService,u.EventsService,u.DbService,l.RegistrationService,u.SessionService])],NativePromptComponent)}(c.BasePromptComponent);t.NativePromptComponent=v},"./src/sdk/components/slide-prompt.component.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/web-event-bus.ts"),u=r("./src/sdk/services/index.ts"),l=r("./src/sdk/components/dom-prompt-component.ts"),p=r("./src/sdk/models/index.ts"),d=r("./src/sdk/decorators/index.ts"),f={top:"d-top",bottom:"d-bottom",disabled:"d-disabled"},h={top:"m-top",bottom:"m-bottom",disabled:"m-disabled"},v=function(e){function SlidePromptComponent(t,r,n,i,o,s,a,c){return e.call(this,t,r,n,i,o,s,a,c)||this}return n(SlidePromptComponent,e),SlidePromptComponent.prototype.wireEvents=function(){var e=this;this.allowButton.addEventListener("click",this.allow.bind(this)),this.dismissButton.addEventListener("click",this.dismiss.bind(this)),c.WebEventBus.on("subscribed,permission_prompted,proxy_subscribed,migrated,prompt_dismiss,prompt_allow,permission_denied",function(){e.parent&&e.hide()}),c.WebEventBus.on("trigger_show_prompt",function(){return s(e,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return(e=!this.element.classList.contains("pushly-prompt-visible"))?[4,this.isUserPromptEligible()]:[3,2];case 1:e=t.sent(),t.label=2;case 2:return e&&(this.loggingService.info("Prompt manually triggered"),this.attemptToShow(!0)),[2]}})})})},SlidePromptComponent.prototype.init=function(t,r){return void 0===r&&(r=document.body),s(this,void 0,void 0,function(){var n,i;return a(this,function(o){switch(o.label){case 0:return[4,e.prototype.init.call(this,t,r)];case 1:return o.sent(),this.initialized&&(n='\n            <div class="pushly_popover-box" style="background-color: '+this.buildOptions.theme.background_color+';">\n                <div class="pushly_popover-first" '+(this.buildOptions.theme.image?"":'style="display: none;"')+'>\n                    <img src="'+this.buildOptions.theme.image+'" />\n                </div>\n\n                <div class="pushly_popover-second">\n                    <div class="pushly_popover-message">\n                        <div class="pushly_popover-message-headline" style="color: '+this.buildOptions.theme.title.text_color+';">'+this.buildOptions.theme.title.text+'</div>\n                        <div class="pushly_popover-message-subheadline" style="color: '+this.buildOptions.theme.subtitle.text_color+';">'+this.buildOptions.theme.subtitle.text+'</div>\n                    </div>\n\n                    <div class="pushly_popover-buttons">\n                        <button class="pushly_popover-buttons-dismiss" style="color: '+this.buildOptions.theme.dismiss_button.text_color+"; background-color: "+this.buildOptions.theme.dismiss_button.background_color+';">'+this.buildOptions.theme.dismiss_button.text+'</button>\n                        <button class="pushly_popover-buttons-allow" style="color: '+this.buildOptions.theme.allow_button.text_color+"; background-color: "+this.buildOptions.theme.allow_button.background_color+'">'+this.buildOptions.theme.allow_button.text+"</button>\n                    </div>\n                </div>\n            </div>\n        ",(i=this.element=document.createElement("div")).classList.add("pushly_popover",this.buildOptions.theme.layout||"normal",this.buildOptions.managed?"managed":"non-managed"),i.classList.add(f[this.buildOptions.theme.position.desktop],h[this.buildOptions.theme.position.mobile]),i.innerHTML=n,this.allowButton=i.getElementsByClassName("pushly_popover-buttons-allow")[0],this.dismissButton=i.getElementsByClassName("pushly_popover-buttons-dismiss")[0],this.parent.appendChild(this.element),this.wireEvents()),[2]}})})},SlidePromptComponent.prototype.run=function(){return s(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return[4,this.isUserPromptEligible()];case 1:return e.sent()&&this.attemptToShow(),[2]}})})},SlidePromptComponent.prototype.attemptToShow=function(e){return void 0===e&&(e=!1),s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),this.promptSettings.is_auto_show||e?[4,this.checkRunConditions()]:[3,2];case 1:r.sent(),this.show(),r.label=2;case 2:return[3,4];case 3:return t=r.sent(),this.loggingService.error(t),[3,4];case 4:return[2]}})})},SlidePromptComponent=i([d.inject(),o("design:paramtypes",[p.AppContext,u.LoggingService,u.EnvironmentService,u.CookieService,u.EventsService,u.DbService,u.RegistrationService,u.SessionService])],SlidePromptComponent)}(l.DomPromptComponent);t.SlidePromptComponent=v},"./src/sdk/constants.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PUSHLY_SDK_APPLICATION_NAME="pushly-sdk",t.PUSHLY_SW_APPLICATION_NAME="pushly-sw",t.PUSHLY_DB_APPLIATION_VERSION="application_version",t.PUSHLY_DB_UNIQUE_USER_ID_KEY="unique_user_id",t.PUSHLY_UNIQUE_USER_ID_QS="pushly_unique_user_id",t.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_QS="pushly_unique_user_first_appearance",t.PUSHLY_DB_UNIQUE_USER_FIRST_APPEARANCE_KEY="unique_user_first_appearance",t.PUSHLY_DB_FCM_SUBSCRIPTION_ID_KEY="fcm_subscription_id",t.PUSHLY_SUBSCRIBER_DATA_UPDATED_AT_KEY="pushly_subscriber_data_updated_at",t.PUSHLY_DEFAULT_COOKIE_TIMEOUT=7,t.PUSHLY_FCM_TOKEN_COOKIE="pushly_fcm_token",t.PUSHLY_UNIQUE_USER_ID_COOKIE="pushly_uqid",t.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_COOKIE="pushly_uqid_timestamp",t.PUSHLY_USER_PROMPT_COUNT_COOKIE="pushly_user_prompt_count",t.PUSHLY_USER_PROMPT_FREQ_COOKIE="pushly_user_prompt_frequency",t.PUSHLY_PROMPT_DISMISSED_COOKIE="pushly_prompt_dismissed",t.PUSHLY_PROMPT_DISMISSED_COOKIE_TIMEOUT=7,t.PUSHLY_PROMPT_SUBSCRIBED_COOKIE="pushly_subscribed",t.PUSHLY_PROMPT_SUBSCRIBED_COOKIE_TIMEOUT=1825,t.PUSHLY_PROMPT_BLOCKED_COOKIE="pushly_prompt_blocked",t.PUSHLY_VISIBLE_LOGS_COOKIE="pushly_view_logs",t.PUSHLY_DOMAIN_KEY_QS="pushly_domain_key",t.PUSHLY_SUBSCRIBED_URL_QS="pushly_subscribed_url",t.PUSHLY_PROMPT_ID_QS="pushly_prompt_id",t.PUSHLY_DB_DOMAIN_ID="domain_id",t.PUSHLY_DB_NAME="pushly_db",t.PUSHLY_STORE_NAME="pushly_store",t.PUSHLY_DB_MIGRATED_KEY="migrated",t.PUSHLY_SETTINGS_CACHED_COOKIE="pushly_settings_cached",t.PUSHLY_SETTINGS_CACHED_COOKIE_TIMEOUT=1/24/12,t.PUSHLY_DB_SETTINGS_KEY="pushly_settings",t.EVENTS_DEBOUNCE_TIME=500,t.PROFILE_DEBOUNCE_TIME=500,t.PUSHLY_DB_OPTED_OUT_KEY="opted_out",t.PUSHLY_UNSUBSCRIBED_COOKIE="pushly_unsubscribed",t.ENV_NAME_LOCAL="local",t.ENV_NAME_LOCAL_PRODUCTION="local-production",t.ENV_NAME_DEV="dev",t.ENV_NAME_STAGING="staging",t.ENV_NAME_PRODUCTION="production",t.MOBILE_MAX_SIZE=768,t.PUSHLY_DB_LOCAL_PROFILE_DOCUMENT_KEY="local_profile_document",t.EVENT_JITTER_MAX_MILLISECONDS=7e3,t.FCM_DB_NAME="fcm_token_details_db",t.FCM_DB_STORE_NAME="fcm_token_object_Store",t.FCM_DB_FCM_TOKEN_KEY="fcmToken",t.DEFAULT_CLASSNAME_WEB_PUSH_UNSUPPORTED="pushly-web-push-unsupported",t.DEFAULT_CLASSNAME_WEB_PUSH_SUPPORTED="pushly-web-push-supported",t.DEFAULT_CLASSNAME_SUBSCRIPTION_NONE="pushly-subscription-none",t.DEFAULT_CLASSNAME_SUBSCRIPTION_TRUE="pushly-subscription-subscribed",t.DEFAULT_CLASSNAME_SUBSCRIPTION_FALSE="pushly-subscription-unsubscribed",t.DEFAULT_CLASSNAME_SUBSCRIPTION_DENIED="pushly-subscription-denied",t.DEFAULT_CLASSNAME_PROMPT_INELIGIBLE="pushly-prompt-ineligible",t.DEFAULT_CLASSNAME_PROMPT_ELIGIBLE="pushly-prompt-eligible",t.DEFAULT_CLASSNAME_PROMPT_VISIBLE="pushly-prompt-visible",t.DEFAULT_CLASSNAME_PROMPT_CUSTOM="pushly-prompt-custom",t.DEFAULT_CLASSNAME_PROMPT_BTN_ALLOW="pushly-prompt-buttons-allow",t.DEFAULT_CLASSNAME_PROMPT_BTN_DISMISS="pushly-prompt-buttons-dismiss"},"./src/sdk/decorators/index.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/decorators/inject.ts");t.inject=n.inject},"./src/sdk/decorators/inject.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inject=function inject(){return function(e){}}},"./src/sdk/enums/actor-type.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Visitor="visitor"}(t.ActorType||(t.ActorType={}))},"./src/sdk/enums/amp-message-topics.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.ConnectHandshake="topic-connect-handshake",e.NotificationPermissionState="topic-notification-permission-state",e.ServiceWorkerState="topic-service-worker-state",e.ServiceWorkerRegistration="topic-service-worker-registration",e.ServiceWorkerQuery="topic-service-worker-query",e.StorageGet="topic-storage-get"}(t.AmpMessageTopics||(t.AmpMessageTopics={}))},"./src/sdk/enums/amp-service-worker-message-topics.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.AmpSubscriptionState="amp-web-push-subscription-state",e.AmpSubscribe="amp-web-push-subscribe",e.AmpUnsubscribe="amp-web-push-unsubscribe"}(t.AmpServiceWorkerMessageTopics||(t.AmpServiceWorkerMessageTopics={}))},"./src/sdk/enums/bell-display-behavior.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Always="ALWAYS",e.PreSubscription="PRE_SUBSCRIPTION",e.PostSubscription="POST_SUBSCRIPTION"}(t.BellDisplayBehavior||(t.BellDisplayBehavior={}))},"./src/sdk/enums/entity-type.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Notification="notification",e.Prompt="prompt"}(t.EntityType||(t.EntityType={}))},"./src/sdk/enums/event-action.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.NotificationImpression="notification_impression",e.NotificationClick="notification_click",e.PromptShown="prompt_shown",e.PromptAllow="prompt_allow",e.Follow="follow",e.PromptDismiss="prompt_dismiss",e.PermissionAccepted="permission_accepted",e.PermissionDenied="permission_denied",e.PermissionDismissed="permission_dismissed",e.PermissionPrompted="permission_prompted",e.SettingsLoadFailed="settings_load_failed",e.Subscribed="subscribed",e.Migrated="migrated",e.ViewPage="view_page",e.Unsubscribed="unsubscribed",e.Error="error",e.ProxyWindowBlocked="proxy_window_blocked",e.ProxyWindowOpened="proxy_window_opened",e.ProxyWindowClosed="proxy_window_closed",e.SubscriptionChange="subscription_changed",e.TokenRefresh="token_refreshed"}(t.EventAction||(t.EventAction={}))},"./src/sdk/enums/index.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/enums/runtime-environment-type.enum.ts");t.RuntimeEnvironmentType=n.RuntimeEnvironmentType;var i=r("./src/sdk/enums/prompt-style.enum.ts");t.PromptStyle=i.PromptStyle;var o=r("./src/sdk/enums/actor-type.enum.ts");t.ActorType=o.ActorType;var s=r("./src/sdk/enums/entity-type.enum.ts");t.EntityType=s.EntityType;var a=r("./src/sdk/enums/event-action.enum.ts");t.EventAction=a.EventAction;var c=r("./src/sdk/enums/bell-display-behavior.enum.ts");t.BellDisplayBehavior=c.BellDisplayBehavior;var u=r("./src/sdk/enums/amp-message-topics.enum.ts");t.AmpMessageTopics=u.AmpMessageTopics;var l=r("./src/sdk/enums/amp-service-worker-message-topics.enum.ts");t.AmpServiceWorkerMessageTopics=l.AmpServiceWorkerMessageTopics},"./src/sdk/enums/prompt-style.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Native="NATIVE",e.Custom="PUBLISHER_CUSTOM",e.Slide="SLIDE",e.Bell="BELL"}(t.PromptStyle||(t.PromptStyle={}))},"./src/sdk/enums/runtime-environment-type.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Direct=1]="Direct",e[e.Proxy=2]="Proxy",e[e.ServiceWorker=3]="ServiceWorker",e[e.ProxyDialog=4]="ProxyDialog",e[e.AmpPermissionDialog=5]="AmpPermissionDialog",e[e.AmpHelperFrame=6]="AmpHelperFrame",e[e.ProxyFrameHelper=7]="ProxyFrameHelper"}(t.RuntimeEnvironmentType||(t.RuntimeEnvironmentType={}))},"./src/sdk/enums/sdk-error.enum.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.PUSH_SERVICE_NOT_AVAILABLE=20]="PUSH_SERVICE_NOT_AVAILABLE",e.FIREBASE_DUPLICATE_APP="app/duplicate-app",e.FCM_NOTIFICATIONS_BLOCKED="messaging/notifications-blocked",e.FCM_NOTIFICATIONS_DEFAULT="messaging/notifications-default",e.FCM_FAILED_SERVICE_WORKER_REGISTRATION="messaging/failed-serviceworker-registration",e.FCM_SUBSCRIPTION_FAILED="messaging/token-subscribe-failed",e.FCM_TOKEN_UPDATE_FAILED="messaging/token-update-failed",e.FCM_DELETE_TOKEN_FAILED="messaging/delete-token-not-found"}(t.SdkError||(t.SdkError={}))},"./src/sdk/event-manager.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/utils/index.ts"),i=function(){function EventManager(){this.listeners={}}return EventManager.prototype.on=function(e,t){for(var r=[],i=0,o=e.split(",");i<o.length;i++){var s=o[i];s=s.trim();var a=n.randomString(),c=s.split(".");c&&2===c.length&&(s=c[0],a=c[1]),this.listeners[s]=this.listeners[s]||{},this.listeners[s][a]=t,r.push(this.unregisterCallback(s,a))}return r},EventManager.prototype.once=function(e,t){var r=this;e.split(",").forEach(function(e){var n,i=e.trim();n=r.on(i,function(e){null!=e?t(e):t(),n()})[0]})},EventManager.prototype.dispatch=function(e,t){void 0===t&&(t=null);var r=this.listeners[e]||{};Object.keys(r).forEach(function(e){var n=r[e];null!=t?n(t):n()})},EventManager.prototype.unregisterCallback=function(e,t){var r=this;return function(){r.listeners[e][t]&&delete r.listeners[e][t]}},EventManager}();t.EventManager=i},"./src/sdk/index.ts":function(e,t,r){"use strict";function __export(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/pushly-sdk.ts");t.PushlySDK=n.PushlySDK;var i=r("./src/sdk/event-manager.ts");t.EventManager=i.EventManager;var o=r("./src/sdk/web-event-bus.ts");t.WebEventBus=o.WebEventBus,__export(r("./src/sdk/services/index.ts")),__export(r("./src/sdk/components/index.ts")),__export(r("./src/sdk/decorators/index.ts")),__export(r("./src/sdk/enums/index.ts")),__export(r("./src/sdk/models/index.ts"))},"./src/sdk/models/app-context.model.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function AppContext(){this.version="bf1d6794b4e27ed2c53b215b2fa7aace95e4cdb7",this.disabled=!1,this.subscriptionTokenRegistered=!1,this.firebaseAppInitialized=!1,this.classNames={},this.visibleLogsEnabled=!1}}();t.AppContext=n},"./src/sdk/models/db-connection.model.ts":function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function DbConnection(e,t,r){this.dbName=e,this.objectStoreName=t,this.loggingService=r}return DbConnection.prototype.connect=function(){var e=this;return new Promise(function(t,r){e.loggingService.once().info("opening db connection"),e.openRequest=indexedDB.open(e.dbName),e.openRequest.onerror=function(t){e.loggingService.error("db connection error",e.openRequest.error,e.openRequest.errorCode),r(t)},e.openRequest.onsuccess=function(n){var i=n.target.result;i.objectStoreNames.contains(e.objectStoreName)?(e.loggingService.once().info("db connection success"),e.db=n.target.result,t()):(i.close(),e.deleteDb().then(function(){return e.loggingService.info("reestablishing db connection"),e.connect()}).then(function(){return t()}).catch(function(){e.loggingService.error("db connection error",e.openRequest.error,e.openRequest.errorCode),r()}))},e.openRequest.onupgradeneeded=function(t){e.loggingService.info("db upgrade needed");var r=t.target;r.result.oldversion||r.result.createObjectStore(e.objectStoreName,{keyPath:"env"})}})},DbConnection.prototype.deleteDb=function(){return n(this,void 0,void 0,function(){var e=this;return i(this,function(t){return this.loggingService.info("db restore requested"),[2,new Promise(function(t,r){var n=indexedDB.deleteDatabase(e.dbName);e.loggingService.info("executing db restore"),n.onsuccess=function(){e.loggingService.info("db restore successful"),t()},n.onblocked=function(t){e.loggingService.info("db restore blocked"),r(new Error(t.target.error))},n.onerror=function(t){e.loggingService.warn("db restore failed"),r(new Error(t.target.error))}})]})})},DbConnection.prototype.get=function(e,t,r){return void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=!1),n(this,void 0,void 0,function(){var n=this;return i(this,function(i){return r||this.loggingService.info("Getting indexeddb key: "+(null!==e?e:"[full row]")),[2,new Promise(function(r,i){var o=n.db.transaction(n.objectStoreName,"readonly"),s=o.objectStore(n.objectStoreName).get("production");s.onsuccess=function(n){var i=s.result;r(e?i&&i[e]?i[e]:t:i||{})},o.onerror=function(e){n.loggingService.error(e),i()}})]})})},DbConnection.prototype.set=function(e,t,r){return void 0===r&&(r=!1),n(this,void 0,void 0,function(){var o=this;return i(this,function(s){return[2,new Promise(function(s,a){return n(o,void 0,void 0,function(){var n,o,c=this;return i(this,function(i){switch(i.label){case 0:return"fcm_subscription_id"!==e||void 0!==t&&null!==t||(this.loggingService.warn("Writing null fcm_subscription_id to IndexDB"),s()),r||this.loggingService.info("Writing to "+e),[4,this.get()];case 1:return(n=i.sent()).env="production",n[e]=t,(o=this.db.transaction(this.objectStoreName,"readwrite")).oncomplete=function(e){s()},o.onerror=function(e){c.loggingService.error(e),a()},o.objectStore(this.objectStoreName).put(n),[2]}})})})]})})},DbConnection.prototype.mset=function(e,t){return void 0===t&&(t=!1),n(this,void 0,void 0,function(){var r=this;return i(this,function(o){return[2,new Promise(function(o,s){return n(r,void 0,void 0,function(){var r,n,a=this;return i(this,function(i){switch(i.label){case 0:return t||this.loggingService.info("Writing to "+Object.keys(e)),[4,this.get()];case 1:return(r=i.sent()).env="production",Object.keys(e).some(function(t){var n=e[t];return"fcm_subscription_id"!==t||void 0!==n&&null!==n?(r[t]=n,!1):(a.loggingService.warn("Writing null fcm_subscription_id to IndexDB"),o(),!0)}),(n=this.db.transaction(this.objectStoreName,"readwrite")).oncomplete=function(e){o()},n.onerror=function(e){a.loggingService.error(e),s()},n.objectStore(this.objectStoreName).put(r),[2]}})})})]})})},DbConnection.prototype.getAll=function(){return n(this,void 0,void 0,function(){var e=this;return i(this,function(t){return[2,new Promise(function(t,r){var n=e.db.transaction(e.objectStoreName,"readonly").objectStore(e.objectStoreName).getAll();n.onsuccess=function(e){t(e.target.result)},n.onerror=function(t){e.loggingService.error(t),r(t)}})]})})},DbConnection.prototype.close=function(){this.db.close()},DbConnection}();t.DbConnection=o},"./src/sdk/models/index.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/models/app-context.model.ts");t.AppContext=n.AppContext;var i=r("./src/sdk/models/db-connection.model.ts");t.DbConnection=i.DbConnection;var o=r("./src/sdk/models/register-token-options.model.ts");t.RegisterTokenOptions=o.RegisterTokenOptions},"./src/sdk/models/register-token-options.model.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function RegisterTokenOptions(e){if(this.migrated=!1,this.amp=!1,Object.assign(this,e),!this.language||!this.time_zone)try{this.language=Intl.DateTimeFormat().resolvedOptions().locale,this.time_zone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}this.subscribed_url||(this.subscribed_url=window.location.toString()),this.previous_token&&(this.migrated=!0)}}();t.RegisterTokenOptions=n},"./src/sdk/pushly-sdk.ts":function(e,t,r){"use strict";var n=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var a=r("./src/sdk/decorators/index.ts"),c=r("./src/sdk/services/index.ts"),u=r("./src/sdk/models/index.ts"),l=r("./src/sdk/enums/index.ts"),p=r("./src/sdk/web-event-bus.ts"),d=r("./src/sdk/utils/index.ts"),f=r("./src/sdk/constants.ts"),h=r("./src/sdk/sdk-flows/frame-helper.flow.ts"),v=r("./src/sdk/sdk-flows/permission-dialog.flow.ts"),_=r("./src/sdk/sdk-flows/web.flow.ts"),g=r("./src/sdk/sdk-flows/proxy-dialog.flow.ts"),m=r("./src/sdk/sdk-flows/proxy-frame-helper.flow.ts"),b=r("./src/sdk/services/data-store.service.ts"),y=function(){function PushlySDK(e,t,r,n,i,o,s,a,c,u,l,p,d,f,h,v){this.settingsService=e,this.eventsService=t,this.cookieService=r,this.appContext=n,this.profileService=i,this.dbService=o,this.loggingService=s,this.environmentService=a,this.dataStoreService=c,this.ampMessageBroker=u,this.frameHelperFlow=l,this.permissionDialogFlow=p,this.webFlow=d,this.registrationService=f,this.proxyDialogFlow=h,this.proxyFrameHelperFlow=v,this.loaded=!1,this.loadFailed=!1,this.loggingService.info("Version: bf1d6794b4e27ed2c53b215b2fa7aace95e4cdb7"),this.wireEvents()}return PushlySDK.prototype.load=function(e){return o(this,void 0,void 0,function(){var t,r,n;return s(this,function(i){switch(i.label){case 0:return i.trys.push([0,11,,12]),this.loggingService.info("Loading"),this.loggingService.info(this.buildNavigatorJsonDump()),e.classNames&&(this.appContext.classNames=e.classNames),[4,this.environmentService.isSupported()];case 1:return i.sent()?(this.handleSupported(),this.appContext.disabled=!!e.disableWebFlow,this.appContext.domainKey=e.domainKey,[4,this.loadStateFromQueryStrings()]):(this.handleUnsupported(),[2]);case 2:return i.sent(),[4,this.loadStateFromCookies()];case 3:return i.sent(),[4,this.initIndexedDbState()];case 4:return i.sent(),[4,this.loadSettings(e)];case 5:return i.sent(),this.loadFailed?(this.loggingService.info("Failed to load settings. Exiting."),[2]):this.environmentService.isUserSubscribed()?(this.cookieService.setCookie(f.PUSHLY_PROMPT_SUBSCRIBED_COOKIE,!0,f.PUSHLY_PROMPT_SUBSCRIBED_COOKIE_TIMEOUT),!(!this.environmentService.isUsingProxyIntegration()||this.environmentService.urlContainsProxyUrl())||this.environmentService.isBrowserPermissionGranted()?[3,7]:[4,this.registrationService.unsubscribe()]):[3,7];case 6:i.sent(),i.label=7;case 7:return this.loaded=!0,p.WebEventBus.dispatch("loaded"),this.loggingService.info("Loaded"),this.loggingService.info(this.appContext.fcmToken?"Token Exists":"No Token Exists"),(r=(t={},t[l.RuntimeEnvironmentType.Direct]=this.webFlow,t[l.RuntimeEnvironmentType.Proxy]=this.webFlow,t[l.RuntimeEnvironmentType.AmpHelperFrame]=this.frameHelperFlow,t[l.RuntimeEnvironmentType.ProxyFrameHelper]=this.proxyFrameHelperFlow,t[l.RuntimeEnvironmentType.AmpPermissionDialog]=this.permissionDialogFlow,t[l.RuntimeEnvironmentType.ProxyDialog]=this.proxyDialogFlow,t)[this.environmentService.getRuntimeEnvironmentType()])?[4,r.run(e)]:[3,9];case 8:return i.sent(),this.setCustomPromptSubscriptionStateIfPresent(),p.WebEventBus.dispatch("ready",this.appContext),[3,10];case 9:this.loggingService.error("Unknown flow "+this.environmentService.getRuntimeEnvironmentType()),i.label=10;case 10:return[3,12];case 11:return n=i.sent(),this.loggingService.error(n),this.loadFailed=!0,this.appContext.disabled=!0,[3,12];case 12:return[2]}})})},PushlySDK.prototype.checkForUnsubParameter=function(){return o(this,void 0,void 0,function(){var e;return s(this,function(t){return e="","location"in window&&window.location.search&&(e=window.location.search),/pn_unsub=(1|true)/i.test(e)?[2,this.registrationService.unsubscribe()]:[2]})})},PushlySDK.prototype.getCustomPromptElement=function(){return o(this,void 0,void 0,function(){return s(this,function(e){return[2,new Promise(function(e,t){var r,n=document;if(n)if(r=document.getElementsByClassName(f.DEFAULT_CLASSNAME_PROMPT_CUSTOM)[0])e(r);else{var i=new MutationObserver(function(t){var n=!0;t.some(function(e){if(e.addedNodes.length>0)Array.from(e.addedNodes).some(function(e){return"classList"in e&&e.classList.contains(f.DEFAULT_CLASSNAME_PROMPT_CUSTOM)&&(n=!1,r=e),n});else if(e.target&&"classList"in e.target){var t=e.target;t.classList.contains(f.DEFAULT_CLASSNAME_PROMPT_CUSTOM)&&(n=!1,r=t)}return n}),!n&&r&&(i.disconnect(),e(r))});i.observe(n,{attributes:!0,childList:!0,subtree:!0})}else t()})]})})},PushlySDK.prototype.handleUnsupported=function(){this.loggingService.info("Web push not supported"),p.WebEventBus.dispatch("web_push_unsupported"),this.setCustomPromptUnsupportedIfPresent()},PushlySDK.prototype.handleSupported=function(){p.WebEventBus.dispatch("web_push_supported"),this.setCustomPromptSupportedIfPresent()},PushlySDK.prototype.setCustomPromptUnsupportedIfPresent=function(){return o(this,void 0,void 0,function(){var e,t;return s(this,function(r){switch(r.label){case 0:return[4,this.getCustomPromptElement()];case 1:return e=r.sent(),t=this.appContext.classNames.webPushUnsupported||f.DEFAULT_CLASSNAME_WEB_PUSH_UNSUPPORTED,e&&!e.classList.contains(t)&&e.classList.add(t),[2]}})})},PushlySDK.prototype.setCustomPromptSupportedIfPresent=function(){return o(this,void 0,void 0,function(){var e,t;return s(this,function(r){switch(r.label){case 0:return[4,this.getCustomPromptElement()];case 1:return e=r.sent(),t=this.appContext.classNames.webPushSupported||f.DEFAULT_CLASSNAME_WEB_PUSH_SUPPORTED,e&&!e.classList.contains(t)&&e.classList.add(t),[2]}})})},PushlySDK.prototype.setCustomPromptSubscriptionStateIfPresent=function(){return o(this,void 0,void 0,function(){var e,t;return s(this,function(r){switch(r.label){case 0:return[4,this.getCustomPromptElement()];case 1:return e=r.sent(),t=this.appContext.classNames.subscriptionNone||f.DEFAULT_CLASSNAME_SUBSCRIPTION_NONE,this.environmentService.isBlocked()||this.environmentService.isDismissed()?(t=this.appContext.classNames.subscriptionDenied||f.DEFAULT_CLASSNAME_SUBSCRIPTION_DENIED,[3,5]):[3,2];case 2:return this.environmentService.isUserSubscribed()?(t=this.appContext.classNames.subscriptionSubscribed||f.DEFAULT_CLASSNAME_SUBSCRIPTION_TRUE,[3,5]):[3,3];case 3:return[4,this.environmentService.isUserOptedOut()];case 4:r.sent()&&(t=this.appContext.classNames.subscriptionUnsubscribed||f.DEFAULT_CLASSNAME_SUBSCRIPTION_FALSE),r.label=5;case 5:return e&&!e.classList.contains(t)&&e.classList.add(t),[2]}})})},PushlySDK.prototype.buildNavigatorJsonDump=function(){var e={},t=(window||{}).navigator;try{if(t&&t.__proto__){for(var r=0,n=Object.keys(t.__proto__);r<n.length;r++){var i=n[r];e[i]=navigator[i]}delete e.plugins,delete e.mimeTypes}}catch(e){this.loggingService.warn(e)}return JSON.stringify(e)},PushlySDK.prototype.loadStateFromCookies=function(){return o(this,void 0,void 0,function(){return s(this,function(e){return this.appContext.disabled=this.cookieService.getCookie(f.PUSHLY_PROMPT_BLOCKED_COOKIE,this.cookieService.getCookie(f.PUSHLY_PROMPT_DISMISSED_COOKIE,!1)),this.appContext.visibleLogsEnabled=!!this.cookieService.getCookie(f.PUSHLY_VISIBLE_LOGS_COOKIE,!1),[2]})})},PushlySDK.prototype.loadStateFromQueryStrings=function(){return o(this,void 0,void 0,function(){var e;return s(this,function(t){return e=d.parseQueryString(window.location.search),f.PUSHLY_UNIQUE_USER_ID_QS in e&&(this.appContext.uniqueUserId=e.pushly_unique_user_id),f.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_QS in e&&(this.appContext.uniqueUserFirstAppearance=e.pushly_unique_user_first_appearance),[2]})})},PushlySDK.prototype.initIndexedDbState=function(){return o(this,void 0,void 0,function(){var e,t,r,n;return s(this,function(i){switch(i.label){case 0:return[4,this.dbService.getConnection()];case 1:return e=i.sent(),this.appContext.uniqueUserId?[3,3]:(t=this.appContext,[4,e.get(f.PUSHLY_DB_UNIQUE_USER_ID_KEY)]);case 2:t.uniqueUserId=i.sent(),i.label=3;case 3:return this.appContext.uniqueUserFirstAppearance?[3,5]:(r=this.appContext,[4,e.get(f.PUSHLY_DB_UNIQUE_USER_FIRST_APPEARANCE_KEY)]);case 4:r.uniqueUserFirstAppearance=i.sent(),i.label=5;case 5:return n=this.appContext,[4,e.get(f.PUSHLY_DB_FCM_SUBSCRIPTION_ID_KEY)];case 6:return n.fcmToken=i.sent(),this.appContext.uniqueUserId?[3,12]:[4,this.dataStoreService.getUniqueUserId(b.DataStoreSource.COOKIE)];case 7:return i.sent()?[4,this.dataStoreService.autoUpdateSubscriptionData()]:[3,9];case 8:return i.sent(),[3,12];case 9:return[4,this.dataStoreService.setUniqueUserId(d.randomString())];case 10:return i.sent(),[4,this.dataStoreService.setUniqueUserFirstAppearance(Math.round((new Date).getTime()/1e3))];case 11:i.sent(),i.label=12;case 12:return e.close(),[2]}})})},PushlySDK.prototype.wireEvents=function(){var e=this;p.WebEventBus.on("load_error",function(){return o(e,void 0,void 0,function(){return s(this,function(e){try{this.environmentService.getRuntimeEnvironmentType()!==l.RuntimeEnvironmentType.ProxyDialog&&this.environmentService.getRuntimeEnvironmentType()!==l.RuntimeEnvironmentType.AmpPermissionDialog||setTimeout(function(){window.close()})}catch(e){this.loggingService.error(e)}return[2]})})}),p.WebEventBus.on("trigger_load",function(t){e.load(t)}),p.WebEventBus.on("trigger_amp_frame_helper",function(t){e.environmentService.setKnownEnvironment(l.RuntimeEnvironmentType.AmpHelperFrame),e.load(t)}),p.WebEventBus.on("trigger_proxy_frame_helper",function(t){e.environmentService.setKnownEnvironment(l.RuntimeEnvironmentType.ProxyFrameHelper),e.load(t)}),p.WebEventBus.on("trigger_amp_permission_dialog",function(t){e.environmentService.setKnownEnvironment(l.RuntimeEnvironmentType.AmpPermissionDialog),e.load(t)}),p.WebEventBus.on("trigger_unsubscribe",function(){e.ensureLoaded(),e.registrationService.unsubscribe()}),["trigger_profile","trigger_external_id","trigger_event","trigger_tag"].forEach(function(t){try{p.WebEventBus.on(t,function(r){var n=function(){if(e.loaded)if(e.environmentService.isUserSubscribed())switch(t){case"trigger_profile":e.saveUserProfileData(r);break;case"trigger_external_id":e.saveExternalUserId(r);break;case"trigger_event":e.saveUserEvent(r);break;case"trigger_tag":r instanceof Array||(r=[r]),e.saveUserTags(r)}else p.WebEventBus.once("subscribed,proxy_response_subscribed",function(){n()});else p.WebEventBus.once("ready",function(){n()})};n()})}catch(t){e.loggingService.error(t)}})},PushlySDK.prototype.loadSettings=function(e){return o(this,void 0,void 0,function(){var t,r,n,i,o,a;return s(this,function(s){switch(s.label){case 0:return s.trys.push([0,10,,11]),this.loggingService.info("Getting Site Settings"),this.cookieService.getCookie(f.PUSHLY_SETTINGS_CACHED_COOKIE)?[4,this.dbService.getConnection()]:[3,5];case 1:return[4,(t=s.sent()).get(f.PUSHLY_DB_SETTINGS_KEY)];case 2:return(r=s.sent())?(this.loggingService.info("Pulled Settings from Cache"),this.appContext.settings=r,[4,t.set(f.PUSHLY_DB_DOMAIN_ID,this.appContext.settings.domain.id)]):[3,4];case 3:s.sent(),s.label=4;case 4:if(t.close(),p.WebEventBus.dispatch("load",this.appContext),r)return[2];s.label=5;case 5:return n=this.appContext,[4,this.settingsService.getSettings(e.domainKey)];case 6:return n.settings=s.sent(),this.appContext.settings?[4,this.dbService.getConnection()]:(this.loadFailed=!0,a="Failed to fetch settings. Exiting.",this.loggingService.info(a),p.WebEventBus.dispatch("load_error",a),[2]);case 7:return[4,(i=s.sent()).set(f.PUSHLY_DB_DOMAIN_ID,this.appContext.settings.domain.id)];case 8:return s.sent(),[4,i.set(f.PUSHLY_DB_SETTINGS_KEY,this.appContext.settings)];case 9:return s.sent(),this.cookieService.setCookie(f.PUSHLY_SETTINGS_CACHED_COOKIE,!0,f.PUSHLY_SETTINGS_CACHED_COOKIE_TIMEOUT),this.loggingService.info("Fetched Settings"),i.close(),p.WebEventBus.dispatch("load",this.appContext),[3,11];case 10:return o=s.sent(),this.loggingService.error(o),this.loadFailed=!0,a="Settings not found for this domain",p.WebEventBus.dispatch("load_error",a),[3,11];case 11:return[2]}})})},PushlySDK.prototype.ensureLoaded=function(){if(!this.loaded)throw new Error("PushlySDK hasn't finished loading. Register a 'ready' listener with PushlySDK.on('ready', function() { ... }) before calling PushlySDK.load( ... ).")},PushlySDK.prototype.saveUserTags=function(e){return o(this,void 0,void 0,function(){return s(this,function(t){return this.ensureLoaded(),this.profileService.saveUserTags(this.appContext.fcmToken,e),[2]})})},PushlySDK.prototype.saveUserEvent=function(e){return o(this,void 0,void 0,function(){return s(this,function(t){return this.ensureLoaded(),this.profileService.saveUserEvent(this.appContext.fcmToken,e),[2]})})},PushlySDK.prototype.saveUserProfileData=function(e){return o(this,void 0,void 0,function(){return s(this,function(t){return this.ensureLoaded(),this.profileService.saveUserProfileData(this.appContext.fcmToken,e),[2]})})},PushlySDK.prototype.saveExternalUserId=function(e){return o(this,void 0,void 0,function(){return s(this,function(t){return this.ensureLoaded(),this.profileService.saveExternalUserId(this.appContext.fcmToken,e),[2]})})},PushlySDK.prototype.push=function(e){var t=/^on_/i;if(t.test(e[0])){var r=e[0].replace(t,"");this.on(r,e[1])}else p.WebEventBus.dispatch("trigger_"+e[0],e[1])},PushlySDK.prototype.on=function(e,t){p.WebEventBus.on(e,t)},PushlySDK.prototype.requestNotificationPermissions=function(e){return void 0===e&&(e=null),o(this,void 0,void 0,function(){return s(this,function(t){return[2,this.registrationService.tryRegistration({id:e})]})})},PushlySDK=n([a.inject(),i("design:paramtypes",[c.SettingsService,c.EventsService,c.CookieService,u.AppContext,c.ProfileService,c.DbService,c.LoggingService,c.EnvironmentService,c.DataStoreService,c.AmpMessageBroker,h.FrameHelperFlow,v.PermissionDialogFlow,_.WebFlow,c.RegistrationService,g.ProxyDialogFlow,m.ProxyFrameHelperFlow])],PushlySDK)}();t.PushlySDK=y},"./src/sdk/sdk-flows/base.flow.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){return function BaseFlow(){}}();t.BaseFlow=n},"./src/sdk/sdk-flows/frame-helper.flow.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/enums/index.ts"),u=r("./src/sdk/services/index.ts"),l=r("./src/sdk/sdk-flows/base.flow.ts"),p=r("./src/sdk/decorators/index.ts"),d=r("./src/sdk/models/index.ts"),f=r("./src/sdk/constants.ts"),h=r("./src/sdk/services/web-service-worker-service.ts"),v=function(e){function FrameHelperFlow(t,r,n,i,o,s,a){var c=e.call(this)||this;return c.ampMessageBroker=t,c.environmentService=r,c.loggingService=n,c.dbService=i,c.appContext=o,c.webServiceWorkerService=s,c.registrationService=a,c}return n(FrameHelperFlow,e),FrameHelperFlow.prototype.run=function(e){return s(this,void 0,void 0,function(){var t,r=this;return a(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.webServiceWorkerService.registerServiceWorker(e)];case 1:return n.sent(),this.ampMessageBroker.on(c.AmpMessageTopics.NotificationPermissionState,function(e){e.reply(!0)}),this.ampMessageBroker.on(c.AmpMessageTopics.ServiceWorkerState,function(e){e.reply({isControllingFrame:!!window.navigator.serviceWorker.controller,url:window.navigator.serviceWorker.controller?window.navigator.serviceWorker.controller.scriptURL:null,state:window.navigator.serviceWorker.controller?window.navigator.serviceWorker.controller.state:null})}),this.ampMessageBroker.on(c.AmpMessageTopics.ServiceWorkerRegistration,function(e){e.reply()}),this.ampMessageBroker.on(c.AmpMessageTopics.ServiceWorkerQuery,function(e){return s(r,void 0,void 0,function(){var t,r,n;return a(this,function(i){switch(i.label){case 0:switch(t=e.data,t.topic){case c.AmpServiceWorkerMessageTopics.AmpSubscriptionState:return[3,1];case c.AmpServiceWorkerMessageTopics.AmpUnsubscribe:return[3,2];case c.AmpServiceWorkerMessageTopics.AmpSubscribe:return[3,6]}return[3,7];case 1:return e.reply(this.environmentService.isUserSubscribed()),[3,7];case 2:return[4,this.dbService.getConnection()];case 3:return r=i.sent(),n=this.appContext,[4,r.get(f.PUSHLY_DB_FCM_SUBSCRIPTION_ID_KEY)];case 4:return n.fcmToken=i.sent(),r.close(),[4,this.registrationService.unsubscribe()];case 5:return i.sent(),e.reply(null),[3,7];case 6:return e.reply(null),[3,7];case 7:return[2]}})})}),this.ampMessageBroker.on(c.AmpMessageTopics.StorageGet,function(e){r.environmentService.isUserSubscribed()?e.reply("granted"):r.environmentService.isBlocked()||r.environmentService.isDismissed()?e.reply("denied"):e.reply("default")}),this.ampMessageBroker.listen(),[3,3];case 2:return t=n.sent(),this.loggingService.error(t),[3,3];case 3:return[2]}})})},FrameHelperFlow=i([p.inject(),o("design:paramtypes",[u.AmpMessageBroker,u.EnvironmentService,u.LoggingService,u.DbService,d.AppContext,h.WebServiceWorkerService,u.RegistrationService])],FrameHelperFlow)}(l.BaseFlow);t.FrameHelperFlow=v},"./src/sdk/sdk-flows/permission-dialog.flow.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/services/index.ts"),u=r("./src/sdk/models/index.ts"),l=r("./src/sdk/decorators/index.ts"),p=r("./src/sdk/enums/index.ts"),d=r("./src/sdk/sdk-flows/base.flow.ts"),f=r("./src/sdk/web-event-bus.ts"),h=r("./src/sdk/services/web-service-worker-service.ts"),v=function(e){function PermissionDialogFlow(t,r,n,i,o){var s=e.call(this)||this;return s.ampMessageBroker=t,s.registrationService=r,s.loggingService=n,s.appContext=i,s.webServiceWorkerService=o,s}return n(PermissionDialogFlow,e),PermissionDialogFlow.prototype.run=function(e){return s(this,void 0,void 0,function(){var t,r,n=this;return a(this,function(i){switch(i.label){case 0:return this.loggingService.info("Entered Amp Permission Dialog Flow"),[4,this.webServiceWorkerService.registerServiceWorker(e)];case 1:i.sent(),f.WebEventBus.on("permission_dismissed",function(){return s(n,void 0,void 0,function(){return a(this,function(e){try{this.ampMessageBroker.send(p.AmpMessageTopics.NotificationPermissionState,"denied").then(function(){window.close()})}catch(e){this.loggingService.error(e)}return[2]})})}),f.WebEventBus.on("permission_denied",function(){return s(n,void 0,void 0,function(){return a(this,function(e){try{this.ampMessageBroker.send(p.AmpMessageTopics.NotificationPermissionState,"denied").then(function(){window.close()})}catch(e){this.loggingService.error(e)}return[2]})})}),f.WebEventBus.on("subscribed",function(e){return s(n,void 0,void 0,function(){return a(this,function(e){try{this.ampMessageBroker.send(p.AmpMessageTopics.NotificationPermissionState,"granted").then(function(e){window.close()})}catch(e){this.loggingService.error(e)}return[2]})})});try{this.ampMessageBroker.connect(window.opener),t="https://notifications.p-n.io/"+this.appContext.domainKey+"?pushly_domain_key="+this.appContext.domainKey+"&swim=preview",(r=document.createElement("iframe")).addEventListener("load",function(){n.registrationService.tryRegistration()}),r.setAttribute("src",t),r.setAttribute("frame-border","0"),r.setAttribute("style","width: 100vw; height: 100vh; border: none;"),document.body.appendChild(r)}catch(e){this.loggingService.error(e)}return[2]}})})},PermissionDialogFlow=i([l.inject(),o("design:paramtypes",[c.AmpMessageBroker,c.RegistrationService,c.LoggingService,u.AppContext,h.WebServiceWorkerService])],PermissionDialogFlow)}(d.BaseFlow);t.PermissionDialogFlow=v},"./src/sdk/sdk-flows/prompt.flow.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/decorators/index.ts"),u=r("./src/sdk/services/index.ts"),l=r("./src/sdk/enums/index.ts"),p=r("./src/sdk/components/index.ts"),d=r("./src/container.ts"),f=r("./src/sdk/sdk-flows/base.flow.ts"),h=r("./src/sdk/models/index.ts"),v=function(e){function PromptFlow(t,r){var n=e.call(this)||this;return n.loggingService=t,n.appContext=r,n.groups=[],n.prompts=[],n.currentPageHref="",n.currentPageKeywords=[],n}return n(PromptFlow,e),PromptFlow.prototype.run=function(e){return s(this,void 0,void 0,function(){var e,t,r=this;return a(this,function(n){this.buildComponentContainer(),this.collectCurrentPageHref(),this.collectCurrentPageKeywords();try{this.loggingService.info("Running Prompt Flow"),e=!this.appContext.settings.prompt_groups&&!!this.appContext.settings.prompts,this.groups=(this.appContext.settings.prompt_groups||[]).slice(),this.prompts=(this.appContext.settings.prompts||[]).slice(),e?(this.loggingService.once().info("Legacy prompt settings detected"),this.prompts.forEach(function(e){r.loadPrompt(e)})):(t=this.selectEligiblePrompt())&&this.loadPrompt(t.prompt,t.group)}catch(e){this.loggingService.once().error(e)}return[2]})})},PromptFlow.prototype.buildComponentContainer=function(){this.componentContainer=new d.Container,this.componentContainer.transient(u.RegistrationService),this.componentContainer.transient(u.CookieService),this.componentContainer.transient(u.DbService),this.componentContainer.transient(u.EnvironmentService),this.componentContainer.transient(u.EventsService),this.componentContainer.transient(p.NativePromptComponent),this.componentContainer.transient(p.CustomPromptComponent),this.componentContainer.transient(p.SlidePromptComponent),this.componentContainer.transient(p.BellComponent),this.componentContainer.transient(u.SessionService),this.componentContainer.transient(u.DataStoreService),this.componentContainer.transient(u.CryptoService),this.componentContainer.transient(u.ProfileService),this.componentContainer.singleton(u.LoggingService,this.loggingService),this.componentContainer.singleton(h.AppContext,this.appContext)},PromptFlow.prototype.loadPrompt=function(e,t){return s(this,void 0,void 0,function(){var r,n,i;return a(this,function(o){switch(o.label){case 0:return this.loggingService.info("Prompt selected: "+(t?t.name+"::":"")+"["+e.id+"|"+e.style+"]."),n=(r={},r[l.PromptStyle.Native]=p.NativePromptComponent,r[l.PromptStyle.Custom]=p.CustomPromptComponent,r[l.PromptStyle.Slide]=p.SlidePromptComponent,r[l.PromptStyle.Bell]=p.BellComponent,r)[e.style],[4,(i=this.componentContainer.get(n)).init(e)];case 1:return o.sent(),i.initialized&&i.run(),[2]}})})},PromptFlow.prototype.selectEligiblePrompt=function(){var e,t=this,r=[];(this.groups.sort(function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:0}).some(function(e){var n=t.prompts.filter(function(t){return t.prompt_group_id===e.id}),i=!0;if(e.conditions_json&&(t.validatePageCondtions(e)||(i=!1)),i&&n.length>0){var o=1===n.length?n[0]:t.pickWeightedRandomPrompt(n);return r.push({group:e,prompt:o}),!0}}),r.length>0&&(e=r[0]),e&&e.group)&&((e.group.display_to_pct||0)<100&&Math.floor(100*Math.random())>e.group.display_to_pct&&(e=void 0));return e},PromptFlow.prototype.pickWeightedRandomPrompt=function(e){for(var t=[],r=0,n=e;r<n.length;r++)for(var i=n[r],o=0;o<i.weight;o++)t.push(i);return t[Math.floor(Math.random()*t.length)]},PromptFlow.prototype.collectCurrentPageHref=function(){this.currentPageHref=window.location.href},PromptFlow.prototype.collectCurrentPageKeywords=function(){var e=window.document.getElementsByTagName("meta");if(e.keywords){var t=e.keywords.content.split(",").map(function(e){return e.toString().trim().toLowerCase()});t&&t.length>0&&(this.currentPageKeywords=t)}},PromptFlow.prototype.validatePageCondtions=function(e){var t=this,r=!0;if(e.conditions_json){var n=e.conditions_json.page||{};if(r&&n.keywords)if(0===this.currentPageKeywords.length)r=!1;else{var i=!1;n.keywords.some(function(e){if(-1!==t.currentPageKeywords.indexOf(e))return i=!0,!0}),r=i}if(r&&n.page_urls){var o=!1;n.page_urls.some(function(e){if(new RegExp(e,"i").test(t.currentPageHref))return o=!0,!0}),r=o}}return r},PromptFlow=i([c.inject(),o("design:paramtypes",[u.LoggingService,h.AppContext])],PromptFlow)}(f.BaseFlow);t.PromptFlow=v},"./src/sdk/sdk-flows/proxy-dialog.flow.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/services/index.ts"),u=r("./src/sdk/models/index.ts"),l=r("./src/sdk/decorators/index.ts"),p=r("./src/sdk/sdk-flows/base.flow.ts"),d=r("./src/sdk/web-event-bus.ts"),f=r("./src/sdk/services/web-service-worker-service.ts"),h=function(e){function ProxyDialogFlow(t,r,n,i,o){var s=e.call(this)||this;return s.registrationService=t,s.environmentService=r,s.loggingService=n,s.appContext=i,s.webServiceWorkerService=o,s}return n(ProxyDialogFlow,e),ProxyDialogFlow.prototype.run=function(e){return s(this,void 0,void 0,function(){var t=this;return a(this,function(r){switch(r.label){case 0:return this.loggingService.info("Entered proxy permission dialog flow"),d.WebEventBus.on("permission_dismissed",function(){return s(t,void 0,void 0,function(){return a(this,function(e){try{window.opener.postMessage({action:"permission_dismissed",data:this.appContext.fcmToken},"*"),setTimeout(function(){window.close()})}catch(e){this.loggingService.error(e)}return[2]})})}),d.WebEventBus.on("permission_denied",function(){return s(t,void 0,void 0,function(){return a(this,function(e){try{window.opener.postMessage({action:"permission_denied",data:this.appContext.fcmToken},"*"),setTimeout(function(){window.close()})}catch(e){this.loggingService.error(e)}return[2]})})}),d.WebEventBus.on("subscribed",function(e){return s(t,void 0,void 0,function(){return a(this,function(e){try{window.opener.postMessage({action:"subscribed",data:this.appContext.fcmToken},"*"),setTimeout(function(){window.close()})}catch(e){this.loggingService.error(e)}return[2]})})}),[4,this.webServiceWorkerService.registerServiceWorker(e)];case 1:return r.sent(),[2]}})})},ProxyDialogFlow=i([l.inject(),o("design:paramtypes",[c.RegistrationService,c.EnvironmentService,c.LoggingService,u.AppContext,f.WebServiceWorkerService])],ProxyDialogFlow)}(p.BaseFlow);t.ProxyDialogFlow=h},"./src/sdk/sdk-flows/proxy-frame-helper.flow.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/services/index.ts"),u=r("./src/sdk/sdk-flows/base.flow.ts"),l=r("./src/sdk/decorators/index.ts"),p=r("./src/sdk/services/web-service-worker-service.ts"),d=function(e){function ProxyFrameHelperFlow(t,r){var n=e.call(this)||this;return n.loggingService=t,n.webServiceWorkerService=r,n}return n(ProxyFrameHelperFlow,e),ProxyFrameHelperFlow.prototype.run=function(e){return s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this.webServiceWorkerService.registerServiceWorker(e)];case 1:return r.sent(),[3,3];case 2:return t=r.sent(),this.loggingService.error(t),[3,3];case 3:return[2]}})})},ProxyFrameHelperFlow=i([l.inject(),o("design:paramtypes",[c.LoggingService,p.WebServiceWorkerService])],ProxyFrameHelperFlow)}(u.BaseFlow);t.ProxyFrameHelperFlow=d},"./src/sdk/sdk-flows/web.flow.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/decorators/index.ts"),u=r("./src/sdk/services/index.ts"),l=r("./src/sdk/enums/index.ts"),p=r("./src/sdk/sdk-flows/base.flow.ts"),d=r("./src/sdk/models/index.ts"),f=r("./src/sdk/services/web-service-worker-service.ts"),h=r("./src/sdk/sdk-flows/prompt.flow.ts"),v=r("./src/sdk/web-event-bus.ts"),_=function(e){function WebFlow(t,r,n,i,o,s,a,c,u,l,p){var d=e.call(this)||this;return d.loggingService=t,d.environmentService=r,d.eventsService=n,d.registrationService=i,d.webServiceWorkerService=o,d.appContext=s,d.sessionService=a,d.cookieService=c,d.dbService=u,d.dataStoreService=l,d.promptFlow=p,d}return n(WebFlow,e),WebFlow.prototype.startPageChangeTracker=function(){var e,t=this;setInterval(function(){var r=window.location.href;r!=e&&(t.sessionService.addPageView(r),t.environmentService.isUserSubscribed()&&t.eventsService.putEvent({action:l.EventAction.ViewPage})),e=r},100)},WebFlow.prototype.initStylesheet=function(){return s(this,void 0,void 0,function(){var e=this;return a(this,function(t){return[2,new Promise(function(e,t){var r=document.createElement("link");r.rel="stylesheet",r.type="text/css",r.href="https://cdn.p-n.io/pushly-sdk.min.css",r.addEventListener("load",function(){return e()}),document.head.appendChild(r)}).then(function(){}).catch(function(t){e.loggingService.error(t)})]})})},WebFlow.prototype.runDirectFlow=function(e){return s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return this.loggingService.info("Running Direct Flow"),[4,this.dataStoreService.autoUpdateSubscriptionData()];case 1:return t.sent(),this.environmentService.isSecure()?[4,this.webServiceWorkerService.registerServiceWorker(e)]:(this.loggingService.warn("Unable to intializing service worker or messaging on a non-https domain. Exiting"),this.appContext.disabled=!0,[2,!1]);case 2:return t.sent(),[4,this.registrationService.tryMigration()];case 3:return t.sent(),[2,!this.appContext.disabled]}})})},WebFlow.prototype.runProxyFlow=function(e){return s(this,void 0,void 0,function(){var e,t=this;return a(this,function(r){switch(r.label){case 0:return this.loggingService.info("Running Proxy Flow"),[4,this.webServiceWorkerService.loadServiceWorkerDependencyScript()];case 1:return r.sent(),[4,this.dataStoreService.autoUpdateSubscriptionData()];case 2:return r.sent(),window.addEventListener("message",function(e){return s(t,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:if(r.trys.push([0,7,,8]),!this.appContext.settings)return[2];if(!this.environmentService.urlContainsProxyUrl(e.origin))return[3,6];switch(this.loggingService.info("Got message from proxy window: "+e.data.action),e.data.action){case l.EventAction.Subscribed:return[3,1];case l.EventAction.PromptDismiss:return[3,3];case l.EventAction.PermissionDenied:return[3,4]}return[3,5];case 1:return[4,this.environmentService.setFcmSubscriptionId(e.data.data)];case 2:return r.sent(),[3,5];case 3:return this.environmentService.setDismissed(!0),[3,5];case 4:return this.environmentService.setBlocked(!0),[3,5];case 5:v.WebEventBus.dispatch("proxy_response_"+e.data.action,e.data.data),r.label=6;case 6:return[3,8];case 7:return t=r.sent(),this.loggingService.error(t),[3,8];case 8:return[2]}})})}),document.createElement("div").style.display="none",(e=document.createElement("iframe")).setAttribute("width","1"),e.setAttribute("height","1"),e.style.visibility="hidden",[2,!0]}})})},WebFlow.prototype.startPromptFlow=function(e){try{this.startPageChangeTracker(),this.promptFlow.run(e)}catch(e){this.loggingService.error(e)}},WebFlow.prototype.run=function(e){return s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return this.loggingService.info("Running Web Flow"),this.appContext.disabled?(this.loggingService.info("Web flow disabled. Exiting"),[2]):e.disableLoadStylesheet?[3,2]:[4,this.initStylesheet()];case 1:r.sent(),r.label=2;case 2:return t=!1,this.environmentService.getRuntimeEnvironmentType()!==l.RuntimeEnvironmentType.Direct?[3,4]:[4,this.runDirectFlow(e)];case 3:return t=r.sent(),[3,6];case 4:return this.environmentService.getRuntimeEnvironmentType()!==l.RuntimeEnvironmentType.Proxy?[3,6]:[4,this.runProxyFlow(e)];case 5:t=r.sent(),r.label=6;case 6:return t&&this.startPromptFlow(e),[2]}})})},WebFlow=i([c.inject(),o("design:paramtypes",[u.LoggingService,u.EnvironmentService,u.EventsService,u.RegistrationService,f.WebServiceWorkerService,d.AppContext,u.SessionService,u.CookieService,u.DbService,u.DataStoreService,h.PromptFlow])],WebFlow)}(p.BaseFlow);t.WebFlow=_},"./src/sdk/services/amp-message-broker.ts":function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function __(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(__.prototype=r.prototype,new __)}}(),i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0});var s=r("./src/sdk/event-manager.ts"),a=r("./src/sdk/enums/index.ts"),c=r("./src/sdk/decorators/index.ts"),u=r("./src/sdk/services/logging.service.ts"),l=function(e){function AmpMessageBroker(t){var r=e.call(this)||this;return r.loggingService=t,r.isHost=!1,r.rand=Math.random(),r.ampListeners={},r.listenForHandshake(),r}return n(AmpMessageBroker,e),AmpMessageBroker.prototype.bindPortEvents=function(){var e=this;this.port.onmessage=function(t){try{if(t.data&&t.data.topic){var r=t.data.topic,n=t.data.data,i=t.data.id;if(i in e.ampListeners)e.ampListeners[i](n),delete e.ampListeners[i];else{e.loggingService.info(e.rand+"; Got message topic "+r,n),e.dispatch(r,{port:t.ports[0],data:n,reply:function(t){e.loggingService.info("Replying to "+r+" with "+t),e.send(r,{success:!0,result:t},i,!0)}})}}}catch(t){e.loggingService.error(t)}}},AmpMessageBroker.prototype.listen=function(){try{if(!this.port)return void this.loggingService.error("Unable to listen for amp messages. Amp handhake was never heard.");this.loggingService.info("AmpMessageBroker is listening"),this.bindPortEvents(),this.send(a.AmpMessageTopics.ConnectHandshake)}catch(e){this.loggingService.error(e)}},AmpMessageBroker.prototype.connect=function(e){try{this.loggingService.info("Connecting to opener"),this.isHost=!0;var t=new MessageChannel;this.port=t.port1,this.port.start(),this.bindPortEvents(),e.postMessage({topic:a.AmpMessageTopics.ConnectHandshake,data:{}},"*",[t.port2])}catch(e){this.loggingService.error(e)}},AmpMessageBroker.prototype.send=function(e,t,r,n){void 0===t&&(t=null),void 0===r&&(r=null),void 0===n&&(n=!1);try{this.loggingService.info("Sending message to amp window "+e,t);var i=r||crypto.getRandomValues(new Uint8Array(10)).join("");this.port.postMessage({id:i,topic:e,data:t,isReply:n});var o,s=Promise.resolve();if(!n)s=new Promise(function(e,t){o=e}),this.ampListeners[i]=o;return s}catch(e){this.loggingService.error(e)}},AmpMessageBroker.prototype.listenForHandshake=function(){var e=this;window.addEventListener("message",function(t){try{if(t.data&&t.data.topic)t.data.topic===a.AmpMessageTopics.ConnectHandshake&&(e.loggingService.info("Got handshake message",t),e.isHost?e.dispatch("connect"):(e.port=t.ports[0],e.dispatch("handshake")))}catch(t){e.loggingService.error(t)}})},AmpMessageBroker=i([c.inject(),o("design:paramtypes",[u.LoggingService])],AmpMessageBroker)}(s.EventManager);t.AmpMessageBroker=l},"./src/sdk/services/cookie.service.ts":function(e,t,r){"use strict";var n=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0});var o=r("./src/sdk/decorators/index.ts"),s=r("./src/sdk/services/logging.service.ts"),a=function(){function CookieService(e){this.loggingService=e}return CookieService.prototype.setCookie=function(e,t,r,n){void 0===r&&(r=9999),void 0===n&&(n="d");try{var i=new Date,o=location.hostname;"localhost"!==o&&(o="."+o.split(".").splice(-2).join("."));var s=1;switch(n){case"d":case"days":s=86400;break;case"h":case"hours":s=3600;break;case"m":case"minutes":s=60}this.loggingService.info("Settings cookie "+e+" to "+t+" for "+r+"("+n+")"),i.setTime(i.getTime()+r*s*1e3),document.cookie=e+"="+t+";expires="+i.toUTCString()+";path=/;domain="+o}catch(e){e&&e.message&&(/_isMatchingDomain/i.test(e.message)?this.loggingService.warn(e):this.loggingService.error(e))}},CookieService.prototype.setCookieWithRawExpires=function(e,t,r){try{var n=location.hostname;"localhost"!==n&&(n="."+n.split(".").splice(-2).join(".")),document.cookie=e+"="+t+";expires="+r+";path=/;domain="+n}catch(e){e&&e.message&&(/_isMatchingDomain/i.test(e.message)?this.loggingService.warn(e):this.loggingService.error(e))}},CookieService.prototype.getCookie=function(e,t){void 0===t&&(t=null);for(var r=document.cookie.split(";"),n=0;n<r.length;n++){var i=r[n].split("=");if(i[0].trim()===e)return i[1].trim()}return t},CookieService.prototype.getCookieKeys=function(){for(var e=[],t=document.cookie.split(";"),r=0;r<t.length;r++){var n=t[r].split("=");e.push(n[0].trim())}return e},CookieService.prototype.clearCookie=function(e){this.setCookie(e,null,-1)},CookieService.prototype.hasCookie=function(e){return null!==this.getCookie(e)},CookieService=n([o.inject(),i("design:paramtypes",[s.LoggingService])],CookieService)}();t.CookieService=a},"./src/sdk/services/crypto.service.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function CryptoService(){}return CryptoService.prototype.md5=function(e){return MD5(e)},CryptoService}();function MD5(e){function RotateLeft(e,t){return e<<t|e>>>32-t}function AddUnsigned(e,t){var r,n,i,o,s;return i=2147483648&e,o=2147483648&t,s=(1073741823&e)+(1073741823&t),(r=1073741824&e)&(n=1073741824&t)?2147483648^s^i^o:r|n?1073741824&s?3221225472^s^i^o:1073741824^s^i^o:s^i^o}function FF(e,t,r,n,i,o,s){return AddUnsigned(RotateLeft(e=AddUnsigned(e,AddUnsigned(AddUnsigned(function F(e,t,r){return e&t|~e&r}(t,r,n),i),s)),o),t)}function GG(e,t,r,n,i,o,s){return AddUnsigned(RotateLeft(e=AddUnsigned(e,AddUnsigned(AddUnsigned(function G(e,t,r){return e&r|t&~r}(t,r,n),i),s)),o),t)}function HH(e,t,r,n,i,o,s){return AddUnsigned(RotateLeft(e=AddUnsigned(e,AddUnsigned(AddUnsigned(function H(e,t,r){return e^t^r}(t,r,n),i),s)),o),t)}function II(e,t,r,n,i,o,s){return AddUnsigned(RotateLeft(e=AddUnsigned(e,AddUnsigned(AddUnsigned(function I(e,t,r){return t^(e|~r)}(t,r,n),i),s)),o),t)}function WordToHex(e){var t,r="",n="";for(t=0;t<=3;t++)r+=(n="0"+(e>>>8*t&255).toString(16)).substr(n.length-2,2);return r}var t,r,n,i,o,s,a,c,u,l=Array();for(l=function ConvertToWordArray(e){for(var t,r=e.length,n=r+8,i=16*((n-n%64)/64+1),o=Array(i-1),s=0,a=0;a<r;)s=a%4*8,o[t=(a-a%4)/4]=o[t]|e.charCodeAt(a)<<s,a++;return s=a%4*8,o[t=(a-a%4)/4]=o[t]|128<<s,o[i-2]=r<<3,o[i-1]=r>>>29,o}(e=function Utf8Encode(e){e=e.replace(/\r\n/g,"\n");for(var t="",r=0;r<e.length;r++){var n=e.charCodeAt(r);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128))}return t}(e)),s=1732584193,a=4023233417,c=2562383102,u=271733878,t=0;t<l.length;t+=16)r=s,n=a,i=c,o=u,a=II(a=II(a=II(a=II(a=HH(a=HH(a=HH(a=HH(a=GG(a=GG(a=GG(a=GG(a=FF(a=FF(a=FF(a=FF(a,c=FF(c,u=FF(u,s=FF(s,a,c,u,l[t+0],7,3614090360),a,c,l[t+1],12,3905402710),s,a,l[t+2],17,606105819),u,s,l[t+3],22,3250441966),c=FF(c,u=FF(u,s=FF(s,a,c,u,l[t+4],7,4118548399),a,c,l[t+5],12,1200080426),s,a,l[t+6],17,2821735955),u,s,l[t+7],22,4249261313),c=FF(c,u=FF(u,s=FF(s,a,c,u,l[t+8],7,1770035416),a,c,l[t+9],12,2336552879),s,a,l[t+10],17,4294925233),u,s,l[t+11],22,2304563134),c=FF(c,u=FF(u,s=FF(s,a,c,u,l[t+12],7,1804603682),a,c,l[t+13],12,4254626195),s,a,l[t+14],17,2792965006),u,s,l[t+15],22,1236535329),c=GG(c,u=GG(u,s=GG(s,a,c,u,l[t+1],5,4129170786),a,c,l[t+6],9,3225465664),s,a,l[t+11],14,643717713),u,s,l[t+0],20,3921069994),c=GG(c,u=GG(u,s=GG(s,a,c,u,l[t+5],5,3593408605),a,c,l[t+10],9,38016083),s,a,l[t+15],14,3634488961),u,s,l[t+4],20,3889429448),c=GG(c,u=GG(u,s=GG(s,a,c,u,l[t+9],5,568446438),a,c,l[t+14],9,3275163606),s,a,l[t+3],14,4107603335),u,s,l[t+8],20,1163531501),c=GG(c,u=GG(u,s=GG(s,a,c,u,l[t+13],5,2850285829),a,c,l[t+2],9,4243563512),s,a,l[t+7],14,1735328473),u,s,l[t+12],20,2368359562),c=HH(c,u=HH(u,s=HH(s,a,c,u,l[t+5],4,4294588738),a,c,l[t+8],11,2272392833),s,a,l[t+11],16,1839030562),u,s,l[t+14],23,4259657740),c=HH(c,u=HH(u,s=HH(s,a,c,u,l[t+1],4,2763975236),a,c,l[t+4],11,1272893353),s,a,l[t+7],16,4139469664),u,s,l[t+10],23,3200236656),c=HH(c,u=HH(u,s=HH(s,a,c,u,l[t+13],4,681279174),a,c,l[t+0],11,3936430074),s,a,l[t+3],16,3572445317),u,s,l[t+6],23,76029189),c=HH(c,u=HH(u,s=HH(s,a,c,u,l[t+9],4,3654602809),a,c,l[t+12],11,3873151461),s,a,l[t+15],16,530742520),u,s,l[t+2],23,3299628645),c=II(c,u=II(u,s=II(s,a,c,u,l[t+0],6,4096336452),a,c,l[t+7],10,1126891415),s,a,l[t+14],15,2878612391),u,s,l[t+5],21,4237533241),c=II(c,u=II(u,s=II(s,a,c,u,l[t+12],6,1700485571),a,c,l[t+3],10,2399980690),s,a,l[t+10],15,4293915773),u,s,l[t+1],21,2240044497),c=II(c,u=II(u,s=II(s,a,c,u,l[t+8],6,1873313359),a,c,l[t+15],10,4264355552),s,a,l[t+6],15,2734768916),u,s,l[t+13],21,1309151649),c=II(c,u=II(u,s=II(s,a,c,u,l[t+4],6,4149444226),a,c,l[t+11],10,3174756917),s,a,l[t+2],15,718787259),u,s,l[t+9],21,3951481745),s=AddUnsigned(s,r),a=AddUnsigned(a,n),c=AddUnsigned(c,i),u=AddUnsigned(u,o);return(WordToHex(s)+WordToHex(a)+WordToHex(c)+WordToHex(u)).toLowerCase()}t.CryptoService=n,t.MD5=MD5},"./src/sdk/services/data-store.service.ts":function(e,t,r){"use strict";var n,i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c,u,l=r("./src/sdk/decorators/index.ts"),p=r("./src/sdk/services/logging.service.ts"),d=r("./src/sdk/models/index.ts"),f=r("./src/sdk/services/db.service.ts"),h=r("./src/sdk/services/cookie.service.ts"),v=r("./src/sdk/constants.ts");!function(e){e.IDB="IDB",e.COOKIE="COOKIE",e.APP_CONTEXT="APP_CONTEXT",e.FCM_IDB="FCM_IDB"}(c=t.DataStoreSource||(t.DataStoreSource={})),function(e){e.FCM_TOKEN="FCM_TOKEN",e.UNIQUE_USER_ID="UNIQUE_USER_ID",e.UNIQUE_USER_FIRST_APPEARANCE="UNIQUE_USER_FIRST_APPEARANCE",e.LAST_UPDATED_AT="LAST_UPDATED_AT"}(u||(u={}));var _,g=[c.APP_CONTEXT,c.IDB,c.COOKIE],m=[c.IDB,c.COOKIE],b=((n={})[u.FCM_TOKEN]={appContextKey:"appContext",cookieKey:v.PUSHLY_FCM_TOKEN_COOKIE,idbKey:v.PUSHLY_DB_FCM_SUBSCRIPTION_ID_KEY,fcmIdbKey:v.FCM_DB_FCM_TOKEN_KEY,validSources:g.slice()},n[u.UNIQUE_USER_ID]={appContextKey:"uniqueUserId",cookieKey:v.PUSHLY_UNIQUE_USER_ID_COOKIE,idbKey:v.PUSHLY_DB_UNIQUE_USER_ID_KEY,validSources:g},n[u.UNIQUE_USER_FIRST_APPEARANCE]={appContextKey:"uniqueUserFirstAppearance",cookieKey:v.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_COOKIE,idbKey:v.PUSHLY_DB_UNIQUE_USER_FIRST_APPEARANCE_KEY,validSources:g},n[u.LAST_UPDATED_AT]={cookieKey:v.PUSHLY_SUBSCRIBER_DATA_UPDATED_AT_KEY,idbKey:v.PUSHLY_SUBSCRIBER_DATA_UPDATED_AT_KEY,validSources:m},n);!function(e){e.NO_UPDATE_SOURCE="Could not determine an updated source",e.NO_COOKIE_ACCESS_IN_SERVICE_WORKER="Cannot access cookies within the ServiceWorker scope",e.UNSUPPORTED_SOURCE="Unsupported DataStore source specified",e.UNSUPPORTED_KEY="Unsupported DataStore key specified",e.UNABLE_TO_RETRIEVE_KEY="Unable to retrieve key",e.UNABLE_TO_SET_KEY="Unable to set key",e.UNABLE_TO_UPDATE_COOKIE_STORE="Unable to update the COOKIE DataSource",e.UNABLE_TO_UPDATE_IDB_STORE="Unable to update the IDB DataSource",e.INVALID_FIRST_APPEARANCE_VALUE="Invalid uniqueUserFirstAppearance value - must be an integer"}(_=t.DataStoreWarning||(t.DataStoreWarning={}));var y=function(){function DataStoreService(e,t,r,n){this.appContext=e,this.dbService=t,this.cookieService=r,this.loggingService=n,this.inServiceWorkerScope=!1,self&&"WorkerGlobalScope"in self&&(this.inServiceWorkerScope=!0)}return DataStoreService.prototype.determineUpdateSource=function(){return s(this,void 0,void 0,function(){var e,t,r,n,i,o,s,u,l,p,d;return a(this,function(a){switch(a.label){case 0:if(this.inServiceWorkerScope)return[3,9];this.loggingService.once().info("Determining DataStore update source"),a.label=1;case 1:return a.trys.push([1,7,8,9]),[4,this.dbService.getConnection()];case 2:return e=a.sent(),[4,this.getSourceLastUpdated(c.COOKIE)];case 3:return r=a.sent(),[4,this.getSourceLastUpdated(c.IDB)];case 4:return n=a.sent(),i=r&&n,!r&&!n?t=c.IDB:r&&!n?t=c.COOKIE:!r&&n?t=c.IDB:i&&(o=Date.parse(r),s=Date.parse(n),o!==s&&(t=o>s?c.COOKIE:c.IDB)),[4,this.getFcmToken(c.COOKIE)];case 5:return u=a.sent(),[4,this.getFcmToken(c.IDB)];case 6:return l=a.sent(),p=!u&&!l,t&&!p||p||(!l&&u?t=c.COOKIE:l&&!u&&(t=c.IDB)),[3,9];case 7:return d=a.sent(),this.loggingService.warn(_.NO_UPDATE_SOURCE,d),[3,9];case 8:return e&&e.close(),[7];case 9:return t?this.loggingService.once().info("DataStore update required - Sourced from "+t):this.loggingService.once().info("No DataStore update required"),[2,t]}})})},DataStoreService.prototype.autoUpdateSubscriptionData=function(){return s(this,void 0,void 0,function(){var e,t,r,n,i,o,s;return a(this,function(a){switch(a.label){case 0:return e=this.getCurrentTimestamp(),[4,this.determineUpdateSource()];case 1:return(t=a.sent())?(r=void 0,n=void 0,i=void 0,o=void 0,s=void 0,t!==c.COOKIE?[3,7]:this.inServiceWorkerScope?(this.loggingService.warn(_.NO_COOKIE_ACCESS_IN_SERVICE_WORKER),[3,7]):[3,2]):[3,14];case 2:return[4,this.getFcmToken(c.COOKIE)];case 3:return r=a.sent(),[4,this.getUniqueUserId(c.COOKIE)];case 4:return n=a.sent(),[4,this.getUniqueUserFirstAppearance(c.COOKIE)];case 5:return i=a.sent(),[4,this.getSourceLastUpdated(c.COOKIE)];case 6:o=a.sent()||e,s=this.updateIDBStore.bind(this),a.label=7;case 7:return t!==c.IDB?[3,12]:[4,this.getFcmToken(c.IDB)];case 8:return r=a.sent(),[4,this.getUniqueUserId(c.IDB)];case 9:return n=a.sent(),[4,this.getUniqueUserFirstAppearance(c.IDB)];case 10:return i=a.sent(),[4,this.getSourceLastUpdated(c.IDB)];case 11:o=a.sent()||e,s=this.updateCookieStore.bind(this),a.label=12;case 12:return s?(i&&(i=this.ensureUniqueUserFirstAppearanceTime(i)),[4,s(r,n,i,o)]):[3,14];case 13:a.sent(),this.updateAppContextStore(r,n,i),a.label=14;case 14:return[2,this]}})})},DataStoreService.prototype.getSourceLastUpdated=function(e){return s(this,void 0,void 0,function(){return a(this,function(t){return[2,this.getValueByKey(e,u.LAST_UPDATED_AT)]})})},DataStoreService.prototype.resolveFcmToken=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,this.resolve(u.FCM_TOKEN,g.slice())]})})},DataStoreService.prototype.resolveUniqueUserId=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,this.resolve(u.UNIQUE_USER_ID)]})})},DataStoreService.prototype.getFcmToken=function(e){return void 0===e&&(e=c.APP_CONTEXT),s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.getValueByKey(e,u.FCM_TOKEN)];case 1:return[2,t.sent()]}})})},DataStoreService.prototype.getUniqueUserId=function(e){return void 0===e&&(e=c.APP_CONTEXT),s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.getValueByKey(e,u.UNIQUE_USER_ID)];case 1:return[2,t.sent()]}})})},DataStoreService.prototype.getUniqueUserFirstAppearance=function(e){return void 0===e&&(e=c.APP_CONTEXT),s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.getValueByKey(e,u.UNIQUE_USER_FIRST_APPEARANCE)];case 1:return[2,t.sent()]}})})},DataStoreService.prototype.setFcmToken=function(e){return s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return null===e||void 0===e?[3,2]:[4,this.setValueByKey(u.FCM_TOKEN,e)];case 1:t.sent(),t.label=2;case 2:return[2,this]}})})},DataStoreService.prototype.setUniqueUserId=function(e){return s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.setValueByKey(u.UNIQUE_USER_ID,e)];case 1:return[2,t.sent()]}})})},DataStoreService.prototype.setUniqueUserFirstAppearance=function(e){return s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return e=this.ensureUniqueUserFirstAppearanceTime(e),[4,this.setValueByKey(u.UNIQUE_USER_FIRST_APPEARANCE,e)];case 1:return[2,t.sent()]}})})},DataStoreService.prototype.resolve=function(e,t){return void 0===t&&(t=g),s(this,void 0,void 0,function(){var r,n,i,o,s;return a(this,function(a){switch(a.label){case 0:i=0,o=t,a.label=1;case 1:return i<o.length?(s=o[i],r?[3,3]:(n=s,[4,this.getValueByKey(s,e)])):[3,4];case 2:r=a.sent(),a.label=3;case 3:return i++,[3,1];case 4:return r&&n!==c.APP_CONTEXT?[4,this.setValueByKey(e,r)]:[3,6];case 5:a.sent(),a.label=6;case 6:return[2,r]}})})},DataStoreService.prototype.getValueByKey=function(e,t){return s(this,void 0,void 0,function(){var r,n,i;return a(this,function(o){switch(o.label){case 0:return(i=b[t])?[3,1]:(this.loggingService.warn(_.UNSUPPORTED_KEY+" - ["+t+"]"),[3,11]);case 1:return-1!==i.validSources.indexOf(e)?[3,2]:(this.loggingService.warn(_.UNSUPPORTED_SOURCE+" - ["+e+"]"),[3,11]);case 2:switch(o.trys.push([2,9,10,11]),e){case c.APP_CONTEXT:return[3,3];case c.COOKIE:return[3,4];case c.IDB:return[3,5]}return[3,8];case 3:return r=this.appContext[i.appContextKey],[3,8];case 4:return this.inServiceWorkerScope?this.loggingService.warn(_.NO_COOKIE_ACCESS_IN_SERVICE_WORKER):r=this.cookieService.getCookie(i.cookieKey),[3,8];case 5:return[4,this.dbService.getConnection()];case 6:return[4,(n=o.sent()).get(i.idbKey,void 0,!0)];case 7:return r=o.sent(),[3,8];case 8:return[3,11];case 9:return o.sent(),this.loggingService.warn(_.UNABLE_TO_RETRIEVE_KEY+" - ["+t+"]"),[3,11];case 10:return n&&n.close(),[7];case 11:return[2,r]}})})},DataStoreService.prototype.setValueByKey=function(e,t){return s(this,void 0,void 0,function(){var r,n,i,o;return a(this,function(s){switch(s.label){case 0:return i=b[e],o=this.getCurrentTimestamp(),i?[3,1]:(this.loggingService.warn(_.UNSUPPORTED_KEY+" - ["+e+"]"),[3,7]);case 1:this.loggingService.info("Updating DataStore key ["+e+"] to: "+t),s.label=2;case 2:return s.trys.push([2,5,6,7]),this.appContext[i.appContextKey]=t,this.inServiceWorkerScope?this.loggingService.warn(_.NO_COOKIE_ACCESS_IN_SERVICE_WORKER):(this.cookieService.setCookie(i.cookieKey,t),this.cookieService.setCookie(v.PUSHLY_SUBSCRIBER_DATA_UPDATED_AT_KEY,o)),[4,this.dbService.getConnection()];case 3:return[4,(n=s.sent()).mset((r={},r[i.idbKey]=t,r[v.PUSHLY_SUBSCRIBER_DATA_UPDATED_AT_KEY]=o,r),!0)];case 4:return s.sent(),[3,7];case 5:return s.sent(),this.loggingService.warn(_.UNABLE_TO_SET_KEY+" - ["+e+"]"),[3,7];case 6:return n&&n.close(),[7];case 7:return[2,this]}})})},DataStoreService.prototype.getCurrentTimestamp=function(){return(new Date).toISOString()},DataStoreService.prototype.ensureUniqueUserFirstAppearanceTime=function(e){if(e&&"number"!=typeof e)try{e=parseInt(e.toString(),10)}catch(t){this.loggingService.warn(_.INVALID_FIRST_APPEARANCE_VALUE),e=(new Date).getTime()}return e},DataStoreService.prototype.updateAppContextStore=function(e,t,r){e&&t&&(this.appContext.fcmToken=e,this.appContext.uniqueUserId=t,this.appContext.uniqueUserFirstAppearance=r)},DataStoreService.prototype.updateCookieStore=function(e,t,r,n){return s(this,void 0,void 0,function(){return a(this,function(i){if(this.inServiceWorkerScope)this.loggingService.warn(_.NO_COOKIE_ACCESS_IN_SERVICE_WORKER);else try{e&&t&&n&&(this.cookieService.setCookie(v.PUSHLY_FCM_TOKEN_COOKIE,e),this.cookieService.setCookie(v.PUSHLY_UNIQUE_USER_ID_COOKIE,t),this.cookieService.setCookie(v.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_COOKIE,r),this.cookieService.setCookie(v.PUSHLY_SUBSCRIBER_DATA_UPDATED_AT_KEY,n))}catch(e){this.loggingService.warn(_.UNABLE_TO_UPDATE_COOKIE_STORE)}return[2]})})},DataStoreService.prototype.updateIDBStore=function(e,t,r,n){return s(this,void 0,void 0,function(){var i,o;return a(this,function(s){switch(s.label){case 0:return s.trys.push([0,4,5,6]),e&&t&&n?[4,this.dbService.getConnection()]:[3,3];case 1:return[4,(o=s.sent()).mset((i={},i[v.PUSHLY_DB_FCM_SUBSCRIPTION_ID_KEY]=e,i[v.PUSHLY_DB_UNIQUE_USER_ID_KEY]=t,i[v.PUSHLY_DB_UNIQUE_USER_FIRST_APPEARANCE_KEY]=r,i[v.PUSHLY_SUBSCRIBER_DATA_UPDATED_AT_KEY]=n,i),!0)];case 2:s.sent(),s.label=3;case 3:return[3,6];case 4:return s.sent(),this.loggingService.warn(_.UNABLE_TO_UPDATE_IDB_STORE),[3,6];case 5:return o&&o.close(),[7];case 6:return[2]}})})},DataStoreService=i([l.inject(),o("design:paramtypes",[d.AppContext,f.DbService,h.CookieService,p.LoggingService])],DataStoreService)}();t.DataStoreService=y},"./src/sdk/services/db.service.ts":function(e,t,r){"use strict";var n=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var a=r("./src/sdk/models/index.ts"),c=r("./src/sdk/constants.ts"),u=r("./src/sdk/decorators/index.ts"),l=r("./src/sdk/services/logging.service.ts"),p=function(){function DbService(e){this.loggingService=e}return DbService.prototype.getConnection=function(){return o(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,(e=new a.DbConnection(c.PUSHLY_DB_NAME,c.PUSHLY_STORE_NAME,this.loggingService)).connect()];case 1:return t.sent(),[2,e]}})})},DbService=n([u.inject(),i("design:paramtypes",[l.LoggingService])],DbService)}();t.DbService=p},"./src/sdk/services/environment.service.ts":function(e,t,r){"use strict";var n=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var a=r("./node_modules/@firebase/app/dist/index.cjs.js");r("./node_modules/@firebase/messaging/dist/index.esm.js");var c=r("./src/sdk/enums/index.ts"),u=r("./src/sdk/decorators/index.ts"),l=r("./src/sdk/models/index.ts"),p=r("./src/sdk/constants.ts"),d=r("./src/sdk/services/db.service.ts"),f=r("./src/sdk/services/cookie.service.ts"),h=r("./src/sdk/services/data-store.service.ts"),v=function(){function EnvironmentService(e,t,r,n){this.appContext=e,this.cookieService=t,this.dbService=r,this.dataStoreService=n}var e;return e=EnvironmentService,EnvironmentService.prototype.isSecure=function(){var e=this.getGlobalScope();return"https:"===e.location.protocol||"localhost"===e.location.hostname||"127.0.0.1"===e.location.hostname},EnvironmentService.prototype.setKnownEnvironment=function(t){e.knownEnvironment=t},EnvironmentService.prototype.getRuntimeEnvironmentType=function(){return e.knownEnvironment?e.knownEnvironment:"WorkerGlobalScope"in this.getGlobalScope()?c.RuntimeEnvironmentType.ServiceWorker:this.isUsingProxyIntegration()?this.urlContainsProxyUrl()?c.RuntimeEnvironmentType.ProxyDialog:c.RuntimeEnvironmentType.Proxy:c.RuntimeEnvironmentType.Direct},EnvironmentService.prototype.isPushNotificationsSupported=function(){var e=this.getGlobalScope();return"ServiceWorker"in e&&"PushManager"in e},EnvironmentService.prototype.urlContainsProxyUrl=function(e){void 0===e&&(e=null);var t=this.getGlobalScope();return null===e&&(e=t.location.toString()),-1!==e.indexOf(this.appContext.settings.domain.custom_allow_domain)},EnvironmentService.prototype.getSubscriptionEndpoint=function(){return o(this,void 0,void 0,function(){var e,t;return s(this,function(r){switch(r.label){case 0:return[4,this.getGlobalScope().navigator.serviceWorker.getRegistration()];case 1:return(e=r.sent())?[4,e.pushManager.getSubscription()]:[3,3];case 2:if(t=r.sent())return[2,t.endpoint];r.label=3;case 3:return[2,null]}})})},EnvironmentService.prototype.isUsingProxyIntegration=function(){return!!this.appContext.settings.domain.custom_allow_domain},EnvironmentService.prototype.isSupported=function(){return o(this,void 0,void 0,function(){var e,t,r,n,i,o,c;return s(this,function(s){switch(s.label){case 0:return e=this.getGlobalScope(),[4,new Promise(function(t,r){"webkitRequestFileSystem"in e?e.webkitRequestFileSystem(0,0,function(){return t(!1)},function(){return t(!0)}):t(!1)})];case 1:t=s.sent(),n=(r=/bot|HeadlessChrome|googlebot|crawler|spider|robot|crawling/im).test(navigator.userAgent)||r.test(navigator.appVersion)||r.test(navigator.appCodeName)||r.test(navigator.product),i=/iphone|ipad/i.test(navigator.userAgent)||navigator.platform&&/iphone|ipad/i.test(navigator.platform),o=!0;try{o=!!e.location.host&&!!e.location.hostname&&!!e.location.hostname.split("")}catch(e){o=!1}return c=o&&"PushManager"in e&&"navigator"in e&&"userAgent"in e.navigator&&"indexedDB"in e&&navigator.cookieEnabled&&!i&&!t&&!n,this.isSecure()&&(c=c&&a.default.messaging.isSupported()&&"ServiceWorker"in e&&"serviceWorker"in e.navigator),[2,c]}})})},EnvironmentService.prototype.isUserOptedOut=function(){return o(this,void 0,void 0,function(){return s(this,function(e){return[2,this.cookieService.hasCookie(p.PUSHLY_UNSUBSCRIBED_COOKIE)]})})},EnvironmentService.prototype.isUserSubscribed=function(){var e=!!this.appContext.fcmToken;return this.cookieService.hasCookie(p.PUSHLY_PROMPT_SUBSCRIBED_COOKIE)&&!this.cookieService.hasCookie(p.PUSHLY_UNSUBSCRIBED_COOKIE)||e},EnvironmentService.prototype.isBrowserPermissionGranted=function(){return"granted"===this.getGlobalScope().Notification.permission},EnvironmentService.prototype.hasLegacySubscription=function(){for(var e=0,t=this.cookieService.getCookieKeys();e<t.length;e++){if(-1!==t[e].indexOf("copush_subscription_id"))return!0}return!1},EnvironmentService.prototype.setFcmSubscriptionId=function(e){return o(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return[4,this.dataStoreService.setFcmToken(e)];case 1:return t.sent(),this.cookieService.clearCookie(p.PUSHLY_UNSUBSCRIBED_COOKIE),this.cookieService.setCookie(p.PUSHLY_PROMPT_SUBSCRIBED_COOKIE,!0,p.PUSHLY_PROMPT_SUBSCRIBED_COOKIE_TIMEOUT),[2]}})})},EnvironmentService.prototype.setBlocked=function(e,t,r){void 0===t&&(t=1825),void 0===r&&(r="d"),this.appContext.disabled=e,e?this.cookieService.setCookie(p.PUSHLY_PROMPT_BLOCKED_COOKIE,!0,t,r):this.cookieService.clearCookie(p.PUSHLY_PROMPT_BLOCKED_COOKIE)},EnvironmentService.prototype.setDismissed=function(e,t,r){void 0===t&&(t=p.PUSHLY_PROMPT_DISMISSED_COOKIE_TIMEOUT),void 0===r&&(r="d"),e?this.cookieService.setCookie(p.PUSHLY_PROMPT_DISMISSED_COOKIE,!0,t,r):this.cookieService.clearCookie(p.PUSHLY_PROMPT_DISMISSED_COOKIE)},EnvironmentService.prototype.isBlocked=function(){return"true"===this.cookieService.getCookie(p.PUSHLY_PROMPT_BLOCKED_COOKIE)},EnvironmentService.prototype.isDismissed=function(){return"true"===this.cookieService.getCookie(p.PUSHLY_PROMPT_DISMISSED_COOKIE)},EnvironmentService.prototype.isSafari=function(){return"safari"in self},EnvironmentService.prototype.isSafariPushCapable=function(){return this.isSafari()&&"pushNotification"in self.safari},EnvironmentService.prototype.isUserPromptEligible=function(){return o(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,this.isSupported()];case 1:return(e=t.sent())?[4,this.isUserOptedOut()]:[3,3];case 2:e=!t.sent(),t.label=3;case 3:return[2,e&&!this.isUserSubscribed()&&!this.isBlocked()&&!this.isDismissed()]}})})},EnvironmentService.prototype.isUserCustomPromptEligible=function(){return o(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,this.isSupported()];case 1:return(e=t.sent())?[4,this.isUserOptedOut()]:[3,3];case 2:e=!t.sent(),t.label=3;case 3:return[2,e&&!this.isBlocked()&&!this.isDismissed()]}})})},EnvironmentService.prototype.getGlobalScope=function(){return"WorkerGlobalScope"in self?self:window},EnvironmentService=e=n([u.inject(),i("design:paramtypes",[l.AppContext,f.CookieService,d.DbService,h.DataStoreService])],EnvironmentService)}();t.EnvironmentService=v},"./src/sdk/services/events.service.ts":function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/decorators/index.ts"),u=r("./src/sdk/models/index.ts"),l=r("./src/sdk/services/environment.service.ts"),p=r("./src/sdk/constants.ts"),d=r("./src/sdk/enums/index.ts"),f=r("./src/sdk/services/logging.service.ts"),h=r("./src/sdk/utils/delay.ts"),v=r("./src/sdk/utils/index.ts"),_=r("./src/sdk/services/db.service.ts"),g=r("./src/sdk/services/data-store.service.ts"),m=function(){function EventsService(e,t,r,n,i){this.environmentService=e,this.loggingService=t,this.dbService=r,this.dataStoreService=n,this.appContext=i}return EventsService.prototype.putEvent=function(e,t){return void 0===t&&(t=0),s(this,void 0,void 0,function(){var r,i,o,s,c,u,l,f,_,g,m,b,y,S=this;return a(this,function(a){switch(a.label){case 0:r=this.environmentService.getGlobalScope(),i=n({domain_id:this.appContext.settings.domain.id,event_date:(new Date).toISOString()},e),a.label=1;case 1:return a.trys.push([1,8,,9]),[4,this.dataStoreService.resolveFcmToken()];case 2:return o=a.sent(),[4,this.dataStoreService.resolveUniqueUserId()];case 3:s=a.sent(),c=this.environmentService.getRuntimeEnvironmentType()===d.RuntimeEnvironmentType.ServiceWorker?p.PUSHLY_SW_APPLICATION_NAME:p.PUSHLY_SDK_APPLICATION_NAME,u=void 0,l=void 0;try{u=Intl.DateTimeFormat().resolvedOptions().locale,l=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}return f=n({source:{application:c,version:"bf1d6794b4e27ed2c53b215b2fa7aace95e4cdb7"},fcm_subscription_id:o,pushly_unique_user_id:s,page_url:r.location.toString(),language:u,time_zone:l},e.meta||{}),this.appContext.workerSessionId&&(f.worker_session_id=this.appContext.workerSessionId),[4,h.delayRandom(t)];case 4:return _=a.sent(),f.jitter=_,i.meta=f,g={headers:{"content-type":"application/json"},method:"POST",body:JSON.stringify(i)},m=v.randomString(),[4,this.recordEventLocally(m,g,i)];case 5:return a.sent(),[4,v.retryFetch("https://kraken.p-n.io/event-stream",g,function(){S.loggingService.warn("Retrying Events Fetch","https://kraken.p-n.io/event-stream",i.action)})];case 6:return b=a.sent(),[4,this.recordEventLocally(m,b,i)];case 7:return a.sent(),b.ok||this.loggingService.error("Events endpoint returned with status "+b.statusText),[3,9];case 8:return(y=a.sent())&&(y.context={event:i}),this.loggingService.error(y),[3,9];case 9:return[2]}})})},EventsService.prototype.setEventLogDebugEnabled=function(e){return void 0===e&&(e=!0),s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return[4,this.dbConn()];case 1:return[4,(t=r.sent()).set("event_log_debug_enabled",e,!0)];case 2:return r.sent(),e?[3,4]:[4,t.set("__event_logs__",void 0,!0)];case 3:r.sent(),r.label=4;case 4:return[2]}})})},EventsService.prototype.getEventsFromDebug=function(e){return void 0===e&&(e={}),s(this,void 0,void 0,function(){var t,r,n,i;return a(this,function(o){switch(o.label){case 0:return t=e.json||!1,[4,this.dbConn()];case 1:return[4,(r=o.sent()).get("event_log_debug_enabled",!1,!0)];case 2:return n=o.sent(),[4,r.get("__event_logs__",[],!0)];case 3:return i=o.sent(),n?[2,t?i.map(function(e){return JSON.parse(e)}):i]:(this.loggingService.warn("Event log debug has not been enabled"),[2])}})})},EventsService.prototype.recordEventLocally=function(e,t,r){return s(this,void 0,void 0,function(){var n,i,o,s,c,u,l;return a(this,function(a){switch(a.label){case 0:return[4,this.dbConn()];case 1:return[4,(n=a.sent()).get("event_log_debug_enabled",!1,!0)];case 2:return i=a.sent(),[4,n.get("__event_logs__",[],!0)];case 3:if(o=a.sent(),!i)return[3,12];a.label=4;case 4:if(a.trys.push([4,11,,12]),s={key:e,event_date:r.event_date,type:"REQUEST",action:r.action,data:t},!(t instanceof Response))return[3,9];c=t.headers,u=t.body,a.label=5;case 5:return a.trys.push([5,7,,8]),[4,t.json()];case 6:return u=a.sent(),[3,8];case 7:return a.sent(),[3,8];case 8:s.type="RESPONSE",s.data={ok:t.ok,headers:c&&c.getAll?c.getAll():c,redirected:t.redirected,status:t.status,statusText:t.statusText,type:t.type,url:t.url,body:u},a.label=9;case 9:return Array.isArray(o)||(o=[]),o.length>=20&&o.pop(),o.unshift(JSON.stringify(s)),[4,n.set("__event_logs__",o,!0)];case 10:return a.sent(),[3,12];case 11:return l=a.sent(),this.loggingService.warn("Unable to save event locally",l),[3,12];case 12:return[2]}})})},EventsService.prototype.dbConn=function(){return s(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return this.db?[3,2]:(e=this,[4,this.dbService.getConnection()]);case 1:e.db=t.sent(),t.label=2;case 2:return[2,this.db]}})})},EventsService=i([c.inject(),o("design:paramtypes",[l.EnvironmentService,f.LoggingService,_.DbService,g.DataStoreService,u.AppContext])],EventsService)}();t.EventsService=m},"./src/sdk/services/index.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/services/environment.service.ts");t.EnvironmentService=n.EnvironmentService;var i=r("./src/sdk/services/settings.service.ts");t.SettingsService=i.SettingsService;var o=r("./src/sdk/services/registration-service.ts");t.RegistrationService=o.RegistrationService;var s=r("./src/sdk/services/events.service.ts");t.EventsService=s.EventsService;var a=r("./src/sdk/services/cookie.service.ts");t.CookieService=a.CookieService;var c=r("./src/sdk/services/profile.service.ts");t.ProfileService=c.ProfileService;var u=r("./src/sdk/services/crypto.service.ts");t.CryptoService=u.CryptoService;var l=r("./src/sdk/services/db.service.ts");t.DbService=l.DbService;var p=r("./src/sdk/services/amp-message-broker.ts");t.AmpMessageBroker=p.AmpMessageBroker;var d=r("./src/sdk/services/logging.service.ts");t.LoggingService=d.LoggingService;var f=r("./src/sdk/services/session.service.ts");t.SessionService=f.SessionService;var h=r("./src/sdk/services/data-store.service.ts");t.DataStoreService=h.DataStoreService},"./src/sdk/services/logging.service.ts":function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0});var s=r("./node_modules/error-stack-parser/error-stack-parser.js"),a=r("./src/sdk/decorators/index.ts"),c=r("./src/sdk/constants.ts"),u=r("./src/sdk/models/index.ts"),l=r("./src/sdk/enums/index.ts"),p=r("./src/sdk/utils/index.ts"),d=[c.ENV_NAME_DEV,c.ENV_NAME_LOCAL,c.ENV_NAME_STAGING],f=[c.ENV_NAME_LOCAL,c.ENV_NAME_LOCAL_PRODUCTION,c.ENV_NAME_PRODUCTION],h=function(){function LoggingService(e){this.appContext=e,this.logs=[],this.logOnce=!1,this.plugins=[];var t="WorkerGlobalScope"in self?self:window;try{if("navigator"in t&&"plugins"in t.navigator)for(var r=0;r<t.navigator.plugins.length;r++)this.plugins.push(t.navigator.plugins[r].name)}catch(e){this.plugins.push("unable to collect plugin information")}}return LoggingService.prototype.print=function(e,t){var r="string"==typeof t?"["+this.getApplicationName()+"] "+t:t;console[e].apply(console,[r])},LoggingService.prototype.streamError=function(e){var t=this;e=n({},e,{source:{application:this.getApplicationName(),version:"bf1d6794b4e27ed2c53b215b2fa7aace95e4cdb7"},page_url:"WorkerGlobalScope"in self?self.location.toString():window.location.toString(),fcm_subscription_id:this.appContext.fcmToken,pushly_unique_user_id:this.appContext.uniqueUserId});var r={action:l.EventAction.Error,domain_id:this.appContext.settings.domain.id,event_date:(new Date).toISOString(),meta:e};p.retryFetch("https://kraken.p-n.io/event-stream",{headers:{"content-type":"application/json"},method:"POST",body:JSON.stringify(r)},function(){t.warn("Retrying Error Fetch","https://kraken.p-n.io/event-stream")})},LoggingService.prototype.getApplicationName=function(){return"WorkerGlobalScope"in self?c.PUSHLY_SW_APPLICATION_NAME:c.PUSHLY_SDK_APPLICATION_NAME},LoggingService.prototype.getBacktrace=function(e){var t=[];try{s.parse(e).forEach(function(e){t.push({file:e.fileName,line:e.lineNumber,function:e.functionName})})}catch(e){t.push({file:"logging.service.ts",line:"1",function:"getBacktrace"})}return t},LoggingService.prototype.once=function(){return this.logOnce=!0,this},LoggingService.prototype.info=function(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];t=this.getPrepareRequestLogs(t),this.logs=Array.prototype.concat(this.logs,t.map(function(e){return["info",e]})),(this.appContext.visibleLogsEnabled||-1!==d.indexOf("production"))&&t.forEach(function(t){e.print("log",t)})},LoggingService.prototype.warn=function(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];t=this.getPrepareRequestLogs(t),this.logs=Array.prototype.concat(this.logs,t.map(function(e){return["warn",e]})),t.forEach(function(t){e.print("warn",t)})},LoggingService.prototype.error=function(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(t=this.getPrepareRequestLogs(t),this.logs=Array.prototype.concat(this.logs,t.map(function(e){return["error",e]})),(this.appContext.visibleLogsEnabled||-1!==d.indexOf("production"))&&t.forEach(function(t){e.print("error",t)}),-1!==f.indexOf("production")&&t.length>0){var n=0,i=[];this.logs.forEach(function(e){var t=e[0],r=e[1]instanceof Error?e[1].message:e[1];i.push([t,r])}),t.length>1&&-1===(n=t.findIndex(function(e){return e instanceof Error}))&&(n=0);var o=t.splice(n,1);o&&o.length>0?o=o[0]:(o=new Error("Cannot resolve error from logs")).code="sw/cannot-resolve-error-from-logs";var s=o instanceof Error?o:new Error(o);if(s instanceof Error){var a={error_type:s.name,error_message:s.message,backtrace:this.getBacktrace(s),logs:i,plugins:this.plugins},c=s,u=c.context,l=c.code;u&&(a.context=u),l&&(a.error_code=l),this.streamError(a)}}this.resetOnceFlag()},LoggingService.prototype.getPrepareRequestLogs=function(e){var t=this,r=e;return this.logOnce&&(r=r.filter(function(e){return-1===t.logs.map(function(e){return e.join("::")}).indexOf("info::"+e)})),this.resetOnceFlag(),r},LoggingService.prototype.resetOnceFlag=function(){this.logOnce=!1},LoggingService=i([a.inject(),o("design:paramtypes",[u.AppContext])],LoggingService)}();t.LoggingService=h},"./src/sdk/services/profile.service.ts":function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./src/sdk/decorators/index.ts"),u=r("./src/sdk/models/index.ts"),l=r("./src/sdk/services/logging.service.ts"),p=r("./src/sdk/services/db.service.ts"),d=r("./src/sdk/constants.ts"),f=r("./src/sdk/services/crypto.service.ts"),h=r("./src/sdk/utils/delay.ts"),v=r("./src/sdk/utils/index.ts"),_=function(){function ProfileService(e,t,r,n){this.appContext=e,this.loggingService=t,this.dbService=r,this.cryptoService=n}return ProfileService.prototype.saveUserTags=function(e,t,r){return void 0===r&&(r=0),s(this,void 0,void 0,function(){return a(this,function(r){switch(r.label){case 0:return[4,this.patchProfile({domain_id:this.appContext.settings.domain.id,fcm_subscription_id:e,tag:t})];case 1:return r.sent(),[2]}})})},ProfileService.prototype.removeUserTags=function(e,t,r){return void 0===r&&(r=0),s(this,void 0,void 0,function(){return a(this,function(r){switch(r.label){case 0:return[4,this.patchProfile({domain_id:this.appContext.settings.domain.id,fcm_subscription_id:e,untag:t})];case 1:return r.sent(),[2]}})})},ProfileService.prototype.saveUserEvent=function(e,t){return s(this,void 0,void 0,function(){return a(this,function(r){switch(r.label){case 0:return[4,this.patchProfile({domain_id:this.appContext.settings.domain.id,fcm_subscription_id:e,event:[t]})];case 1:return r.sent(),[2]}})})},ProfileService.prototype.saveUserProfileData=function(e,t){return s(this,void 0,void 0,function(){return a(this,function(r){switch(r.label){case 0:return[4,this.patchProfile({domain_id:this.appContext.settings.domain.id,fcm_subscription_id:e,profile:t})];case 1:return r.sent(),[2]}})})},ProfileService.prototype.saveExternalUserId=function(e,t){return s(this,void 0,void 0,function(){return a(this,function(r){switch(r.label){case 0:return[4,this.patchProfile({domain_id:this.appContext.settings.domain.id,fcm_subscription_id:e,profile:{external_user_id:t}})];case 1:return r.sent(),[2]}})})},ProfileService.prototype.patchProfile=function(e,t){return void 0===t&&(t=0),s(this,void 0,void 0,function(){var r,i,o,s=this;return a(this,function(a){switch(a.label){case 0:return this.loggingService.info("Patching profile."),t&&t>0?[4,h.delayRandom(t)]:[3,2];case 1:a.sent(),a.label=2;case 2:return a.trys.push([2,10,,11]),[4,this.upsertLocalProfileDocument(e)];case 3:if(!a.sent())return[3,8];this.loggingService.info("Changes made to local profile document. Sending update to server."),a.label=4;case 4:return a.trys.push([4,6,,7]),[4,v.retryFetch("https://kraken.p-n.io/event-stream",{headers:{"content-type":"application/json"},method:"POST",body:JSON.stringify(n({action:"profile",event_date:(new Date).toISOString()},e))},function(){s.loggingService.warn("Retrying Profile Fetch","https://kraken.p-n.io/event-stream","profile")})];case 5:return(r=a.sent()).ok||this.loggingService.error("Events [profile] endpoint returned with status "+r.statusText),[3,7];case 6:return(i=a.sent())&&(i.context={method:"ProfileService.patchProfile",document:e}),this.loggingService.error(i),[3,7];case 7:return[3,9];case 8:this.loggingService.info("No changes made to local profile document. No update to send."),a.label=9;case 9:return[3,11];case 10:return(o=a.sent())&&(o.context={method:"ProfileService.patchProfile",document:e}),this.loggingService.error(o),[3,11];case 11:return[2]}})})},ProfileService.prototype.upsertLocalProfileDocument=function(e){return s(this,void 0,void 0,function(){var t,r,i,o,s,c,u,l,p,f,h,v,_,g;return a(this,function(a){switch(a.label){case 0:return t=!1,r=n({},e),i=r.event,o=r.tag,delete r.event,delete r.tag,i?(t=!0,[3,6]):[3,1];case 1:return s=this.flathashObject(r),[4,this.dbService.getConnection()];case 2:return[4,(c=a.sent()).get(d.PUSHLY_DB_LOCAL_PROFILE_DOCUMENT_KEY,{})];case 3:if(u=a.sent(),o){for(l=u.tags||[],p=0,f=o;p<f.length;p++)h=f[p],v=this.cryptoService.md5(h),-1===l.indexOf(v)&&(t=!0,l.push(v));u.tags=l}if(!t)for(_ in s)if(s[_]!==u[_]){t=!0;break}return t?(g=n({},u,s),[4,c.set(d.PUSHLY_DB_LOCAL_PROFILE_DOCUMENT_KEY,g)]):[3,5];case 4:a.sent(),a.label=5;case 5:c.close(),a.label=6;case 6:return[2,t]}})})},ProfileService.prototype.flathashObject=function(e,t){void 0===t&&(t=[]);try{for(var r=n({},e),i=Object.keys(r),o=0,s=i;o<s.length;o++){var a=s[o],c=r[a];if(delete r[a],c instanceof Object&&!(c instanceof Array))r=n({},r,this.flathashObject(c,t.concat(a)));else{var u=this.cryptoService.md5(t.concat(a).join(".")),l=this.cryptoService.md5(String(c));r[u]=l}}return r}catch(e){this.loggingService.error(e)}},ProfileService=i([c.inject(),o("design:paramtypes",[u.AppContext,l.LoggingService,p.DbService,f.CryptoService])],ProfileService)}();t.ProfileService=_},"./src/sdk/services/registration-service.ts":function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=r("./node_modules/@firebase/app/dist/index.cjs.js");r("./node_modules/@firebase/messaging/dist/index.esm.js");var u=r("./src/sdk/web-event-bus.ts"),l=r("./src/sdk/enums/index.ts"),p=r("./src/sdk/decorators/index.ts"),d=r("./src/sdk/models/index.ts"),f=r("./src/sdk/utils/index.ts"),h=r("./src/sdk/services/events.service.ts"),v=r("./src/sdk/services/cookie.service.ts"),_=r("./src/sdk/services/logging.service.ts"),g=r("./src/sdk/services/db.service.ts"),m=r("./src/sdk/services/environment.service.ts"),b=r("./src/sdk/constants.ts"),y=r("./src/sdk/enums/sdk-error.enum.ts"),S=r("./src/sdk/services/profile.service.ts"),w=r("./src/sdk/services/data-store.service.ts"),E=function(){function RegistrationService(e,t,r,n,i,o,s,a){this.appContext=e,this.loggingService=t,this.eventsService=r,this.cookieService=n,this.environmentService=i,this.dbService=o,this.dataStoreService=s,this.profileService=a}return RegistrationService.prototype.tryRegistration=function(e,t){return void 0===e&&(e=null),s(this,void 0,void 0,function(){var r,n,i,o,s,c,p;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,6,,7]),r=e?e.id:null,n=f.parseQueryString(window.location.search),b.PUSHLY_PROMPT_ID_QS in n&&(r=n[b.PUSHLY_PROMPT_ID_QS]),i=window.location.toString(),b.PUSHLY_SUBSCRIBED_URL_QS in n&&(i=decodeURIComponent(n[b.PUSHLY_SUBSCRIBED_URL_QS])),[4,this.requestNotificationPermissions(r)];case 1:return(o=a.sent())?(this.loggingService.info("Got token: "+o),[4,this.environmentService.getSubscriptionEndpoint()]):[3,5];case 2:return s=a.sent(),c={subscription_endpoint:s,fcm_subscription_id:o,subscribed_url:i,prompt_id:r,domain_key:this.appContext.domainKey,amp:this.environmentService.getRuntimeEnvironmentType()===l.RuntimeEnvironmentType.AmpPermissionDialog},r&&t&&(c.tag=t),[4,this.registerToken(c)];case 3:return a.sent(),[4,this.environmentService.setFcmSubscriptionId(o)];case 4:a.sent(),this.loggingService.info("Subscribed"),u.WebEventBus.dispatch("subscribed",o),a.label=5;case 5:return[3,7];case 6:return p=a.sent(),this.loggingService.error(p),[3,7];case 7:return[2]}})})},RegistrationService.prototype.tryMigration=function(){return s(this,void 0,void 0,function(){var e,t,r,n,i,o,s,u,p;return a(this,function(a){switch(a.label){case 0:e=/push service not available/i,a.label=1;case 1:return a.trys.push([1,12,,13]),[4,this.environmentService.isUserOptedOut()];case 2:if(a.sent())return this.loggingService.info("User has chosen to unsubscribe. Skipping migration check"),[2];this.loggingService.info("Checking for required migration"),t=c.default.messaging(),r=null,a.label=3;case 3:return a.trys.push([3,5,,6]),[4,t.getToken()];case 4:return r=a.sent(),[3,6];case 5:if(n=a.sent(),this.appContext.disabled=!0,p=(u=n||{}).message&&e.test(u.message),u.code===y.SdkError.PUSH_SERVICE_NOT_AVAILABLE||p)return this.loggingService.warn(n),[2];if(u.code===y.SdkError.FCM_NOTIFICATIONS_BLOCKED)return this.loggingService.info("Notification Permissions Blocked"),[2];if(u.code===y.SdkError.FCM_NOTIFICATIONS_DEFAULT)return this.loggingService.info("Notification Permissions Dismissed"),[2];if(u.code===y.SdkError.FCM_FAILED_SERVICE_WORKER_REGISTRATION)return this.loggingService.warn(n),[2];if(u.code===y.SdkError.FCM_SUBSCRIPTION_FAILED)return this.loggingService.warn(n),[2];if(u.code===y.SdkError.FCM_TOKEN_UPDATE_FAILED)return this.loggingService.warn(n),[2];if(u.code===y.SdkError.FCM_DELETE_TOKEN_FAILED)return this.loggingService.warn(n),[2];if(u.message&&/cannot read property .permission. of undefined/i.test(u.message))return this.loggingService.warn("Firebase Internals Error:"),this.loggingService.warn(n),[2];throw this.loggingService.warn({code:u.code,message:u.message,error:n}),n;case 6:return r&&r!==this.appContext.fcmToken?(i=this.appContext.fcmToken,this.loggingService.info("Token refreshed by the remote end. Migrating."),[4,this.environmentService.setFcmSubscriptionId(r)]):[3,10];case 7:return a.sent(),[4,this.environmentService.getSubscriptionEndpoint()];case 8:return o=a.sent(),[4,this.registerToken({subscription_endpoint:o,fcm_subscription_id:r,previous_token:i,domain_key:this.appContext.domainKey,amp:this.environmentService.getRuntimeEnvironmentType()===l.RuntimeEnvironmentType.AmpPermissionDialog,migrated:!0})];case 9:return a.sent(),[3,11];case 10:this.loggingService.info("Token migration not required"),a.label=11;case 11:return[3,13];case 12:return s=a.sent(),p=(u=s||{}).message&&e.test(u.message),u.code===y.SdkError.PUSH_SERVICE_NOT_AVAILABLE||p?(this.loggingService.warn(s),this.appContext.disabled=!0):this.loggingService.error(s),[3,13];case 13:return[2]}})})},RegistrationService.prototype.registerToken=function(e){return s(this,void 0,void 0,function(){var t,r,i,o,s=this;return a(this,function(a){switch(a.label){case 0:if(this.appContext.subscriptionTokenRegistered)return this.loggingService.error("Attempt to register subscription token more than once detected"),[2];t=new d.RegisterTokenOptions(e),r={action:l.EventAction.Subscribed,domain_id:this.appContext.settings.domain.id,event_date:(new Date).toISOString(),meta:n({source:{application:b.PUSHLY_SDK_APPLICATION_NAME,version:"bf1d6794b4e27ed2c53b215b2fa7aace95e4cdb7"},pushly_unique_user_id:this.appContext.uniqueUserId,page_url:window.location.toString()},t)},a.label=1;case 1:return a.trys.push([1,3,,4]),[4,f.retryFetch("https://kraken.p-n.io/allow",{headers:{"content-type":"application/json"},method:"POST",body:JSON.stringify(r)},function(){s.loggingService.warn("Retrying Allow Fetch","https://kraken.p-n.io/allow",r.action)})];case 2:return(i=a.sent()).ok?(this.appContext.subscriptionTokenRegistered=!0,e.tag&&this.registerAllowedKeywords(e.tag)):this.loggingService.error("Allow endpoint returned with status "+i.statusText),[3,4];case 3:return(o=a.sent())&&(o.context={event:r}),this.loggingService.error(o),[3,4];case 4:return[2]}})})},RegistrationService.prototype.registerAllowedKeywords=function(e){return s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return[4,this.dataStoreService.resolveFcmToken()];case 1:return t=r.sent(),[2,this.profileService.saveUserTags(t,e)]}})})},RegistrationService.prototype.requestNotificationPermissions=function(e){return void 0===e&&(e=null),s(this,void 0,void 0,function(){var t,r,n,i,o,s,p,d;return a(this,function(a){switch(a.label){case 0:a.trys.push([0,15,,16]),t=c.default.messaging(),this.eventsService.putEvent({action:l.EventAction.PermissionPrompted,meta:{prompt_id:e}}),a.label=1;case 1:return a.trys.push([1,3,,4]),u.WebEventBus.dispatch("permission_prompted"),[4,t.requestPermission()];case 2:return a.sent(),[3,4];case 3:if(!("code"in(r=a.sent())))throw r;if("messaging/permission-blocked"!==r.code&&"messaging/permission-default"!==r.code)throw r;return[3,4];case 4:if(n=window.Notification.permission,this.loggingService.info(n),"granted"!==n)return[3,13];i=void 0,o=400,s=0,a.label=5;case 5:if(!(s<4))return[3,12];a.label=6;case 6:return a.trys.push([6,8,,9]),[4,t.getToken()];case 7:return(i=a.sent())?[3,12]:[3,9];case 8:return p=a.sent(),s<3?this.loggingService.warn(p):this.loggingService.error(p),[3,9];case 9:return this.loggingService.info("Retrying fetch token"),o*=2,[4,f.delay(o)];case 10:a.sent(),a.label=11;case 11:return s++,[3,5];case 12:return i?(this.appContext.fcmToken=i,this.loggingService.info("Got token"),this.eventsService.putEvent({action:l.EventAction.PermissionAccepted,meta:{prompt_id:e}}),u.WebEventBus.dispatch("permission_accepted"),u.WebEventBus.dispatch("permission_allowed"),[2,i]):(this.loggingService.error("Failed to fetch token from FCM after permission was granted. Exiting flow."),[2]);case 13:"default"===n?(this.eventsService.putEvent({action:l.EventAction.PermissionDismissed,meta:{prompt_id:e}}),this.environmentService.setDismissed(!0),u.WebEventBus.dispatch("permission_dismissed")):"denied"===n?(this.eventsService.putEvent({action:l.EventAction.PermissionDenied,meta:{prompt_id:e}}),this.environmentService.setBlocked(!0),u.WebEventBus.dispatch("permission_denied")):this.loggingService.error("Unkown status: "+n),a.label=14;case 14:return[3,16];case 15:return d=a.sent(),this.loggingService.error(d),[3,16];case 16:return[2]}})})},RegistrationService.prototype.unsubscribe=function(){return s(this,void 0,void 0,function(){var e,t,r,n;return a(this,function(i){switch(i.label){case 0:if(!this.environmentService.isUserSubscribed())return[2];i.label=1;case 1:return i.trys.push([1,9,10,11]),[4,this.dbService.getConnection()];case 2:return[4,(e=i.sent()).set(b.PUSHLY_DB_FCM_SUBSCRIPTION_ID_KEY,null)];case 3:return i.sent(),this.cookieService.setCookie(b.PUSHLY_PROMPT_SUBSCRIBED_COOKIE,!1,-1),this.cookieService.clearCookie(b.PUSHLY_FCM_TOKEN_COOKIE),this.appContext.fcmToken=null,this.environmentService.isUsingProxyIntegration()&&!this.environmentService.urlContainsProxyUrl()?[3,7]:[4,window.navigator.serviceWorker.getRegistration()];case 4:return(t=i.sent())?[4,t.pushManager.getSubscription()]:[3,7];case 5:return(r=i.sent())?(this.loggingService.info("Processing browser unsubscribe request"),[4,r.unsubscribe()]):[3,7];case 6:i.sent(),i.label=7;case 7:return[4,this.eventsService.putEvent({action:l.EventAction.Unsubscribed})];case 8:return i.sent(),this.loggingService.info("Unsubscribed from notifications"),u.WebEventBus.dispatch("unsubscribed"),[3,11];case 9:return n=i.sent(),this.loggingService.warn("An error was encountered during the unsubscribe process"),this.loggingService.error(n),[3,11];case 10:return e&&e.close(),[7];case 11:return[2]}})})},RegistrationService=i([p.inject(),o("design:paramtypes",[d.AppContext,_.LoggingService,h.EventsService,v.CookieService,m.EnvironmentService,g.DbService,w.DataStoreService,S.ProfileService])],RegistrationService)}();t.RegistrationService=E},"./src/sdk/services/session.service.ts":function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},i=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0});var s=r("./src/sdk/decorators/index.ts"),a=r("./src/sdk/services/logging.service.ts"),c=r("./src/sdk/utils/hash.ts"),u=function(){function SessionService(e){this.loggingService=e}var e;return e=SessionService,Object.defineProperty(SessionService.prototype,"current",{get:function(){var t={sessionStart:Date.now(),pageViews:[]},r=window.sessionStorage,i=r.getItem(e.SESSION_KEY);if(i)try{i=JSON.parse(i)}catch(o){this.loggingService.warn("Corrupt session encountered. Resetting current session."),i=n({},t),r.setItem(e.SESSION_KEY,JSON.stringify(i))}else i=n({},t),r.setItem(e.SESSION_KEY,JSON.stringify(i));return i.sessionStart||(this.loggingService.warn("Corrupt session encountered. Resetting current session."),i=n({},t),r.setItem(e.SESSION_KEY,JSON.stringify(i))),i},enumerable:!0,configurable:!0}),SessionService.prototype.set=function(t,r){var n=this.current;return n[t]=r,this.store.setItem(e.SESSION_KEY,JSON.stringify(n)),this},SessionService.prototype.get=function(e){return this.current[e]},SessionService.prototype.addPageView=function(e){var t=c.hashFromString(e),r=this.current.pageViews||[];try{var n=0===r.length,i=!n&&r[r.length-1]!==t;if(n||i){var o=r.concat([t]);this.set("pageViews",o),this.loggingService.info("Session Page Views: "+o.length)}}catch(e){this.loggingService.warn("Could not update session page views"),this.loggingService.warn(e)}return this},SessionService.prototype.getCurrentTotalPageViews=function(){return(this.current.pageViews||[]).length},Object.defineProperty(SessionService.prototype,"store",{get:function(){return window.sessionStorage},enumerable:!0,configurable:!0}),SessionService.SESSION_KEY="pushly-session",SessionService=e=i([s.inject(),o("design:paramtypes",[a.LoggingService])],SessionService)}();t.SessionService=u},"./src/sdk/services/settings.service.ts":function(e,t,r){"use strict";var n=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var a=r("./src/sdk/decorators/index.ts"),c=r("./src/sdk/services/logging.service.ts"),u=r("./src/sdk/utils/index.ts"),l=function(){function SettingsService(e){this.loggingService=e}return SettingsService.prototype.getSettings=function(e){return o(this,void 0,void 0,function(){var t,r,n,i,o=this;return s(this,function(s){switch(s.label){case 0:t=null,s.label=1;case 1:return s.trys.push([1,6,,7]),r={"content-type":"application/json"},n="https://kraken.p-n.io/settings/"+e,[4,u.retryFetch(n,{method:"GET",headers:r},function(){o.loggingService.warn("Retrying Settings Fetch",n)})];case 2:return(t=s.sent()).ok?[4,t.json()]:[3,4];case 3:return[2,s.sent()];case 4:this.loggingService.error("Settings endpoint returned with status "+t.statusText),s.label=5;case 5:return[3,7];case 6:return i=s.sent(),this.loggingService.error(i+" "+t),[3,7];case 7:return[2]}})})},SettingsService=n([a.inject(),i("design:paramtypes",[c.LoggingService])],SettingsService)}();t.SettingsService=l},"./src/sdk/services/web-service-worker-service.ts":function(e,t,r){"use strict";var n=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var a=r("./node_modules/@firebase/app/dist/index.cjs.js");r("./node_modules/@firebase/messaging/dist/index.esm.js");var c=r("./src/sdk/decorators/index.ts"),u=r("./src/sdk/services/logging.service.ts"),l=r("./src/sdk/models/index.ts"),p=r("./src/sdk/services/db.service.ts"),d=r("./src/sdk/constants.ts"),f=r("./src/sdk/enums/sdk-error.enum.ts"),h=r("./src/sdk/services/environment.service.ts"),v=r("./src/sdk/index.ts"),_=function(){function WebServiceWorkerService(e,t,r,n,i){this.loggingService=e,this.appContext=t,this.dbService=r,this.environmentService=n,this.eventsService=i}return WebServiceWorkerService.prototype.registerServiceWorker=function(e){return o(this,void 0,void 0,function(){var t,r,n,i,c,u,l,p,h,_,g,m,b,y,S,w,E,k,P,O,C,T=this;return s(this,function(I){switch(I.label){case 0:if(I.trys.push([0,17,,18]),this.loggingService.info("Initializing FCM"),this.appContext.firebaseAppInitialized)this.loggingService.warn("FCM is already initialized");else try{a.default.initializeApp({messagingSenderId:this.appContext.settings.domain.sender_id}),this.appContext.firebaseAppInitialized=!0}catch(e){if(e.code!==f.SdkError.FIREBASE_DUPLICATE_APP)throw e;this.loggingService.warn("FCM is already initialized")}I.label=1;case 1:return I.trys.push([1,3,,4]),[4,navigator.serviceWorker.getRegistrations()];case 2:for(t=I.sent(),r=0,n=t;r<n.length;r++)(i=n[r]).scope!==location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/"&&(this.loggingService.info("Unregistering service worker with scope: "+i.scope),i.unregister());return[3,4];case 3:return c=I.sent(),this.loggingService.warn("Exception during unregistering service worker "+c.toString()),[3,4];case 4:return this.loggingService.info("Registering Service Worker"),[4,this.dbService.getConnection()];case 5:return u=I.sent(),l=e.sw||"/pushly-sdk-worker.js",[4,u.get("worker_version")];case 6:return(p=I.sent())===this.appContext.version?[3,11]:(this.loggingService.info("Application Version Changed. Hot-swapping service worker."),[4,this.loadServiceWorkerDependencyScript(u,p)]);case 7:return I.sent(),h=new Promise(function(e){navigator.serviceWorker.oncontrollerchange=e,setTimeout(function(){navigator.serviceWorker.oncontrollerchange=function(){},e()},3e3)}),[4,navigator.serviceWorker.register(l+"?v="+this.appContext.version,{updateViaCache:"imports",scope:"/"})];case 8:return I.sent(),this.loggingService.info("Awaiting Controller Change."),[4,h];case 9:return I.sent(),this.loggingService.info("Controller Successfully Changed."),this.loggingService.info("Updating Application Version"),[4,u.set(d.PUSHLY_DB_APPLIATION_VERSION,this.appContext.version)];case 10:I.sent(),I.label=11;case 11:return u.close(),[4,navigator.serviceWorker.register(l,{updateViaCache:"imports",scope:"/"})];case 12:_=I.sent(),this.loggingService.info("Updating Service Worker Registration"),I.label=13;case 13:return I.trys.push([13,15,,16]),[4,_.update()];case 14:return I.sent(),this.loggingService.info("Service Worker Updated Successful"),[3,16];case 15:return I.sent(),this.loggingService.info("Service Worker Updated Failed"),[3,16];case 16:return this.loggingService.info("Setting Service Worker to Use"),(g=a.default.messaging()).onTokenRefresh(function(){g.getToken().then(function(e){return o(T,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return this.loggingService.info("FCM Messaging: Token refreshed",e),[4,this.eventsService.putEvent({action:v.EventAction.TokenRefresh,meta:{refreshedToken:e}})];case 1:return t.sent(),[2]}})})}).catch(function(e){T.loggingService.error("Unable to retrieve refreshed token ",e)})}),g.useServiceWorker(_),this.loggingService.info("Registered Service Worker"),[2,!0];case 17:return m=I.sent(),y=(b=m||{}).name&&"SECURITYERROR"===String(b.name).toUpperCase(),S=/HTTP response code .4[\d]{2}. was received/i,w=b.message&&S.test(b.message),E=/(invalid|Ungltiges|Nieprawidowy|Ongeldig) argument| ||/i,k=b.message&&E.test(b.message),P=/ edge\//i.test(navigator.userAgent),O=/An unknown error occurred/i.test(b.message),C=/ServiceWorker script evaluation failed/i.test(b.message),(O||C)&&this.loggingService.warn({type:O?"UNKNOWN_ERROR":"SCRIPT_EVAL_ERROR",code:b.code,message:b.message,error:m}),w||y||P&&k?this.loggingService.warn(m):this.loggingService.error(m),this.appContext.disabled=!0,[2,!1];case 18:return[2]}})})},WebServiceWorkerService.prototype.loadServiceWorkerDependencyScript=function(e,t){return o(this,void 0,void 0,function(){var r,n,i,o,a=this;return s(this,function(s){switch(s.label){case 0:r=!1,s.label=1;case 1:return s.trys.push([1,6,,7]),e?[3,3]:[4,this.dbService.getConnection()];case 2:e=s.sent(),r=!0,s.label=3;case 3:return(n=t)?[3,5]:[4,e.get(d.PUSHLY_DB_APPLIATION_VERSION)];case 4:n=s.sent(),s.label=5;case 5:return t=n,[3,7];case 6:return s.sent(),[3,7];case 7:return t!==this.appContext.version&&document&&document.body&&((i=document.createElement("script")).onload=function(){a.loggingService.info("ServiceWorker dependency script loaded")},i.async=!0,i.src="https://cdn.p-n.io/pushly-sw.min.js",(o=document.getElementsByTagName("script")[0]).parentNode.insertBefore(i,o)),t?[3,9]:[4,e.set(d.PUSHLY_DB_APPLIATION_VERSION,this.appContext.version)];case 8:s.sent(),s.label=9;case 9:return r&&e.close(),[2]}})})},WebServiceWorkerService=n([c.inject(),i("design:paramtypes",[u.LoggingService,l.AppContext,p.DbService,h.EnvironmentService,v.EventsService])],WebServiceWorkerService)}();t.WebServiceWorkerService=_},"./src/sdk/utils/delay.ts":function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};function delay(e){return void 0===e&&(e=0),n(this,void 0,void 0,function(){return i(this,function(t){return[2,new Promise(function(t,r){setTimeout(function(){return t()},e)})]})})}Object.defineProperty(t,"__esModule",{value:!0}),t.delay=delay,t.delayRandom=function delayRandom(e){return void 0===e&&(e=0),n(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return void 0!==e&&e>0&&(e=Math.round(Math.random()*e)),[4,delay(e)];case 1:return t.sent(),[2,e]}})})}},"./src/sdk/utils/hash.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hashFromString=function(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return t>>>0}},"./src/sdk/utils/index.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/utils/delay.ts");t.delay=n.delay;var i=r("./src/sdk/utils/random-string.ts");t.randomString=i.randomString;var o=r("./src/sdk/utils/parse-query-string.ts");t.parseQueryString=o.parseQueryString;var s=r("./src/sdk/utils/retry-fetch.ts");t.retryFetch=s.retryFetch;var a=r("./src/sdk/utils/when-all.ts");t.whenAll=a.whenAll},"./src/sdk/utils/parse-query-string.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseQueryString=function parseQueryString(e){for(var t={},r=0,n=e.split("?").pop().split("&");r<n.length;r++){var i=n[r].split("=");i[0]&&(t[i[0]]=i[1])}return t}},"./src/sdk/utils/random-string.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomString=function randomString(e){void 0===e&&(e=16);for(var t="abcdefghijklmnopqrstuvwxyz0987654321",r="",n=0;n<e;n++)r+=t[Math.floor(Math.random()*t.length)];return r}},"./src/sdk/utils/retry-fetch.ts":function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var o=r("./src/sdk/utils/delay.ts");t.retryFetch=function retryFetch(e,t,r,s,a){return void 0===s&&(s=4),void 0===a&&(a=800),n(this,void 0,void 0,function(){var c,u,l,p=this;return i(this,function(d){switch(d.label){case 0:c=null,u=function(c){return n(p,void 0,void 0,function(){var n;return i(this,function(i){switch(i.label){case 0:if((n=s-1)<=0)throw c instanceof Error?c:new Error(c);return[4,o.delay(a)];case 1:return i.sent(),r&&r(s-n),[2,retryFetch(e,t,r,n,2*a)]}})})},d.label=1;case 1:return d.trys.push([1,3,,4]),[4,fetch(e,t)];case 2:return(c=d.sent()).ok?[2,c]:[2,u("Retry fetch failed on url: "+e+". response object: "+JSON.stringify(c))];case 3:return l=d.sent(),[2,u(l)];case 4:return[2]}})})}},"./src/sdk/utils/try-parse.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tryParseInt=function(e,t){var r=t;if(!isNaN(e))try{r=parseInt(String(e),10)}catch(e){}return isNaN(r)?t:r}},"./src/sdk/utils/when-all.ts":function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n.throw(e))}catch(e){o(e)}}function step(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(o){return function(a){return function step(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.whenAll=function whenAll(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,Promise.all(e)];case 1:return[2,t.sent()]}})})}},"./src/sdk/web-event-bus.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("./src/sdk/event-manager.ts");t.WebEventBus=new n.EventManager},"./src/styles/app.scss":function(e,t,r){},"./src/web.ts":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r("./src/styles/app.scss");var n=r("./src/container.ts"),i=r("./src/sdk/pushly-sdk.ts"),o=r("./src/sdk/services/index.ts"),s=r("./src/sdk/components/index.ts"),a=r("./src/sdk/models/index.ts"),c=r("./src/sdk/sdk-flows/frame-helper.flow.ts"),u=r("./src/sdk/sdk-flows/web.flow.ts"),l=r("./src/sdk/sdk-flows/permission-dialog.flow.ts"),p=r("./src/sdk/sdk-flows/prompt.flow.ts"),d=r("./src/sdk/services/web-service-worker-service.ts"),f=r("./src/sdk/sdk-flows/proxy-dialog.flow.ts"),h=r("./src/sdk/sdk-flows/proxy-frame-helper.flow.ts"),v=new n.Container;v.transient(i.PushlySDK),v.transient(o.EnvironmentService),v.transient(o.RegistrationService),v.transient(o.SettingsService),v.transient(o.EventsService),v.transient(o.CookieService),v.transient(o.ProfileService),v.transient(o.CryptoService),v.transient(o.DbService),v.transient(o.SessionService),v.transient(d.WebServiceWorkerService),v.transient(o.DataStoreService),v.transient(u.WebFlow),v.transient(p.PromptFlow),v.transient(c.FrameHelperFlow),v.transient(l.PermissionDialogFlow),v.transient(f.ProxyDialogFlow),v.transient(h.ProxyFrameHelperFlow),v.transient(s.NativePromptComponent),v.transient(s.CustomPromptComponent),v.transient(s.SlidePromptComponent),v.transient(s.BellComponent),v.singleton(a.AppContext,new a.AppContext),v.singleton(o.LoggingService,new o.LoggingService(v.get(a.AppContext))),v.singleton(o.AmpMessageBroker,new o.AmpMessageBroker(v.get(o.LoggingService)));var _=v.get(i.PushlySDK);if("PushlySDK"in window&&window.PushlySDK instanceof Array)for(var g=0,m=window.PushlySDK;g<m.length;g++){var b=m[g];_.push(b)}window.PushlySDK=_}});
//# sourceMappingURL=pushly-sdk.min.js.map